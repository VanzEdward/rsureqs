<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RSU REQS - Dashboard</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="/assets/css/dashboard.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <style>
      /* Enhanced styles for better UX */
      .service-card {
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative; /* This is required for the counter */
      }

      /* This is the new counter badge style */
      .service-counter {
        position: absolute;
        top: 12px;
        right: 12px;
        background-color: #6c757d; /* Bootstrap 'secondary' gray */
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        line-height: 1;
        z-index: 2; /* Sits on top of the card content */
      }

      .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .service-card.selected {
        border: 2px solid #007bff;
        background-color: #f8f9fa;
      }

      .queue-status-badge {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 12px;
      }

      .status-approved {
        background: #28a745;
        color: white;
      }

      .status-pending {
        background: #ffc107;
        color: black;
      }

      .status-declined {
        background: #dc3545;
        color: white;
      }

      .status-processing {
        background: #17a2b8;
        color: white;
      }

      .status-completed {
        background: #6f42c1;
        color: white;
      }

      .real-time-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .queue-number-display {
        /* center the content */
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
      }

      .queue-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
      }

      .profile-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .nav-item .notification-dot {
    position: absolute;
    top: 10px; /* Adjust as needed */
    right: 10px; /* Adjust as needed */
    width: 10px;
    height: 10px;
    background-color: #0d6efd; /* Bootstrap 'primary' blue */
    border-radius: 50%;
    border: 2px solid #fff; /* Makes it look clean on the green bg */
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
  /* --- Notification Toast Styles --- */
      .notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        animation: slideInRight 0.3s ease-out forwards;
        border-left: 5px solid;
        font-family: "Poppins", sans-serif;
      }

      .toast-info {
        border-left-color: #0d6efd; /* Blue for info */
      }

      .toast-success {
        border-left-color: #198754; /* Green for success */
      }

      .toast-error {
        border-left-color: #dc3545; /* Red for error */
      }

      .toast-icon {
        margin-right: 15px;
        font-size: 1.2rem;
      }

      .toast-info .toast-icon { color: #0d6efd; }
      .toast-success .toast-icon { color: #198754; }
      .toast-error .toast-icon { color: #dc3545; }
/* --- COOL DASHBOARD MENU CARDS (Mobile Safe) --- */
      .dashboard-menu-card {
        background: #ffffff;
        border: none;
        border-radius: 25px;
        padding: 2.5rem 1.5rem;
        height: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-align: center;
        position: relative;
        overflow: hidden;
        z-index: 1;
        cursor: pointer;
        /* Mobile: Add subtle border */
        border: 1px solid rgba(0,0,0,0.05);
      }

      /* Decorative background circle (Static on mobile) */
      .dashboard-menu-card::after {
        content: '';
        position: absolute;
        top: -60px;
        right: -60px;
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: var(--card-theme);
        opacity: 0.08;
        z-index: -1;
        transition: transform 0.5s ease;
      }

      /* Remove old top border line */
      .dashboard-menu-card::before {
        display: none;
      }

      .card-icon-wrapper {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        font-size: 3rem;
        background: var(--card-theme-light);
        color: var(--card-theme);
        transition: transform 0.5s ease;
      }

      /* Typography & Buttons (Same as before) */
      .menu-title {
        font-size: 1.6rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: #2d3748;
        letter-spacing: -0.5px;
      }

      .menu-desc {
        color: #718096;
        font-size: 0.95rem;
        margin-bottom: 2rem;
        line-height: 1.6;
      }

      .btn-menu-action {
        background: var(--card-theme);
        color: white;
        border: none;
        padding: 12px 35px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px var(--card-shadow);
      }

      /* --- ðŸŸ¢ MOUSE-ONLY ANIMATIONS ðŸŸ¢ --- */
      /* These effects will NOT run on phones */
      @media (hover: hover) {
        
        .dashboard-menu-card:hover {
          transform: translateY(-15px);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
          border-color: transparent;
        }

        .dashboard-menu-card:hover::after {
          transform: scale(1.4);
        }

        .dashboard-menu-card:hover .card-icon-wrapper {
          transform: rotateY(180deg);
        }

        .btn-menu-action:hover {
          transform: scale(1.05);
          color: white;
          filter: brightness(1.1);
        }
      }

      /* --- Card Themes (Keep these) --- */
      .card-profile {
        --card-theme: #6f42c1;
        --card-theme-light: rgba(111, 66, 193, 0.1);
        --card-shadow: rgba(111, 66, 193, 0.4);
      }
      .card-services {
        --card-theme: #198754; 
        --card-theme-light: rgba(25, 135, 84, 0.1);
        --card-shadow: rgba(25, 135, 84, 0.4);
      }
      .card-about {
        --card-theme: #ffc107;
        --card-theme-light: rgba(255, 193, 7, 0.15);
        --card-shadow: rgba(255, 193, 7, 0.4);
      }
      .card-about .btn-menu-action { color: #000; font-weight: 800; }
      .card-about .btn-menu-action:hover { color: #000; }
      /* --- COOL SERVICES CATEGORY CARDS --- */
      .service-category-card {
        background: #ffffff;
        border: none;
        border-radius: 25px;
        padding: 3rem 2rem;
        height: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-align: center;
        position: relative;
        overflow: hidden;
        z-index: 1;
        cursor: pointer;
        /* Mobile: Add a subtle border so cards are defined without shadow */
        border: 1px solid rgba(0,0,0,0.05); 
      }

      /* Decorative Circle Effect */
      .service-category-card::after {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: var(--service-theme);
        opacity: 0.08;
        z-index: -1;
        transition: transform 0.5s ease;
      }

      /* Icon Styling */
      .service-category-card i {
        display: inline-block;
        font-size: 4rem !important;
        margin-bottom: 1.5rem;
        transition: transform 0.5s ease;
      }

      /* Typography */
      .service-category-card h4 {
        font-size: 1.5rem;
        font-weight: 800;
        color: #2d3748;
        margin-bottom: 1rem;
      }

      .service-category-card p {
        color: #718096;
        font-size: 0.95rem;
        line-height: 1.6;
      }

      /* Button Styling */
      .service-category-card .btn {
        border-radius: 50px;
        padding: 10px 30px;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 1.5rem;
        transition: all 0.3s ease;
      }

      /* --- ðŸŸ¢ MOUSE-ONLY ANIMATIONS ðŸŸ¢ --- */
      /* These rules will ONLY apply if the user has a mouse (Desktop/Laptop) */
      @media (hover: hover) {
        
        .service-category-card:hover {
          transform: translateY(-15px);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
          border-color: transparent; /* Remove border on hover */
        }

        .service-category-card:hover::after {
          transform: scale(1.5);
        }

        .service-category-card:hover i {
          transform: rotateY(180deg) scale(1.1);
        }
      }

      /* --- Assign Colors via nth-child (Automatic Coloring) --- */
      
      /* Card 1: Academic (Blue) */
      .col-md-4:nth-child(1) .service-category-card {
        --service-theme: #0d6efd;
      }
      
      /* Card 2: Certifications (Green) */
      .col-md-4:nth-child(2) .service-category-card {
        --service-theme: #198754;
      }

      /* Card 3: Graduation (Yellow/Gold) */
      .col-md-4:nth-child(3) .service-category-card {
        --service-theme: #ffc107;
      }
      /* --- FLOATING "VIEW SELECTED" BUTTON (Mobile Only) --- */
      /* By default (Desktop), keep it where it is */
      .view-selected-container {
        margin-top: 3rem;
        text-align: center;
      }

      /* On Mobile (Screen width < 768px) */
      @media (max-width: 768px) {
        .view-selected-container {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          width: 90%;
          max-width: 400px;
          z-index: 1050; /* Above everything */
          margin-top: 0;
          
          /* Add a subtle animation when it appears */
          animation: slideUp 0.3s ease-out;
        }

        .view-selected-container .btn {
          width: 100%;
          box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          border-radius: 50px;
          padding: 12px 20px;
          font-size: 1rem;
          display: flex;
          justify-content: center;
          align-items: center;
          background: #0d6efd; /* Consistent Blue */
          border: none;
        }

        /* Hide button if nothing is selected (Optional enhancement) */
        /* You can toggle a class 'show-fab' via JS if you want it to hide when empty */
      }

      @keyframes slideUp {
        from { transform: translate(-50%, 100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
      }
      /* --- FIX FOR HAMBURGER MENU --- */
      .navbar-toggler {
        background-color: transparent !important; /* Force remove white background */
        border: none !important;                  /* Remove border */
        box-shadow: none !important;              /* Remove focus glow */
        padding: 0 !important;                    /* Remove padding */
      }

      /* Ensure it stays transparent when clicked/focused */
      .navbar-toggler:focus, .navbar-toggler:active {
        background-color: transparent !important;
        box-shadow: none !important;
        outline: none !important;
      }

      /* Ensure the icon image (the lines) is visible */
      .navbar-toggler-icon {
        width: 1.5em; 
        height: 1.5em;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
      }
      /* --- FIX HAMBURGER MENU --- */
      .navbar-toggler {
        border: none !important;                  /* No border */
        outline: none !important;                 /* No outline */
        box-shadow: none !important;              /* No glow on click */
        background-color: transparent !important; /* No background color */
        padding: 0 !important;                    /* No padding */
      }

      /* Ensure the icon lines are white */
      .navbar-toggler-icon {
        width: 1.5em; 
        height: 1.5em;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
      }
      
    </style>
  </head>

  <body>
    <!-- for serviceCConfirmationModal - make it have a button to if user wants to add the service or not, so basically the modal just shows the more info about that service-->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold" id="categoryModalTitle">Select Document</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body bg-light">
        <div class="alert alert-info small">
          <i class="bi bi-info-circle me-1"></i> 
          Click on a document name below to expand details, view fees, and add an optional note.
        </div>
        
        <div id="categoryItemsContainer" class="accordion">
          </div>
      </div>
    </div>
  </div>
</div>
    <div
      class="modal fade"
      id="serviceConfirmationModal"
      tabindex="-1"
      aria-labelledby="serviceConfirmationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="serviceConfirmationModalLabel">
              <i class="bi bi-info-circle me-2 text-primary"></i> Service
              Information
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p id="serviceDescription">Service description goes here...</p>
            <p><strong>Fee:</strong> <span id="serviceFee">â‚±0.00</span></p>
            <h6 class="fw-bold">Requirements:</h6>
            <ul id="serviceRequirements">
              <li>Requirement 1</li>
              <li>Requirement 2</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="confirmAddServiceBtn"
            >
              Add Service
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Selected Services Modal -->
    <div
  class="modal fade"
  id="selectedModal"
  tabindex="-1"
  aria-labelledby="selectedModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="selectedModalLabel">
          <i class="bi bi-pencil-square me-2 text-primary"></i> Selected
          Services
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="fw-bold mb-2">Services</h6>
            <ul
              id="selectedServicesList"
              class="list-group list-group-flush"
            ></ul>
          </div>

          <div class="col-md-6">
            <h6 class="fw-bold mb-2">Check List of Requirements</h6>
            <div id="requirementsList"></div>
          </div>
        </div>
        
        <div class="alert alert-info mt-3 small">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Reminder:</strong> Please frequently visit the <u>Updates</u> page to check your request progress.
        </div>

        <div class="mt-2 p-3 bg-light border rounded d-flex justify-content-center align-items-center">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="confirmRequirementsCheck" onchange="checkAllFilesUploaded()" style="cursor: pointer;">
                <label class="form-check-label fw-bold small user-select-none" for="confirmRequirementsCheck" style="cursor: pointer;">
                    I certify that the attached requirements are correct and complete.
                </label>
            </div>
        </div>
      </div>

      <div class="modal-footer flex-column">
        <div class="w-100 d-flex justify-content-between">
          <span class="fw-bold"
            >Total amount: <span id="totalAmount">â‚±0.00</span></span
          >
        </div>
        <button id="joinQueueBtn" class="btn btn-success w-100 mt-2" disabled>
          Send Request Now
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ðŸŸ¢ OPTIMIZED PROFILE MODAL (Dynamic Dropdowns) ðŸŸ¢ -->
    <div
      class="modal fade"
      id="profileUpdateModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="profileUpdateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-bold" id="profileUpdateModalLabel">
              <i class="bi bi-person-lines-fill me-2"></i> Update Student Profile
            </h5>
            <!-- Close button hidden by default logic if profile incomplete -->
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body bg-light">
            <div class="alert alert-warning border-start border-4 border-warning shadow-sm">
              <div class="d-flex">
                <i class="bi bi-exclamation-circle-fill me-3 fs-4"></i>
                <div>
                  <strong>Action Required:</strong> Please fill out all fields marked with <span class="text-danger">*</span> to access services.
                </div>
              </div>
            </div>

            <form id="profileUpdateForm">
              
              <!-- 1. PERSONAL INFORMATION -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white fw-bold text-primary">
                  <i class="bi bi-person me-2"></i> Personal Information
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">Last Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">First Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">Middle Name <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="middleName" required placeholder="Type N/A if none">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">Gender <span class="text-danger">*</span></label>
                      <select class="form-select" id="gender" required>
                        <option value="" selected disabled>Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">Date of Birth <span class="text-danger">*</span></label>
                      <input type="date" class="form-control" id="dob" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">Nationality <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="nationality" value="Filipino" required>
                    </div>
                    <div class="col-12">
                      <label class="form-label small fw-bold">Place of Birth <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="pob" placeholder="City/Municipality, Province" required>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 2. ACADEMIC INFORMATION -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white fw-bold text-primary">
                  <i class="bi bi-mortarboard me-2"></i> Academic Information
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">Student ID <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="studentId" placeholder="000-0000-000000" required>
                    </div>
                                        <div class="col-md-12">
                      <label class="form-label small fw-bold">Program / Course <span class="text-danger">*</span></label>
                      <select class="form-select" id="program" required disabled onchange="populateMajors()">
                        <option value="" selected disabled>Select College first...</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">College / Department <span class="text-danger">*</span></label>
                      <select class="form-select" id="campus" required onchange="populatePrograms()">
                        <option value="" selected disabled>Select College...</option>
                        <!-- Populated by JS -->
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label small fw-bold">Major <span class="text-danger">*</span></label>
                      <select class="form-select" id="major" required disabled>
                        <option value="N/A" selected>N/A</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">Year Level <span class="text-danger">*</span></label>
                      <select class="form-select" id="yearLevel" required>
                        <option value="" selected disabled>Select...</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                        <option value="5th Year">5th Year</option>
                        <option value="Graduate">Graduate</option>
                        <option value="Alumni">Alumni</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">School Year <span class="text-danger">*</span></label>
                      <select class="form-select" id="schoolYear" required>
                        <option value="2023-2024">2023-2024</option>
                        <option value="2024-2025" selected>2024-2025</option>
                        <option value="2025-2026">2025-2026</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">Year Graduated (If Alumni)</label>
                      <input type="number" class="form-control" id="yearGraduated" placeholder="YYYY (Optional)">
                    </div>

                    <!-- ID Picture Upload -->
                    <div class="col-md-8">
                      <label class="form-label small fw-bold">School ID / Valid ID (Photo) <span class="text-danger">*</span></label>
                      <input type="file" class="form-control" id="schoolIdPicture" accept="image/*">
                      <div class="form-text small">Please upload a clear photo of your ID.</div>
                    </div>
                    <div class="col-md-4 text-center">
                       <div id="schoolIdPicturePreview" class="border rounded p-1 d-none" style="height: 100px; width: 100%; overflow: hidden;">
                          <img src="" style="width: 100%; height: 100%; object-fit: contain;">
                       </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 3. ADDRESS & EDUCATION -->
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white fw-bold text-primary">
                  <i class="bi bi-geo-alt me-2"></i> Address & Background
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-12">
                      <label class="form-label small fw-bold">Permanent Home Address <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="home_address" required placeholder="House No., Street, Brgy, Town/City, Province">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">Primary School (Elementary) <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="primary_school" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small fw-bold">Secondary School (High School) <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="secondary_school" required>
                    </div>
                    <div class="col-12">
                      <label class="form-label small fw-bold">Last School Attended (If Transferee)</label>
                      <input type="text" class="form-control" id="previous_school" placeholder="Optional">
                    </div>
                  </div>
                </div>
              </div>

              <!-- 4. CONTACT -->
              <div class="card border-0 shadow-sm mb-3">
                 <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" readonly style="background-color: #e9ecef;">
                        </div>
                        <div class="col-md-6">
                             <label class="form-label small fw-bold">Phone Number <span class="text-danger">*</span></label>
                             <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </div>
                 </div>
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary px-4 fw-bold" id="saveProfileBtn">
              <i class="bi bi-save me-1"></i> Save Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    
<div id="feedbackModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title"><i class="bi bi-star-fill me-2"></i> Client Satisfaction Measurement</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="feedbackRequestId">
            
            <div class="alert alert-light border small text-muted mb-4">
              <strong>INSTRUCTIONS:</strong> Check the box your answer to the <strong>Citizen's Charter (CC)</strong> questions. The Citizen's Charter is an official document that reflects the services of a government agency/office including its requirements, fees, and processing times among others.
            </div>

            <h6 class="fw-bold text-success mb-3">Citizen's Charter (CC)</h6>
            
            <div class="mb-3 p-3 border rounded bg-light">
                <p class="fw-bold mb-2 small text-danger">* CC1. Which of the following best describes your awareness of a CC?</p>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc1" id="cc1_1" value="1">
                    <label class="form-check-label" for="cc1_1">1. I know what a CC is and I saw this office's CC</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc1" id="cc1_2" value="2">
                    <label class="form-check-label" for="cc1_2">2. I know what a CC is but I did NOT see this office's CC</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc1" id="cc1_3" value="3">
                    <label class="form-check-label" for="cc1_3">3. I learned of the CC only when I saw this office's CC</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc1" id="cc1_4" value="4">
                    <label class="form-check-label" for="cc1_4">4. I do not know what a CC is and did not see one in this office. (Answer 'N/A' on CC2 and CC3)</label>
                </div>
            </div>

            <div class="mb-3 p-3 border rounded bg-light">
                <p class="fw-bold mb-2 small text-danger">* CC2. If aware of CC (answered in any codes from 1-3 in CC1), would you say that the CC of this office was ...?</p>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc2" id="cc2_1" value="1">
                    <label class="form-check-label" for="cc2_1">1. Easy to see</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc2" id="cc2_2" value="2">
                    <label class="form-check-label" for="cc2_2">2. Somewhat easy to see</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc2" id="cc2_3" value="3">
                    <label class="form-check-label" for="cc2_3">3. Difficult to see</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc2" id="cc2_4" value="4">
                    <label class="form-check-label" for="cc2_4">4. Not visible at all</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc2" id="cc2_5" value="0">
                    <label class="form-check-label" for="cc2_5">5. N/A</label>
                </div>
            </div>

            <div class="mb-4 p-3 border rounded bg-light">
                <p class="fw-bold mb-2 small text-danger">* CC3. If aware of CC (answered codes 1-3 in CC1), how much did the CC help you in your transaction?</p>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc3" id="cc3_1" value="1">
                    <label class="form-check-label" for="cc3_1">1. Helped very much</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc3" id="cc3_2" value="2">
                    <label class="form-check-label" for="cc3_2">2. Somewhat helped</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc3" id="cc3_3" value="3">
                    <label class="form-check-label" for="cc3_3">3. Did not help</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input cc-radio" type="radio" name="cc3" id="cc3_4" value="0">
                    <label class="form-check-label" for="cc3_4">4. N/A</label>
                </div>
            </div>

            <hr>

            <h6 class="fw-bold text-success mb-3">Service Quality Dimensions</h6>
            <p class="small text-muted">
                For SQD 0-8, please select the option that best corresponds to your answer.
            </p>

            <div id="sqdQuestions" class="mb-4">
              </div>

            <hr>
            <div class="mb-3">
              <label class="form-label fw-bold text-danger">* Do you have any COMPLAINTS? / Suggestions?</label>
              <textarea class="form-control" id="feedbackComments" rows="3" placeholder="How do you describe your overall experience..."></textarea>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" onclick="submitFeedback()">Submit Feedback</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="d-flex flex-grow-1 justify-content-center align-items-center margin-auto"
    >
      <div class="card-custom">
<nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm fixed-top">
          <div class="container-fluid px-3">
            
            <div class="d-flex align-items-center me-auto">
              <button
                class="navbar-toggler d-lg-none me-3"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
                aria-controls="navbarNav"
                aria-expanded="false"
                aria-label="Toggle navigation"
              >
                <span class="navbar-toggler-icon"></span>
              </button>

              <a class="navbar-brand d-flex align-items-center me-0" href="#">
                <img
                  src="../assets/img/updated_RegistrarLogo.jpg"
                  alt="Logo"
                  width="35"
                  height="35"
                  class="me-2 rounded-circle border border-white"
                />
                <span class="fw-bold text-white small text-uppercase" style="letter-spacing: 0.5px; font-size: 0.85rem;">
                  Registrar Services Portal
                </span>
              </a>
            </div>

            <button 
              class="btn btn-link text-white d-lg-none ms-3 p-0 text-decoration-none" 
              onclick="logout(this)"
              title="Logout"
              style="font-size: 1.5rem;"
            >
              <i class="bi bi-box-arrow-right"></i>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
              <ul class="navbar-nav mt-3 mt-lg-0 align-items-lg-center">
                <li class="nav-item">
                  <a class="nav-link active" href="#" data-target="home" onclick="showSection('home')">
                    <i class="bi bi-house-door me-2"></i> Home
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-target="services" onclick="showSection('services')">
                    <i class="bi bi-list-check me-2"></i> Services
                  </a>
                </li>
                <!-- <li class="nav-item">
                  <a class="nav-link" href="#" data-target="docs" onclick="showSection('docs')">
                    <i class="bi bi-file-earmark-pdf me-2"></i> Docs
                  </a>
                </li> -->
                <li class="nav-item position-relative">
                  <a class="nav-link" href="#" data-target="updates" onclick="showSection('updates')">
                    <i class="bi bi-megaphone me-2"></i> Updates
                  </a>
                  <span class="notification-dot" id="updates-notification-dot" style="display: none; top: 12px; right: auto; margin-left: 5px; position: relative;"></span>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-target="profile" onclick="showSection('profile')">
                    <i class="bi bi-person-circle me-2"></i> Profile
                  </a>
                </li>

                <li class="nav-item ms-lg-3 d-none d-lg-block">
                  <button 
                    class="btn btn-outline-light btn-sm w-100 d-flex align-items-center justify-content-center" 
                    onclick="logout(this)"
                    style="border-radius: 20px; padding: 5px 15px;"
                  >
                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                  </button>
                </li>

              </ul>
            </div>
          </div>
        </nav>
        <div style="padding-top: 70px;"></div>
        <!-- Home Section -->
<div id="home" class="section active">
          <div class="home-content">
            <div
              id="queueNumberDisplay"
              class="queue-number-display"
              style="display: none"
            >
              <h4>Your Current Queue Number</h4>
              <div class="queue-number" id="currentQueueNumber">A-001</div>
              <p id="queueStatusMessage">Waiting for approval</p>
            </div>

            <div class="text-center mb-5">
              <h2 class="fw-bold">Welcome to Registrar's Office</h2>
              <p class="text-muted">What would you like to do today?</p>
            </div>

            <div
              id="profileWarning"
              class="profile-warning"
              style="display: none"
            >
              <div class="d-flex align-items-center">
                <i
                  class="bi bi-exclamation-triangle-fill me-3 text-warning"
                  style="font-size: 1.5rem"
                ></i>
                <div>
                  <h5 class="mb-1">Complete Your Profile</h5>
                  <p class="mb-0">
                    You need to complete your profile before submitting service requests.
                  </p>
                </div>
                <button
                  class="btn btn-warning ms-auto"
                  onclick="showProfileUpdateModal()"
                >
                  Complete Profile
                </button>
              </div>
            </div>

            <div class="container">
              <div class="row g-4 justify-content-center">
                
                <div class="col-md-4">
                  <div class="dashboard-menu-card card-profile" onclick="showSection('profile')">
                    <div class="card-icon-wrapper">
                      <i class="bi bi-person-vcard-fill"></i>
                    </div>
                    <h3 class="menu-title">My Profile</h3>
                    <p class="menu-desc">
                      View and update your personal information, school ID, and contact details.
                    </p>
                    <button class="btn btn-outline-primary btn-menu-action">
                      Manage Profile
                    </button>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="dashboard-menu-card card-services" onclick="showSection('services')">
                    <div class="card-icon-wrapper">
                      <i class="bi bi-collection-fill"></i>
                    </div>
                    <h3 class="menu-title">Services</h3>
                    <p class="menu-desc">
                      Request documents like Transcript of Records, Grades, Diplomas, and more.
                    </p>
                    <button class="btn btn-outline-success btn-menu-action">
                      Request Now
                    </button>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="dashboard-menu-card card-about" data-bs-toggle="modal" data-bs-target="#aboutModal">
                    <div class="card-icon-wrapper">
                      <i class="bi bi-info-circle-fill"></i>
                    </div>
                    <h3 class="menu-title">About & Fees</h3>
                    <p class="menu-desc">
                      Read important reminders, procedures, processing times, and document fees.
                    </p>
                    <button class="btn btn-outline-warning text-dark btn-menu-action">
                      View Details
                    </button>
                  </div>
                </div>

              </div>
            </div>
            </div>
        </div>

<div id="services" class="section">
  <div class="home-content">
    <div class="text-center mb-5">
      <h2>Select a Category</h2>
      <p class="text-muted">Choose a category below to find the specific document you need.</p>
    </div>

    <div class="row justify-content-center g-4">
      <div class="col-md-4">
        <div class="card h-100 service-category-card text-center p-4 shadow-sm" 
             style="cursor: pointer; transition: transform 0.2s;"
             onclick="openCategoryModal('academic')"
             onmouseover="this.style.transform='scale(1.03)'"
             onmouseout="this.style.transform='scale(1)'">
          <div class="mb-3">
            <i class="bi bi-journal-bookmark-fill text-primary" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold">Academic Records & Grades</h4>
          <p class="text-muted small">Transcript of Records, Certificate of Grades, Units Earned</p>
          <button class="btn btn-outline-primary btn-sm mt-3">Select Documents</button>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100 service-category-card text-center p-4 shadow-sm"
             style="cursor: pointer; transition: transform 0.2s;"
             onclick="openCategoryModal('certifications')"
             onmouseover="this.style.transform='scale(1.03)'"
             onmouseout="this.style.transform='scale(1)'">
          <div class="mb-3">
            <i class="bi bi-patch-check-fill text-success" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold">Certifications & Status</h4>
          <p class="text-muted small">Enrollment, Honors, Class Ranking, Medium of Instruction</p>
          <button class="btn btn-outline-success btn-sm mt-3">Select Documents</button>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100 service-category-card text-center p-4 shadow-sm"
             style="cursor: pointer; transition: transform 0.2s;"
             onclick="openCategoryModal('graduation')"
             onmouseover="this.style.transform='scale(1.03)'"
             onmouseout="this.style.transform='scale(1)'">
          <div class="mb-3">
            <i class="bi bi-mortarboard-fill text-warning" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold">Graduation & Credentials</h4>
          <p class="text-muted small">Diploma, Graduation Cert, CAV, Transfer Credentials</p>
          <button class="btn btn-outline-warning btn-sm mt-3">Select Documents</button>
        </div>
      </div>
    </div>

    <div class="view-selected-container hero-buttons mt-5 text-center">
      <button class="btn btn-primary btn-lg px-5" onclick="viewSelectedServices()">
        <i class="bi bi-basket me-2"></i> View Selected Items
        <span id="selectedCountBadge" class="badge bg-danger ms-2 rounded-pill" style="display: none">0</span>
      </button>
    </div>
  </div>
</div>



        <!-- Docs Section -->
        <div id="docs" class="section">
          <div class="home-content">
            <div class="text-center">
              <h2>Forms & Documents</h2>
              <p>
                Download and print the forms you need for your requested
                services.
              </p>
            </div>
            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                Transcript of Records Request Form
              </h4>
              <p>Use this form to request your official academic transcript.</p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>

            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i> Add/Drop
                Form
              </h4>
              <p>
                Use this form to add or drop subjects from your current
                enrollment.
              </p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>

            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                Completion Form
              </h4>
              <p>
                Use this form to request completion of grades for your courses.
              </p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>

            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i> Diploma
                Request Form
              </h4>
              <p>Use this form to request issuance of your diploma.</p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Updates Section -->
        <div id="updates" class="section">
          <div class="home-content">
            <div class="text-center mb-4">
              <h2>Your Service Requests</h2>
              <p>Track the status of your requested services in real-time.</p>
              <button
                class="btn btn-outline-primary btn-sm"
                onclick="loadUserRequests()"
              >
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
              </button>
            </div>
            <div class="mb-3 px-3">
              <label for="serviceFilter" class="form-label fw-bold">Filter by Service:</label>
              <select class="form-select" id="serviceFilter" onchange="filterRequests()">
                <option value="all" selected>All Services</option>
                
                <optgroup label="Academic Records">
                  <option value="Transcript of Records">Transcript of Records</option>
                  <option value="Certificate of Grades">Certificate of Grades</option>
                  <option value="Certificate of Units Earned">Certificate of Units Earned</option>
                </optgroup>

                <optgroup label="Certifications">
                  <option value="Certificate of Enrolment">Certificate of Enrolment</option>
                  <option value="Certificate of Honors">Certificate of Honors</option>
                  <option value="Certificate of Upper 25">Certificate of Upper 25</option>
                  <option value="Certificate of English as Medium">Certificate of English as Medium</option>
                </optgroup>

                <optgroup label="Graduation">
                  <option value="Certificate of Graduation">Certificate of Graduation</option>
                  <option value="Diploma (Duplicate Copy)">Diploma (Duplicate Copy)</option>
                  <option value="CAV (CHED/DFA)">CAV (CHED/DFA)</option>
                  <option value="Transfer Credentials">Transfer Credentials</option>
                </optgroup>
              </select>
            </div>

            <!-- Real-time status indicators -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-primary" id="totalRequests">
                    0
                  </div>
                  <div class="stat-label">Total Requests</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-success" id="approvedRequests">
                    0
                  </div>
                  <div class="stat-label">Approved</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-info" id="processingRequests">
                    0
                  </div>
                  <div class="stat-label">Processing</div>
                </div>
              </div>
            </div>

            <div id="requestsContainer">
              <!-- Requests will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profile" class="section">
          <div class="home-content">
            <h2 class="mb-4">Your Profile</h2>

            <div class="alert-profile" id="profilePageWarning" style="display: none;">
          <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>
          <strong>Profile Incomplete</strong> - Please update your profile information to access all features.
        </div>
            <div class="profile-card">
              <div class="profile-header">
                <div class="profile-avatar" id="profileAvatarInitials">JS</div>
                <div class="profile-info">
                  <h3 id="profileName">John Smith</h3>
                  <p class="text-muted" id="profileEmail"></p>
                </div>
              </div>

              <div class="profile-details">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Full Name:</strong>
                    <span id="profileNameDisplay">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Gender:</strong>
                    <span id="profileGender">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Student ID:</strong>
                    <span id="profileStudentId">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Phone:</strong>
                    <span id="profilePhone">+63 912 345 6789</span>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Collage/Department:</strong>
                    <span id="profileCourse">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Year Level:</strong>
                    <span id="profileYear">Not set</span>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>School Year:</strong>
                    <span id="profileSchoolYear">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Year Graduated:</strong>
                    <span id="profileYearGraduated">N/A</span>
                  </div>
                </div>
                <hr />
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Campus/College:</strong>
                    <span id="profileCampus">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Date of Birth:</strong>
                    <span id="profileDob">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Place of Birth:</strong>
                    <span id="profilePob">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Nationality:</strong>
                    <span id="profileNationality">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-12">
                    <strong>Home Address:</strong>
                    <span id="profileHomeAddress">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-12">
                    <strong>Previous School:</strong>
                    <span id="profilePreviousSchool">N/A</span>
                  </div>
            </div>
            <hr />
            <div class="row mb-3">
              <div class="col-12">
                <strong>Primary (Elementary):</strong>
                <span id="profilePrimarySchool">Not set</span>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                <strong>Secondary (High School):</strong>
                <span id="profileSecondarySchool">Not set</span>
              </div>
            </div>

            <div class="profile-id-preview" id="profileIdPictureContainer" style="display: none; margin-top: 20px; text-align: center;">
              <h6 class="fw-bold">Your School ID</h6>
              <div style="max-width: 250px; border: 1px solid #ddd; border-radius: 8px; padding: 5px; background: #f9f9f9; margin: 0 auto;">
                <img id="profileIdPicture" src="" alt="School ID Preview" style="width: 100%; height: auto; border-radius: 5px;">
              </div>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                  <div class="stat-number" id="profileStatTotal">0</div>
                  <div class="stat-label">Services Requested</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="profileStatCompleted">0</div>
                  <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="profileStatInProgress">0</div>
                  <div class="stat-label">In Progress</div>
                </div>
              </div>

              <div class="mt-4">
                <button
                  class="btn btn-primary me-2"
                  onclick="showProfileUpdateModal()"
                >
                  <i class="bi bi-pencil me-1"></i> Update Profile
                </button>
                <!-- <button class="btn btn-outline-danger" onclick="logout(this)">
  <i class="bi bi-box-arrow-right me-1"></i> Logout
</button> -->
              </div>
            </div>

            <!-- Profile Update Form (visible when editing) -->
            <div
              id="profileUpdateFormSection"
              class="profile-update-form"
              style="display: none"
            >
              <h4 class="mb-4">Update Your Profile</h4>
              <form id="inlineProfileForm">
                <!-- Form content would go here -->
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title fw-bold">
              <i class="bi bi-info-square-fill me-2 text-warning"></i> 
              Registrar Information Center
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body bg-light p-4">
            
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-4 border-0 shadow-sm h-100">
                  <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h5 class="fw-bold text-danger"><i class="bi bi-bell-fill me-2"></i>REMINDERS</h5>
                  </div>
                  <div class="card-body">
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item border-0 ps-0">
                        <i class="bi bi-dot text-danger"></i> 
                        Only the record owner may request/claim documents. Valid ID required.
                      </li>
                      <li class="list-group-item border-0 ps-0">
                        <i class="bi bi-dot text-danger"></i> 
                        Accepted IDs: Student ID, National ID, Driver's License, Passport, etc.
                      </li>
                      <li class="list-group-item border-0 ps-0">
                        <i class="bi bi-dot text-danger"></i> 
                        Representatives must present an Authorization Letter and Valid ID.
                      </li>
                      <li class="list-group-item border-0 ps-0">
                        <i class="bi bi-dot text-danger"></i> 
                        Requests may be denied due to pending accountabilities.
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card mb-4 border-0 shadow-sm h-100">
                  <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h5 class="fw-bold text-primary"><i class="bi bi-list-ol me-2"></i>PROCEDURES</h5>
                  </div>
                  <div class="card-body">
                    <ol class="ps-3">
                      <li class="mb-2"><strong>Fill-Out Form:</strong> Secure & fill out form from Registration Unit (or via this App).</li>
                      <li class="mb-2"><strong>Payment:</strong> Pay fees at the Cashier's Office.</li>
                      <li class="mb-2"><strong>Verification:</strong> Submit form/receipt to Registration Unit.</li>
                      <li class="mb-2"><strong>Lacking Docs:</strong> Submit any missing requirements if notified.</li>
                      <li class="mb-2"><strong>Claim Stub:</strong> Receive stub (or digital notification).</li>
                      <li><strong>Claiming:</strong> Pick up documents on the scheduled date.</li>
                    </ol>
                  </div>
                </div>
              </div>
            </div>

            <div class="card border-0 shadow-sm mt-2">
              <div class="card-header bg-success text-white fw-bold py-3">
                <i class="bi bi-cash-coin me-2"></i> PROCESSING FEE AND TIME
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col" class="ps-4">Document Type</th>
                        <th scope="col">Fee</th>
                        <th scope="col">Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="ps-4">CAV Graduate/ Undergraduate</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of Upper 25</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>14 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of Graduation</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of Honors/ PD907</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of Grades</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>7 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of Enrolment</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of Units Earned</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Certificate of English (Medium of Instruction)</td>
                        <td class="fw-bold text-success">â‚±25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Transcript of Records (Duplicate)</td>
                        <td class="fw-bold text-success">â‚±40.00 <span class="text-muted small fw-normal">/page</span></td>
                        <td>7 working days</td>
                      </tr>
                      <tr>
                        <td class="ps-4">Diploma (Duplicate Copy)</td>
                        <td class="fw-bold text-success">â‚±100.00</td>
                        <td>1 month</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="/assets/js/dashboard.js"></script> -->

    <script>
      // ===== AUTHENTICATION CHECK =====
      function checkAuthentication() {
        const userId = localStorage.getItem("userId");
        if (!userId) {
          // Not logged in â†’ redirect to welcome page
          window.location.href = "/";
          return false;
        }
        return true;
      }

      // ===== UTILITY FUNCTIONS =====

      // Auto logout functionality for security
      let inactivityTimer;

      function resetInactivityTimer() {
        // Clear existing timer
        clearTimeout(inactivityTimer);

        // Set new timer (30 minutes = 1800000 ms)
        inactivityTimer = setTimeout(logout, 1800000); // 30 minutes
      }

      // ===== LOGOUT FUNCTION (With Confirmation & Loading) =====
      function logout(btnElement = null) {
        // 1. Ask for Confirmation
        if (!confirm("Are you sure you want to log out?")) {
            return;
        }

        // 2. Set Loading State (Visual Feedback)
        showToast("Logging out...", "info");
        
        // If the click came from a button, make it spin
        if (btnElement && typeof setButtonLoading === "function") {
            // Using your existing helper function
            // We don't need to reset it because the page will navigate away
            btnElement.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Logging out...';
            btnElement.disabled = true;
        }

        // 3. Process Logout (with small delay for UX)
        setTimeout(() => {
            // Clear all user data
            localStorage.removeItem("fullname");
            localStorage.removeItem("userId");
            localStorage.removeItem("userPhone");
            localStorage.removeItem("userEmail");
            localStorage.removeItem("loginTime");
            
            // Redirect
            window.location.href = "/login";
        }, 1000);
      }

      function setupActivityListeners() {
        // Reset timer on any of these events
        const events = [
          "mousedown",
          "mousemove",
          "keypress",
          "scroll",
          "touchstart",
        ];

        events.forEach((event) => {
          document.addEventListener(event, resetInactivityTimer);
        });

        // Initialize the timer
        resetInactivityTimer();
      }

      // Check session function
      function checkSession() {
        const loginTime = localStorage.getItem("loginTime");
        const now = new Date().getTime();
        const sessionDuration = 30 * 60 * 1000; // 30 minutes in milliseconds

        if (loginTime && now - loginTime > sessionDuration) {
          logout();
          return false;
        }
        return true;
      }

      // ===== BUTTON LOADING HELPER =====
      function setButtonLoading(button, isLoading, originalText = "") {
        if (!button) return;

        if (isLoading) {
          // Check if already loading to prevent double execution
          if (button.dataset.loading === "true") return false; 
          
          button.dataset.loading = "true";
          button.dataset.originalText = button.innerHTML;
          button.disabled = true;
          button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
          return true; // Success: Loading started
        } else {
          button.dataset.loading = "false";
          button.disabled = false;
          button.innerHTML = originalText || button.dataset.originalText || "Submit";
          return true;
        }
      }
      // --- NEW: Function to check for unread notifications ---
async function checkNotificationStatus() {
  const userId = localStorage.getItem("userId");
  if (!userId) return;

  try {
    const response = await fetch(
      `/api/user/notifications-status?userId=${userId}`
    );
    const data = await response.json();

    const dot = document.getElementById("updates-notification-dot");
    if (data.success && data.hasUnread) {
      if (dot) dot.style.display = "block";
    } else {
      if (dot) dot.style.display = "none";
    }
  } catch (error) {
    console.error("Error checking notifications:", error);
  }
}
// ðŸŸ¢ UNIVERSITY DATA STRUCTURE ðŸŸ¢
      const universityData = {
        "College of Arts and Sciences": {
          "Bachelor of Arts in English Language Studies": ["N/A"],
          "Bachelor of Arts in Political Science": ["N/A"],
          "Bachelor in Public Administration": ["N/A"],
          "Bachelor of Science in Biology": ["Microbiology"]
        },
        "College of Business and Accountancy": {
          "Bachelor of Science in Accountancy": ["N/A"],
          "Bachelor of Science in Business Administration": ["Financial Management", "Operations Management"]
        },
        "College of Computing, Multimedia Arts and Digital Innovation": {
          "Bachelor of Science in Information Technology": ["N/A"],
          "Bachelor of Arts in Multimedia Arts": ["N/A"]
        },
        "College of Education": {
          "Bachelor of Secondary Education": ["Filipino", "Mathematics", "English", "Science", "Values Education"],
          "Bachelor of Elementary Education": ["N/A"],
          "Bachelor of Physical Education": ["N/A"],
          "Bachelor of Technology and Livelihood Education": ["N/A"]
        },
        "College of Engineering and Technology": {
          "Bachelor of Science in Mechanical Engineering": ["N/A"],
          "Bachelor of Science in Electrical Engineering": ["N/A"],
          "Bachelor of Science in Civil Engineering": ["N/A"],
          "Bachelor of Science in Agriculture and Biosystems Engineering": ["N/A"]
        }
      };

      // 1. Populate Colleges on Load (Called automatically later)
      function initDropdowns() {
          const campusSelect = document.getElementById("campus");
          campusSelect.innerHTML = '<option value="" selected disabled>Select College...</option>';
          
          for (const college in universityData) {
              const option = document.createElement("option");
              option.value = college;
              option.textContent = college;
              campusSelect.appendChild(option);
          }
      }

      // 2. Populate Programs based on College Selection
      function populatePrograms() {
          const college = document.getElementById("campus").value;
          const programSelect = document.getElementById("program");
          const majorSelect = document.getElementById("major");

          // Reset
          programSelect.innerHTML = '<option value="" selected disabled>Select Program...</option>';
          programSelect.disabled = true;
          majorSelect.innerHTML = '<option value="N/A" selected>N/A</option>';
          majorSelect.disabled = true;

          if (college && universityData[college]) {
              const programs = universityData[college];
              for (const prog in programs) {
                  const option = document.createElement("option");
                  option.value = prog;
                  option.textContent = prog;
                  programSelect.appendChild(option);
              }
              programSelect.disabled = false;
          }
      }

      // 3. Populate Majors based on Program Selection
      function populateMajors() {
          const college = document.getElementById("campus").value;
          const program = document.getElementById("program").value;
          const majorSelect = document.getElementById("major");

          // Reset
          majorSelect.innerHTML = '';
          
          if (college && program && universityData[college][program]) {
              const majors = universityData[college][program];
              
              majors.forEach(major => {
                  const option = document.createElement("option");
                  option.value = major;
                  option.textContent = major;
                  majorSelect.appendChild(option);
              });
              
              // If only "N/A" exists, disable it for better UX
              if (majors.length === 1 && majors[0] === "N/A") {
                  majorSelect.disabled = true; 
              } else {
                  majorSelect.disabled = false;
              }
          } else {
               majorSelect.innerHTML = '<option value="N/A" selected>N/A</option>';
               majorSelect.disabled = true;
          }
      }

      // Call this once on page load
      document.addEventListener("DOMContentLoaded", initDropdowns);
      // Show profile update modal function
      // Show profile update modal function
      function showProfileUpdateModal() {
        // This function now calls loadUserProfile() to pre-fill all fields
        // from the database before showing the modal.
        loadUserProfile();
      }

      // Enhanced profile modal with callback
      function showProfileUpdateModalWithCallback(callback) {
        const modal = new bootstrap.Modal(
          document.getElementById("profileUpdateModal")
        );

        // Store callback for after profile save
        window.profileSaveCallback = callback;

        // Pre-fill phone and email from localStorage
        const phone = localStorage.getItem("userPhone") || "";
        const email = localStorage.getItem("userEmail") || "";

        document.getElementById("phone").value = phone;
        document.getElementById("email").value = email;

        modal.show();
      }

      // Show service confirmation modal function
      function showServiceConfirmationModal(serviceName) {
        // Check if service is already selected
        if (selectedServicesList.includes(serviceName)) {
          showAlert("This service is already in your selected list.", "info");
          return; // Don't show the modal if already added
        }

        const service = servicesData[serviceName];

        // --- THIS IS THE NEW LINE ---
        document.getElementById(
          "serviceConfirmationModalLabel"
        ).innerHTML = `<i class="bi bi-info-circle me-2 text-primary"></i> ${serviceName}`;
        // --- END NEW LINE ---

        document.getElementById("serviceDescription").textContent =
          service.description;
        document.getElementById("serviceRequirements").innerHTML =
  service.requirements.map((r) => `<li>${r.name}</li>`).join("");
        document.getElementById("serviceFee").textContent = service.price
          ? `â‚±${service.price.toFixed(2)}`
          : "N/A";

        // Update confirm button
        const confirmBtn = document.getElementById("confirmAddServiceBtn");
        confirmBtn.onclick = function () {
          // This function handles the actual "add" logic
          const addServiceAction = () => {
            // Double-check it wasn't added in the meantime (unlikely, but safe)
            if (!selectedServicesList.includes(serviceName)) {
              selectedServicesList.push(serviceName);
              updateSelectedCount(); // <-- THIS is where count is updated
              refreshModal();

              // Add visual feedback to the card
              const serviceCard = document.querySelector(
                `.service-card[onclick="selectService('${serviceName}')"]`
              );
              if (serviceCard) {
                serviceCard.classList.add("selected");
              }
            }

            // Hide this modal
            const serviceModal = bootstrap.Modal.getInstance(
              document.getElementById("serviceConfirmationModal")
            );
            serviceModal.hide();

            // Auto-show 'View Selected Services' modal if it's the first item
            if (selectedServicesList.length === 1 && userProfileComplete) {
              viewSelectedServices();
            }
          };

          if (!userProfileComplete) {
            // Show profile modal first
            const serviceModal = bootstrap.Modal.getInstance(
              document.getElementById("serviceConfirmationModal")
            );
            serviceModal.hide();
            showProfileUpdateModalWithCallback(addServiceAction); // Pass the action as a callback
          } else {
            // Profile is complete, just run the add action
            addServiceAction();
          }
        };

        const modal = new bootstrap.Modal(
          document.getElementById("serviceConfirmationModal")
        );
        modal.show();
      }

// Update profile display
      function updateProfileDisplay(user) {
        // NEW: Update name fields in the modal for editing
        const avatar = document.getElementById("profileAvatarInitials");
        if (avatar && user.first_name && user.last_name) {
          // Get first letter of last name (e.g., "M" from "Mantes")
          const lastNameInitial = user.last_name.charAt(0);
          // Get first letter of first name (e.g., "V" from "Vuns")
          const firstNameInitial = user.first_name.charAt(0);
          
          // Combine them and set the text
          avatar.textContent = (lastNameInitial + firstNameInitial).toUpperCase();
        }
        if (user.first_name)
          document.getElementById("firstName").value = user.first_name;
        if (user.last_name)
          document.getElementById("lastName").value = user.last_name;
        if (user.middle_name)
          document.getElementById("middleName").value = user.middle_name;
        if (user.gender) document.getElementById("gender").value = user.gender;

        // NEW: Update profile display
        if (user.fullname) {
          document.getElementById("profileName").textContent = user.fullname;
          document.getElementById("profileNameDisplay").textContent =
            user.fullname;
        }
        if (user.gender)
          document.getElementById("profileGender").textContent = user.gender;

        // Existing fields
        if (user.student_id)
          document.getElementById("profileStudentId").textContent =
            user.student_id;
        if (user.course)
          document.getElementById("profileCourse").textContent = user.course;
        if (user.year_level)
          document.getElementById("profileYear").textContent = user.year_level;
        if (user.school_year)
          document.getElementById("profileSchoolYear").textContent =
            user.school_year;
        if (user.year_graduated) {
          document.getElementById("profileYearGraduated").textContent =
            user.year_graduated;
        } else {
          document.getElementById("profileYearGraduated").textContent = "N/A";
        }

        // Update phone and email display in profile section
        if (user.phone)
          document.getElementById("profilePhone").textContent = user.phone;
        if (user.email)
          document.getElementById("profileEmail").textContent = user.email;

        // Also update email in the modal
        if (user.email) document.getElementById("email").value = user.email;

        // --- ADDED NEW FIELDS ---
        document.getElementById("profileCampus").textContent =
          user.campus || "Not set";
        document.getElementById("profileDob").textContent = user.dob
          ? new Date(user.dob).toLocaleDateString()
          : "Not set";
        document.getElementById("profilePob").textContent =
          user.pob || "Not set";
        document.getElementById("profileNationality").textContent =
          user.nationality || "Not set";
        document.getElementById("profileHomeAddress").textContent =
          user.home_address || "Not set";
        document.getElementById("profilePreviousSchool").textContent =
          user.previous_school || "N/A";
        document.getElementById("profilePrimarySchool").textContent =
          user.primary_school || "Not set";
        document.getElementById("profileSecondarySchool").textContent =
          user.secondary_school || "Not set";
          // --- END ADDED FIELDS ---

        const idContainer = document.getElementById(
          "profileIdPictureContainer"
        );
        const idImage = document.getElementById("profileIdPicture");

        if (user.school_id_picture) {
          // Check if it's a Base64 string (New system) or a Filename (Old system fallback)
          if (user.school_id_picture.startsWith("data:")) {
             idImage.src = user.school_id_picture;
          } else {
             // Fallback for any old images (though these won't load on Vercel)
             idImage.src = "/uploads/" + user.school_id_picture;
          }
          idContainer.style.display = "block";
        } else {
          // No picture, hide the container
          idContainer.style.display = "none";
        }
      }

      // ---
      // === ADD THIS ENTIRE NEW FUNCTION ===
      // ---
      function updateServiceRequestCounters(requests) {
        const serviceCounts = {};

        // 1. Count all past services
        for (const request of requests) {
          // request.services is an array, e.g., ["Transcript of Records"]
          if (Array.isArray(request.services)) {
            for (const serviceName of request.services) {
              serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
            }
          }
        }

        // 2. Hide all counters first to reset them on refresh
        document.querySelectorAll('.service-counter').forEach(counter => {
          counter.style.display = 'none';
          counter.textContent = '';
        });

        // 3. Update the DOM for each service that has a count
        for (const serviceName in serviceCounts) {
          const count = serviceCounts[serviceName];
          if (count > 0) {
            // Find the card using the unique onclick attribute
            const serviceCard = document.querySelector(
              `.card[onclick="selectService('${serviceName}')"]`
            );
            
            if (serviceCard) {
              // Find the counter element *inside* that specific card
              const counterElement = serviceCard.querySelector('.service-counter');
              if (counterElement) {
                counterElement.textContent = `Requested: ${count}`;
                counterElement.style.display = 'inline-block'; // Make it visible
              }
            }
          }
        }
      }
      // ---
      // === END OF NEW FUNCTION ===
      // ---

// ===== NAVIGATION FUNCTION =====
function showSection(targetId) {
  const sections = document.querySelectorAll(".section");
  const navLinks = document.querySelectorAll(".nav-link");

  // Update active states
  sections.forEach((sec) => sec.classList.remove("active"));
  navLinks.forEach((l) => l.classList.remove("active"));

  const targetLink = document.querySelector(
    `.nav-link[data-target="${targetId}"]`
  );
  if (targetLink) {
    targetLink.classList.add("active");
  }

  const targetSection = document.getElementById(targetId);
  if (targetSection) {
    targetSection.classList.add("active");
  }

  // --- NEW LOGIC FOR NOTIFICATIONS ---
  if (targetId === "updates") {
    // 1. Instantly hide the dot
    const dot = document.getElementById("updates-notification-dot");
    if (dot) dot.style.display = "none";

    // 2. Tell the backend to mark all as read
    const userId = localStorage.getItem("userId");
    if (userId) {
      fetch("/api/user/mark-notifications-read", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: userId }),
      }).catch((err) => console.error("Error marking read:", err));
    }

    // 3. Load the requests
    loadUserRequests();
  }
  // --- END NEW LOGIC ---

  // Close mobile menu if open
  const navbar = document.querySelector(".navbar-collapse");
  if (navbar.classList.contains("show")) {
    new bootstrap.Collapse(navbar).hide();
  }
}


      // ===== API FUNCTIONS =====

      // Check if profile is complete
      async function checkProfileComplete() {
        const userId = localStorage.getItem("userId");

        if (!userId) {
          console.error("No user ID found in localStorage");
          return false;
        }

        try {
          const response = await fetch(
            `/api/user/can-join-queue?userId=${userId}`
          );

          // Check if response is OK (status 200-299)
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          return data.success && data.canJoinQueue;
        } catch (error) {
          console.error("Error checking profile status:", error);
          return false;
        }
      }

async function checkUserProfileStatus() {
  const userId = localStorage.getItem("userId");
  if (!userId) return false;

  try {
    const response = await fetch(`/api/user/profile?userId=${userId}`);
    const data = await response.json();

    if (data.success) {
      // --- THIS IS THE FIX ---
      // This line displays your name, ID, image, etc. on the profile tab
      updateProfileDisplay(data.user);
      // --- END OF FIX ---

      // Check if profile is complete (1 = complete, 0 = incomplete)
      userProfileComplete = data.user.profile_complete;

      // Get elements for BOTH warnings
      const homeTabWarning = document.getElementById("profileWarning");
      const profileTabWarning = document.getElementById("profilePageWarning"); // <-- The new ID
      const viewServicesBtn = document.getElementById("viewServicesBtn");

      // Show/hide warnings based on completion status
      if (homeTabWarning) {
        homeTabWarning.style.display = userProfileComplete ? "none" : "flex";
      }
      if (profileTabWarning) {
        profileTabWarning.style.display = userProfileComplete
          ? "none"
          : "block";
      }

      // Show/hide view services button
      if (viewServicesBtn) {
        viewServicesBtn.style.display = userProfileComplete ? "block" : "none";
      }

      // --- This line was already correct ---
      checkAllFilesUploaded(); // Re-check button status after profile state changes

      // If profile is NOT complete, call loadUserProfile()
      // which will pre-fill what it can, and then show the modal.
      if (!userProfileComplete) {
        await loadUserProfile(); // Load data into modal and show it
      }

      return userProfileComplete;
    }
  } catch (error) {
    console.error("Error checking profile status:", error);
  }
  return false;
}

async function loadUserProfile() {
        const userId = localStorage.getItem("userId");
        if (!userId) return;

        try {
          const response = await fetch(`/api/user/profile?userId=${userId}`);

          if (!response.ok) {
            if (response.status === 404) {
              const modal = new bootstrap.Modal(document.getElementById("profileUpdateModal"));
              modal.show();
              return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          // ... inside loadUserProfile, after fetching data ...
          const user = data.user;

          // Standard Fields
          document.getElementById("lastName").value = user.last_name || "";
          document.getElementById("firstName").value = user.first_name || "";
          document.getElementById("middleName").value = user.middle_name || "";
          document.getElementById("gender").value = user.gender || "";
          document.getElementById("phone").value = user.phone || "";
          document.getElementById("studentId").value = user.student_id || "";
          document.getElementById("yearLevel").value = user.year_level || "";
          document.getElementById("schoolYear").value = user.school_year || "";
          document.getElementById("yearGraduated").value = user.year_graduated || "";
          document.getElementById("email").value = user.email || "";
          document.getElementById("dob").value = user.dob ? user.dob.split("T")[0] : "";
          document.getElementById("pob").value = user.pob || "";
          document.getElementById("nationality").value = user.nationality || "";
          document.getElementById("home_address").value = user.home_address || "";
          document.getElementById("previous_school").value = user.previous_school || "";
          document.getElementById("primary_school").value = user.primary_school || "";
          document.getElementById("secondary_school").value = user.secondary_school || "";

          // ðŸŸ¢ DYNAMIC DROPDOWN LOGIC FOR EDITING ðŸŸ¢
          if (user.campus) {
              const campusSelect = document.getElementById("campus");
              campusSelect.value = user.campus;
              
              // Trigger Program Load
              populatePrograms(); 
              
              if (user.course) { // Note: database column 'course' holds the 'Program'
                  const programSelect = document.getElementById("program");
                  programSelect.value = user.course;
                  
                  // Trigger Major Load
                  populateMajors();
                  
                  if (user.major) {
                      document.getElementById("major").value = user.major;
                  }
              }
          }
          // ðŸŸ¢ END DYNAMIC LOGIC ðŸŸ¢

          updateProfileDisplay(user);

          // ðŸŸ¢ NEW LOGIC: Hide Close/Cancel buttons if profile is incomplete ðŸŸ¢
          const modalEl = document.getElementById("profileUpdateModal");
          const closeBtn = modalEl.querySelector(".btn-close");     // The X button in header
          const cancelBtn = modalEl.querySelector(".btn-secondary"); // The Cancel button in footer

          if (user.profile_complete === 0) {
             // Mandatory Mode: Hide buttons so they MUST save
             if (closeBtn) closeBtn.style.display = "none";
             if (cancelBtn) cancelBtn.style.display = "none";
          } else {
             // Edit Mode: Show buttons so they can cancel
             if (closeBtn) closeBtn.style.display = "block";
             if (cancelBtn) cancelBtn.style.display = "block";
          }

          // Show the modal
          const modal = new bootstrap.Modal(modalEl);
          modal.show();

        } catch (error) {
          console.error("Error loading user profile:", error);
          // Fallback: show modal if error
          const modal = new bootstrap.Modal(document.getElementById("profileUpdateModal"));
          modal.show();
        }
      }

      // Save profile data to server
      async function saveProfileToServer(profileData) {
        const userId = localStorage.getItem("userId");

        try {
          const response = await fetch("/api/user/update-profile", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: userId,
              ...profileData,
            }),
          });

          const data = await response.json();

          if (data.success) {
            // Reload profile data
            await loadUserProfile();
            return true;
          } else {
            showAlert("Error updating profile: " + data.message, "error");
            return false;
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          showAlert("Error updating profile. Please try again.", "error");
          return false;
        }
      }

      // ===== SERVICES DATA AND FUNCTIONS =====

      // Services data
const servicesData = {
  // --- Group 1: Academic Records ---
  "Transcript of Records": {
    category: "academic",
    description: "Official academic record showing all courses and grades.",
    requirements: [{ name: "Clearance" }, { name: "Documentary Stamp" }, { name: "Receipt of Payment" }],
    price: 40.00,
    time: "7 working days"
  },
  "Certificate of Grades": {
    category: "academic",
    description: "Official certification of grades for specific semesters.",
    requirements: [{ name: "Request Form" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "7 working days"
  },
  "Certificate of Units Earned": {
    category: "academic",
    description: "Certification of total units earned in the program.",
    requirements: [{ name: "Request Form" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },

  // --- Group 2: Certifications ---
  "Certificate of Enrolment": {
    category: "certifications",
    description: "Proof that the student is currently enrolled.",
    requirements: [{ name: "Study Load" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Certificate of Honors": {
    category: "certifications",
    description: "Certification for Dean's Listers or Latin Honors.",
    requirements: [{ name: "Copy of Grades" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Certificate of Upper 25": {
    category: "certifications",
    description: "Certification of class ranking (Upper 25%).",
    requirements: [{ name: "Request Letter" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "14 working days"
  },
  "Certificate of English as Medium": {
    category: "certifications",
    description: "Certifies that English is the medium of instruction.",
    requirements: [{ name: "Request Form" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },

  // --- Group 3: Graduation ---
  "Certificate of Graduation": {
    category: "graduation",
    description: "Proof of graduation from the institution.",
    requirements: [{ name: "Clearance" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Diploma (Duplicate Copy)": {
    category: "graduation",
    description: "Re-issuance of Diploma.",
    requirements: [{ name: "Notarized Affidavit of Loss" }, { name: "Receipt of Payment" }],
    price: 100.00,
    time: "1 month"
  },
  "CAV (CHED/DFA)": {
    category: "graduation",
    description: "Certification, Authentication and Verification.",
    requirements: [{ name: "Diploma & TOR Photocopies" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Transfer Credentials": {
    category: "graduation",
    description: "Honorable Dismissal / Transfer Credentials.",
    requirements: [{ name: "Clearance" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "On Process"
  }
};

      // ===== ENHANCED DASHBOARD FUNCTIONALITY =====
      let selectedServicesList = [];
      let autoRefreshInterval;
      let userProfileComplete = false;
      let userHasExistingId = false;

      // Enhanced service selection with visual feedback
      function selectService(serviceName) {
        if (!checkAuthentication() || !checkSession()) return;

        // Use a reliable selector to find the card
        const serviceCard = document.querySelector(
          `.service-card[onclick="selectService('${serviceName}')"]`
        );

        if (selectedServicesList.includes(serviceName)) {
          // Deselect service by clicking the card again
          selectedServicesList = selectedServicesList.filter(
            (s) => s !== serviceName
          );
          if (serviceCard) serviceCard.classList.remove("selected");

          // Update count and modal list
          updateSelectedCount();
          refreshModal();
        } else {
          // Service is not selected, so show confirmation modal to add it.
          // The "Add Service" button in the modal will handle the logic.
          showServiceConfirmationModal(serviceName);
        }

        // All other logic (updateSelectedCount, refreshModal, etc.)
        // has been removed from here. It now lives inside the
        // confirmation modal's "Add Service" button.
      }

      // Update selected services count
      function updateSelectedCount() {
        const badge = document.getElementById("selectedCountBadge");
        const container = document.querySelector(".view-selected-container"); // Get the container

        if (badge) {
          if (selectedServicesList.length > 0) {
            badge.textContent = selectedServicesList.length;
            badge.style.display = "inline";
            // Show container
            if(container) container.style.display = "block";
          } else {
            badge.style.display = "none";
            // Hide container on mobile if empty (Optional, remove line below if you always want it visible)
            if(container && window.innerWidth < 768) container.style.display = "none";
          }
        }
      }
// ðŸŸ¢ UPDATED: Checks Files + Profile + Verification Checkbox ðŸŸ¢
function checkAllFilesUploaded() {
  const joinQueueBtn = document.getElementById("joinQueueBtn");
  const requiredUploadInputs = document.querySelectorAll(
    ".requirement-upload[required]"
  );
  // Get the new checkbox
  const confirmCheck = document.getElementById("confirmRequirementsCheck");

  // If no services selected, button disabled
  if (selectedServicesList.length === 0) {
    joinQueueBtn.disabled = true;
    return;
  }

  let allFilesProvided = true;
  requiredUploadInputs.forEach((input) => {
    if (input.files.length === 0) {
      allFilesProvided = false;
    }
  });

  // ðŸŸ¢ LOGIC UPDATE: Files OK? AND Profile OK? AND Checkbox Checked?
  const isCheckboxChecked = confirmCheck ? confirmCheck.checked : false;

  joinQueueBtn.disabled = !allFilesProvided || !userProfileComplete || !isCheckboxChecked;

  // Styling update
  if (joinQueueBtn.disabled) {
    joinQueueBtn.classList.remove("btn-success");
    joinQueueBtn.classList.add("btn-secondary");
  } else {
    joinQueueBtn.classList.remove("btn-secondary");
    joinQueueBtn.classList.add("btn-success");
  }
}
// --- END NEW FUNCTION ---

      // Enhanced view services function
      function viewSelectedServices() {
        if (!checkAuthentication() || !checkSession()) return;

        if (selectedServicesList.length === 0) {
          showAlert("Please select at least one service first.", "warning");
          return;
        }

        if (!userProfileComplete) {
          showProfileUpdateModal(); 
          return;
        }

        refreshModal();
        const selectedModal = new bootstrap.Modal(
          document.getElementById("selectedModal")
        );
        selectedModal.show();
      }

      function addServiceToList(serviceName) {
        if (!selectedServicesList.includes(serviceName)) {
          selectedServicesList.push(serviceName);
          refreshModal();
        }
      }

      function removeService(serviceName) {
        selectedServicesList = selectedServicesList.filter(
          (s) => s !== serviceName
        );

        // Use querySelector to find the correct card
        const serviceCard = document.querySelector(
          `.service-card[onclick="selectService('${serviceName}')"]`
        );
        if (serviceCard) {
          serviceCard.classList.remove("selected");
        }

        updateSelectedCount();
        refreshModal();
      }

function refreshModal() {
  const modalBodyLeft = document.getElementById("selectedServicesList");
  const modalBodyRight = document.getElementById("requirementsList");
  const totalAmountEl = document.getElementById("totalAmount");
  const joinQueueBtn = document.getElementById("joinQueueBtn");

  if (selectedServicesList.length === 0) {
    modalBodyLeft.innerHTML = "<p class='p-3 text-center'>No services selected yet.</p>";
    modalBodyRight.innerHTML = "";
    totalAmountEl.textContent = "â‚±0.00";
    joinQueueBtn.disabled = true;
  } else {
    let total = 0;
    let servicesHTML = "";
    let requirementsHTML = "";

    selectedServicesList.forEach((fullString, serviceIndex) => {
      // Logic to separate "Service Name" from "[Note: ...]"
      let baseName = fullString;
      let noteDisplay = "";

      if (fullString.includes("[Note:")) {
         const parts = fullString.split(" [Note:");
         baseName = parts[0];
         noteDisplay = parts[1].replace("]", ""); // Clean up the closing bracket
      }

      // Lookup data using the base name
      const service = servicesData[baseName];

      if (!service) {
        console.error("Service data missing for:", baseName);
        return;
      }

      total += service.price || 0;

      servicesHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>${baseName}</strong>
              ${noteDisplay ? `<br><small class="text-primary"><i class="bi bi-pencil-fill me-1"></i> ${noteDisplay}</small>` : ''}
              <div class="small text-muted mt-1">Fee: â‚±${service.price.toFixed(2)}</div>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeService('${fullString}')">
                <i class="bi bi-trash"></i>
            </button>
        </li>
      `;

      // Requirements
      requirementsHTML += `<div class="mb-3 p-2 border rounded"><h6 class="fw-bold text-primary">${baseName}</h6>`;
      
      if (service.requirements && service.requirements.length > 0) {
        service.requirements.forEach((req, reqIndex) => {
          const inputId = `file-${serviceIndex}-${reqIndex}`;
          requirementsHTML += `
            <div class="mb-2">
              <label for="${inputId}" class="form-label mb-1 small">
                ${req.name} <span class="text-danger">*</span>
              </label>
              <input type="file" class="form-control form-control-sm requirement-upload"
                id="${inputId}"
                data-service-name="${fullString}" 
                data-requirement-name="${req.name}"
                required onchange="checkAllFilesUploaded()" />
            </div>
          `;
        });
      }
      requirementsHTML += `</div>`;
    });

    modalBodyLeft.innerHTML = servicesHTML;
    modalBodyRight.innerHTML = requirementsHTML;
    totalAmountEl.textContent = `â‚±${total.toFixed(2)}`;
    checkAllFilesUploaded();
  }
}

// Enhanced Join Queue Function with Loading & Toast
      document.getElementById("joinQueueBtn").addEventListener("click", async function () {
          const joinBtn = this; // Capture button reference

          // ðŸŸ¢ 1. START LOADING & PREVENT DOUBLE CLICK ðŸŸ¢
          // If already loading, stop immediately
          if (!setButtonLoading(joinBtn, true)) return;

          // --- CHECKS ---
          if (!checkAuthentication() || !checkSession()) {
             setButtonLoading(joinBtn, false, "Join Queue Now");
             return;
          }

          if (selectedServicesList.length === 0) {
            showToast("Please select at least one service.", "error");
            setButtonLoading(joinBtn, false, "Join Queue Now");
            return;
          }

          if (!userProfileComplete) {
            showToast("Please complete your profile first.", "error");
            setButtonLoading(joinBtn, false, "Join Queue Now");
            return;
          }

          // --- VALIDATION ---
          const fileInputs = document.querySelectorAll(".requirement-upload[required]");
          let allFilesUploaded = true;

          fileInputs.forEach((input) => {
            if (input.files.length === 0) {
              allFilesUploaded = false;
              input.classList.add("is-invalid");
            } else {
              input.classList.remove("is-invalid");
            }
          });

          if (!allFilesUploaded) {
            showToast("Please upload all required files.", "error");
            setButtonLoading(joinBtn, false, "Join Queue Now");
            return;
          }

          // --- PREPARE DATA ---
          showToast("Submitting your request...", "info");

          const userId = localStorage.getItem("userId");
          const formData = new FormData();
          formData.append("userId", userId);

          const confirmCheck = document.getElementById("confirmRequirementsCheck");
          const isConfirmed = confirmCheck ? confirmCheck.checked : false;
          formData.append("requirements_confirmed", isConfirmed);

          selectedServicesList.forEach((service) => {
            formData.append("services", service.trim());
          });

          fileInputs.forEach((input) => {
            if (input.files.length > 0) {
              formData.append("requirements_files", input.files[0]);
              formData.append("requirement_names", input.dataset.requirementName);
            }
          });

          try {
            // --- SUBMIT ---
            const response = await fetch("/api/queue/submit-request", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              // Trigger Admin Update
              const studentName = localStorage.getItem("fullname") || "Student";
              localStorage.setItem('latestRequest', JSON.stringify({ 
                  name: studentName, 
                  timestamp: Date.now() 
              }));

              // Close Modal
              const selectedModal = bootstrap.Modal.getInstance(document.getElementById("selectedModal"));
              if (selectedModal) selectedModal.hide();

              showToast("Request submitted successfully!", "success");
              showSubmissionSuccessModal(result.requestId);

              // Reset UI
              selectedServicesList = [];
              resetServiceSelectionUI();
              updateSelectedCount();
              await loadUserRequests();
            } else {
              showToast("Error: " + result.message, "error");
            }
          } catch (error) {
            console.error("Error submitting service request:", error);
            showToast("Network error. Please try again.", "error");
          } finally {
            // ðŸŸ¢ 2. STOP LOADING (Always runs, success or fail) ðŸŸ¢
            setTimeout(() => {
              setButtonLoading(joinBtn, false, "Join Queue Now");
            }, 500); // Small delay for visual smoothness
          }
      });
      // Enhanced service request submission
      async function submitServiceRequest() {
        const userId = localStorage.getItem("userId");

        try {
          // Show loading state
          const joinBtn = document.getElementById("joinQueueBtn");
          const originalText = joinBtn.innerHTML;
          joinBtn.innerHTML =
            '<i class="bi bi-hourglass-split me-1"></i> Submitting...';
          joinBtn.disabled = true;

          // Calculate total amount and prepare requirements
          let totalAmount = 0;
          const requirements = [];

          selectedServicesList.forEach((serviceName) => {
            const service = servicesData[serviceName];
            totalAmount += service.price || 0;
            requirements.push({
              service: serviceName,
              requirements: service.requirements,
            });
          });

          // Submit to backend
          const response = await fetch("/api/queue/submit-request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: userId,
              services: selectedServicesList,
              totalAmount: totalAmount,
              requirements: requirements,
            }),
          });

          const result = await response.json();

          if (result.success) {
            // Close the modal
            const selectedModal = bootstrap.Modal.getInstance(
              document.getElementById("selectedModal")
            );
            if (selectedModal) selectedModal.hide();

            // Show success message with request ID
            showSubmissionSuccessModal(result.requestId);

            // Clear selected services and reset UI
            selectedServicesList = [];
            resetServiceSelectionUI();
            updateSelectedCount();

            // Reload user requests
            await loadUserRequests();
          } else {
            showAlert("Error submitting request: " + result.message, "error");
          }
        } catch (error) {
          console.error("Error submitting service request:", error);
          showAlert("Error submitting request. Please try again.", "error");
        } finally {
          // Reset button state
          const joinBtn = document.getElementById("joinQueueBtn");
          // --- THIS LINE IS CORRECTED ---
          joinBtn.innerHTML = "Join Queue Now";
          joinBtn.disabled = false;
        }
      }

      // Reset service selection UI
      function resetServiceSelectionUI() {
        // Remove selected class from all service cards
        document.querySelectorAll(".service-card.selected").forEach((card) => {
          card.classList.remove("selected");
        });
      }

// Enhanced user requests loading with real-time updates
      async function loadUserRequests() {
        const userId = localStorage.getItem("userId");

        if (!userId) return;

        try {
          const response = await fetch(
            `/api/user/service-requests?userId=${userId}`
          );
          const result = await response.json();

         if (result.success) {
            // 1. Render the cards to the DOM
            displayUserRequests(result.requests);
            
            // 2. Update the status counters (Total, Pending, Approved, Processing)
            updateRequestStats(result.requests);
            
            // 3. Check if there's an active queue to display the big banner
            checkForActiveQueue(result.requests);

            // 4. Update the "Requested: X" counters on the Services tab cards
            updateServiceRequestCounters(result.requests);
            
            // 5. Re-apply any active filter (e.g. if user selected "Transcript of Records")
            filterRequests(); 
          }
        } catch (error) {
          console.error("Error loading user requests:", error);
        }
      }

      // Add this new function alongside your other functions like loadUserRequests()

      /**
       * Begins the resubmission process for a declined request.
       * @param {string} requestId The ID of the declined request.
       */
      async function resubmitRequest(requestId) {
        if (!userProfileComplete) {
          showAlert("Please ensure your profile is complete before resubmitting.", "warning");
          showProfileUpdateModal();
          return;
        }

        // Show a simple loading alert
        showAlert("Loading original request details...", "info");
        const userId = localStorage.getItem("userId");

        try {
          // Call the new API endpoint you created in Step 1
          const response = await fetch(`/api/user/request-details?requestId=${requestId}&userId=${userId}`);
          const data = await response.json();

          if (data.success && data.services.length > 0) {
            // 1. Clear any services the user might have been selecting
            selectedServicesList = [];

            // 2. Add services from the old, declined request
            // We must ensure we add the *exact* service names from servicesData
            for (const serviceName of data.services) {
              if (servicesData[serviceName]) {
                selectedServicesList.push(serviceName);
              } else {
                console.warn(`Service "${serviceName}" from old request is no longer valid.`);
              }
            }

            if (selectedServicesList.length === 0) {
                showAlert("Could not resubmit. The services from this request are no longer available.", "error");
                return;
            }

            // 3. Update the UI and show the "Selected Services" modal
            updateSelectedCount();
            
            // This existing function will open the modal and pre-fill it
            // because we just populated selectedServicesList.
            viewSelectedServices(); 
            
            // Add a helpful alert in the modal
            setTimeout(() => {
                document.getElementById("requirementsList").insertAdjacentHTML(
                    'afterbegin',
                    '<div class="alert alert-warning small"><i class="bi bi-exclamation-triangle me-1"></i> <strong>Resubmitting:</strong> Please upload your corrected requirements files below.</div>'
                );
            }, 500); // Delay to ensure modal is visible

          } else {
            showAlert(`Error: ${data.message || "Could not find details for this request."}`, "error");
          }
        } catch (error) {
          console.error("Error resubmitting request:", error);
          showAlert("An error occurred. Please try again.", "error");
        }
      }

// ðŸŸ¢ FINAL COMPLETE VERSION (Restores Feedback Button) ðŸŸ¢
function displayUserRequests(requests) {
  const container = document.getElementById("requestsContainer");
  if (!container) return;

  if (requests.length === 0) {
    container.innerHTML = `
      <div class="update-card text-center">
          <i class="bi bi-inbox display-4 text-muted mb-3"></i>
          <h4>No Service Requests</h4>
          <p>You haven't submitted any service requests yet.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = requests.map((request) => {
      // 1. Get basic status info
      const statusInfo = getStatusInfo(request.status, request.queue_status);
      
      // 2. Prepare Staff & Window Info (Use "Registrar Staff" if missing)
      const staffName = request.processed_by || request.declined_by || "Registrar Staff";
      const windowName = request.window_number ? `Window ${request.window_number}` : "Registrar Office";
      
      // 3. Queue Badge
      const queueInfo = request.queue_number
        ? `<div class="mt-2">
             <strong>Queue Number:</strong> 
             <span class="badge queue-status-badge bg-secondary">${request.queue_number}</span>
           </div>`
        : "";

      // 4. PROCESSING BAR
      let progressHtml = "";
      if (request.queue_status === 'processing' && request.progress) {
          const p = request.progress; 
          const percent = p.total > 0 ? Math.round((p.current / p.total) * 100) : 0;
          progressHtml = `
            <div class="mt-3 p-3 bg-light rounded border">
              <div class="d-flex justify-content-between small fw-bold mb-1">
                <span class="text-primary">Processing Status</span>
                <span>${percent}%</span>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-primary" style="width: ${percent}%"></div>
              </div>
              <div class="text-muted small mt-1 text-end">
                 Processed by: ${staffName} (${windowName})
              </div>
            </div>
          `;
      }

      // 5. RED DECLINE BOX (Reason + Staff)
      let declineHtml = "";
      if (request.status === "declined" || request.status === "cancelled") {
          declineHtml = `
            <div class="alert alert-danger mt-3 border-0 shadow-sm">
                <div class="d-flex">
                    <div class="me-3"><i class="bi bi-x-circle-fill fs-1 text-danger"></i></div>
                    <div>
                        <h5 class="fw-bold text-danger mb-1">Request Declined</h5>
                        <p class="mb-0 small"><strong>Reason:</strong> ${request.decline_reason || "Requirements not met."}</p>
                        
                        <div class="mt-2 pt-2 border-top border-danger border-opacity-25 small text-danger text-opacity-75">
                            <i class="bi bi-person-badge-fill me-1"></i> Reviewed by: <strong>${staffName}</strong> 
                            <span class="ms-1 opacity-75">(${windowName})</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-end mt-2">
                <button class="btn btn-warning btn-sm" onclick="resubmitRequest('${request.request_id}')">
                    <i class="bi bi-arrow-clockwise me-1"></i> Resubmit Request
                </button>
            </div>
          `;
      }

      // 6. GREEN COMPLETED/CLAIMED BOX
      let completedHtml = "";
      // Check if finished (completed OR claimed)
      const isFinished = (request.queue_status === "completed" || request.queue_status === "claimed");
      
      if (isFinished) {
          const isClaimed = request.queue_status === 'claimed';
          const alertClass = isClaimed ? "alert-secondary" : "alert-success"; 
          const icon = isClaimed ? "bi-check2-all" : "bi-check-circle-fill";
          const title = isClaimed ? "Documents Picked Up" : "Ready to Claim!";
          const desc = isClaimed ? "Transaction complete. Documents received." : "Your document is ready. Please proceed to the window.";
          
          completedHtml = `
              <div class="alert ${alertClass} mt-3 border-0 shadow-sm">
                  <div class="d-flex">
                      <div class="me-3"><i class="bi ${icon} fs-1"></i></div>
                      <div>
                          <h5 class="fw-bold mb-1">${title}</h5>
                          <p class="mb-0 small">${desc}</p>
                          <div class="mt-2 pt-2 border-top border-secondary border-opacity-25 small">
                              <i class="bi bi-person-badge-fill me-1"></i> Processed by: <strong>${request.completed_by || staffName}</strong>
                              <span class="ms-1">(${windowName})</span>
                          </div>
                      </div>
                  </div>
              </div>
          `;
      }

      // ðŸŸ¢ 7. FEEDBACK BUTTON (RESTORED HERE) ðŸŸ¢
      let feedbackBtn = '';
      if (isFinished) {
          if (!request.feedback_id) {
              // Not rated yet -> Show Button
              feedbackBtn = `
                <div class="mt-3 text-end border-top pt-2">
                  <span class="small text-muted me-2">How was our service?</span>
                  <button class="btn btn-sm btn-outline-warning" onclick="openFeedbackModal('${request.request_id}')">
                    <i class="bi bi-star"></i> Rate Service
                  </button>
                </div>
              `;
          } else {
              // Already rated -> Show Badge
              feedbackBtn = `
                <div class="mt-3 text-end border-top pt-2">
                  <span class="badge bg-light text-success border"><i class="bi bi-check-circle-fill me-1"></i> Rated</span>
                </div>
              `;
          }
      }

      // 8. ASSEMBLE CARD (Now includes feedbackBtn)
      return `
      <div class="update-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
              <h4 class="mb-0">${request.services.join(", ")}</h4>
              <span class="queue-status-badge ${statusInfo.class}">${statusInfo.text}</span>
          </div>
          <p class="text-muted small mb-0">
              <strong>ID:</strong> ${request.request_id} | 
              <strong>Date:</strong> ${new Date(request.submitted_at).toLocaleDateString()}
          </p>
          
          ${queueInfo}
          ${progressHtml}
          ${declineHtml} 
          ${completedHtml}
          ${feedbackBtn}  </div>
      `;
    })
    .join("");
}

// --- NEW FUNCTION: Filters requests on the "Updates" page ---
function filterRequests() {
  const filterValue = document.getElementById("serviceFilter").value;
  const requestCards = document.querySelectorAll("#requestsContainer .update-card");
  let visibleCount = 0;

  requestCards.forEach((card) => {
    // Check if it's an empty state card, if so, ignore it
    if (card.querySelector(".bi-inbox")) {
      return;
    }

    const titleElement = card.querySelector("h4");
    if (!titleElement) return; // Safety check

    const servicesText = titleElement.textContent; // e.g., "Transcript of Records, Completion Grade Form"

    if (filterValue === "all" || servicesText.includes(filterValue)) {
      card.style.display = "block";
      visibleCount++;
    } else {
      card.style.display = "none";
    }
  });

  // Handle "No results" message
  const container = document.getElementById("requestsContainer");
  let noResultMsg = container.querySelector(".no-results-message");

  if (visibleCount === 0 && requestCards.length > 0 && filterValue !== 'all') {
    if (!noResultMsg) {
      noResultMsg = document.createElement("div");
      noResultMsg.className = "update-card text-center text-muted no-results-message";
      container.appendChild(noResultMsg);
    }
    noResultMsg.innerHTML = `<i class="bi bi-search display-4 mb-3"></i><h4>No requests found</h4><p>No requests match the filter "${filterValue}".</p>`;
    noResultMsg.style.display = 'block';
  } else if (noResultMsg) {
    noResultMsg.style.display = 'none'; // Just hide it
  }
}

// --- FEEDBACK LOGIC (ARTA CSM) ---
      
      const sqdList = [
        "SQD 0. I am satisfied with the service that I availed.",
        "SQD 1. I spent a reasonable amount of time for my transaction.",
        "SQD 2. The office followed the transaction's requirements and steps based on the information provided.",
        "SQD 3. The steps (including payment) I needed to do for my transaction were easy and simple.",
        "SQD 4. I easily found information about my transaction from the office or its website.",
        "SQD 5. I paid a reasonable amount of fees for my transaction.",
        "SQD 6. I feel the office was fair to everyone, or \"walang palakasan\", during my transaction.",
        "SQD 7. I was treated courteously by the staff, and (if asked for help) the staff was helpful.",
        "SQD 8. I got what I needed from the government office, or (if denied) denial of request was sufficiently explained to me."
      ];

      function openFeedbackModal(requestId) {
        document.getElementById('feedbackRequestId').value = requestId;
        document.getElementById('feedbackComments').value = '';
        
        // Reset Radios
        document.querySelectorAll('.cc-radio').forEach(el => el.checked = false);

        // Generate SQD Questions (0-8)
        const container = document.getElementById('sqdQuestions');
        container.innerHTML = sqdList.map((q, index) => `
          <div class="mb-3 border-bottom pb-2">
            <p class="small fw-semibold mb-2">${q} <span class="text-danger">*</span></p>
            <div class="d-flex flex-wrap gap-2">
                ${generateRadioOptions(index)}
            </div>
          </div>
        `).join('');

        new bootstrap.Modal(document.getElementById('feedbackModal')).show();
      }

      function generateRadioOptions(index) {
        const name = `sqd_${index}`;
        return `
            <div class="form-check form-check-inline">
                <input class="form-check-input sqd-radio" type="radio" name="${name}" value="5" id="${name}_5">
                <label class="form-check-label small" for="${name}_5">Strongly Agree (5)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input sqd-radio" type="radio" name="${name}" value="4" id="${name}_4">
                <label class="form-check-label small" for="${name}_4">Agree (4)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input sqd-radio" type="radio" name="${name}" value="3" id="${name}_3">
                <label class="form-check-label small" for="${name}_3">Neutral (3)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input sqd-radio" type="radio" name="${name}" value="2" id="${name}_2">
                <label class="form-check-label small" for="${name}_2">Disagree (2)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input sqd-radio" type="radio" name="${name}" value="1" id="${name}_1">
                <label class="form-check-label small" for="${name}_1">Strongly Disagree (1)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input sqd-radio" type="radio" name="${name}" value="0" id="${name}_0">
                <label class="form-check-label small" for="${name}_0">N/A</label>
            </div>
        `;
      }

      async function submitFeedback() {
        const requestId = document.getElementById('feedbackRequestId').value;
        const comments = document.getElementById('feedbackComments').value;
        const userId = localStorage.getItem("userId");

        // 1. Gather CC Data
        const ccData = {};
        let ccComplete = true;
        ['cc1', 'cc2', 'cc3'].forEach(name => {
            const selected = document.querySelector(`input[name="${name}"]:checked`);
            if (!selected) ccComplete = false;
            else ccData[name] = selected.value;
        });

        // 2. Gather SQD Data
        const sqdData = {};
        let sqdComplete = true;
        // There are 9 questions (SQD0 - SQD8)
        for(let i=0; i<=8; i++) {
            const selected = document.querySelector(`input[name="sqd_${i}"]:checked`);
            if(!selected) sqdComplete = false;
            else sqdData[`SQD${i}`] = selected.value;
        }

        if (!ccComplete || !sqdComplete) {
          alert("Please answer all required questions marked with (*).");
          return;
        }

        // Use SQD0 as the main rating for the charts
        const sqd0 = sqdData['SQD0']; 

        try {
          const response = await fetch('/api/user/submit-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, userId, sqd0, sqdData, ccData, comments })
          });
          
          if(response.ok) {
            showToast("Feedback submitted! Thank you.", "success");
            bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
            loadUserRequests(); 
          } else {
            showToast("Error submitting feedback.", "error");
          }
        } catch(e) { console.error(e); }
      }

      // Enhanced status information function
      // ðŸŸ¢ FIXED: Handles 'claimed' status correctly ðŸŸ¢
function getStatusInfo(status, queueStatus) {
  // If picked up, show as Completed
  if (queueStatus === "claimed") {
    return { class: "status-completed", text: "âœ… Picked Up" };
  }

  // If queue is completed (Ready to Claim)
  if (queueStatus === "completed") {
    return { class: "status-completed", text: "âœ… Ready to Claim" };
  }

  // If queue is processing
  if (queueStatus === "processing") {
    return { class: "status-processing", text: "âš™ï¸ Processing" };
  }

  // Otherwise, show the regular approval status
  switch (status) {
    case "pending":
      return { class: "status-pending", text: "â³ Pending Approval" };
    case "approved":
      return { class: "status-approved", text: "âœ… Approved" };
    case "declined":
      return { class: "status-declined", text: "âŒ Declined" };
      
    default:
      return { class: "status-pending", text: "â³ Pending" };
  }
}

// ðŸŸ¢ UPDATED: Removed Pending Counter Logic ðŸŸ¢
function updateRequestStats(requests) {
  // --- Calculations ---
  const total = requests.length;
  // We still calculate 'pending' for internal logic if needed, but won't display it
  const pending = requests.filter((r) => r.status === "pending").length;
  
  const approved = requests.filter(
    (r) => r.status === "approved" && r.queue_status === "in_queue"
  ).length;
  
  const processing = requests.filter(
    (r) => r.queue_status === "processing"
  ).length;

  const completed = requests.filter(
    (r) => r.queue_status === "completed"
  ).length;

  const inProgress = pending + approved + processing; 

  // --- Update "Updates" Tab Stats ---
  // Only update elements that still exist
  if(document.getElementById("totalRequests")) 
      document.getElementById("totalRequests").textContent = total;
  
  // Pending element removed, so line removed
  
  if(document.getElementById("approvedRequests")) 
      document.getElementById("approvedRequests").textContent = approved;
  
  if(document.getElementById("processingRequests")) 
      document.getElementById("processingRequests").textContent = processing;

  // --- Update "Profile" Tab Stats ---
  if(document.getElementById("profileStatTotal")) 
      document.getElementById("profileStatTotal").textContent = total;
  if(document.getElementById("profileStatCompleted")) 
      document.getElementById("profileStatCompleted").textContent = completed;
  if(document.getElementById("profileStatInProgress")) 
      document.getElementById("profileStatInProgress").textContent = inProgress;
}

      // Enhanced function to check for active queue
      function checkForActiveQueue(requests) {
        const activeRequest = requests.find(
          (r) =>
            (r.status === "approved" && r.queue_status === "in_queue") ||
            (r.status === "approved" && r.queue_status === "processing") ||
            (r.status === "approved" && r.queue_status === "completed")
        );

        const queueDisplay = document.getElementById("queueNumberDisplay");

        if (activeRequest && queueDisplay) {
          document.getElementById("currentQueueNumber").textContent =
            activeRequest.queue_number;

          // Update status message based on actual queue status
          let statusMessage = "In Queue - Waiting for processing";
          if (activeRequest.queue_status === "processing") {
            statusMessage = "Currently being processed";
          } else if (activeRequest.queue_status === "completed") {
            statusMessage = "Request completed";
          }

          document.getElementById("queueStatusMessage").textContent =
            statusMessage;
          queueDisplay.style.display = "block";
        } else if (queueDisplay) {
          queueDisplay.style.display = "none";
        }
      }

      // Real-time alert system
      function showAlert(message, type = "info") {
        const alertClass =
          {
            success: "alert-success",
            error: "alert-danger",
            warning: "alert-warning",
            info: "alert-info",
          }[type] || "alert-info";

        const alertId = "alert-" + Date.now();
        const alertHTML = `
        <div id="${alertId}" class="alert ${alertClass} real-time-alert alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

        document.body.insertAdjacentHTML("beforeend", alertHTML);

        // Auto remove after 5 seconds
        setTimeout(() => {
          const alert = document.getElementById(alertId);
          if (alert) {
            alert.remove();
          }
        }, 5000);
      }
// --- NEW: Toast Notification Helper ---
      function showToast(message, type = "info") {
        // Remove existing toast if any
        const existingToast = document.querySelector(".notification-toast");
        if (existingToast) existingToast.remove();

        // Create element
        const toast = document.createElement("div");
        toast.className = `notification-toast toast-${type}`;

        // Icon based on type
        let iconClass = "bi-info-circle-fill";
        if (type === "success") iconClass = "bi-check-circle-fill";
        if (type === "error") iconClass = "bi-exclamation-triangle-fill";

        toast.innerHTML = `
            <i class="bi ${iconClass} toast-icon"></i>
            <span style="font-weight: 500; color: #333;">${message}</span>
        `;

        document.body.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.animation = "slideOutRight 0.3s ease-in forwards";
            setTimeout(() => {
              if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
          }
        }, 3000);
      }

      // Function to show success modal after submission
      function showSubmissionSuccessModal(requestId) {
        const displaySuccessModal = () => {
          const successHTML = `
<div class="modal fade" id="submissionSuccessModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle-fill me-2"></i> Request Submitted
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <i class="bi bi-clock text-warning" style="font-size: 3rem;"></i>
        </div>
        <h5>Request Submitted for Approval</h5>
        <p>Your service request has been submitted and is waiting for admin approval.</p>
        <div class="alert alert-info">
          <strong>Request ID:</strong> ${requestId}<br>
          <strong>Status:</strong> <span class="badge bg-warning">Pending Approval</span>
        </div>
        <p>You will be notified once your request is approved or if additional information is needed.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
`;

          // Remove any existing success modal to prevent conflicts
          const existingModal = document.getElementById(
            "submissionSuccessModal"
          );
          if (existingModal) {
            existingModal.remove();
          }

          // Add new modal to body
          document.body.insertAdjacentHTML("beforeend", successHTML);

          // Get the newly added modal element
          const successModalEl = document.getElementById(
            "submissionSuccessModal"
          );

          // Initialize and show the Bootstrap modal
          const successModal = new bootstrap.Modal(successModalEl);
          successModal.show();

          // --- CRITICAL FIX START ---
          // Use 'hidden.bs.modal' event to remove the modal from DOM
          // This ensures that after it's visually hidden and transition is done,
          // the element (and its descendants) are completely gone,
          // preventing aria-hidden focus issues.
          successModalEl.addEventListener(
            "hidden.bs.modal",
            function () {
              this.remove();
            },
            { once: true }
          ); // Use { once: true } to remove the listener after it fires
          // --- CRITICAL FIX END ---
        };

        // Find all currently open modals
        const openModals = document.querySelectorAll(".modal.show");

        if (openModals.length > 0) {
          // If there are open modals, ensure they are all hidden first
          let modalsToHideCount = openModals.length;
          let hiddenModalsCounter = 0;

          // Define a callback to show the success modal after all others have hidden
          const showSuccessAfterOthersHidden = () => {
            hiddenModalsCounter++;
            if (hiddenModalsCounter === modalsToHideCount) {
              displaySuccessModal();
            }
          };

          openModals.forEach((modalEl) => {
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
              // Listen for each modal to finish hiding
              modalEl.addEventListener(
                "hidden.bs.modal",
                showSuccessAfterOthersHidden,
                { once: true }
              );
              modalInstance.hide(); // Command it to hide
            } else {
              // If for some reason a modal is 'show' but not initialized,
              // just increment the counter and remove it.
              modalEl.remove();
              hiddenModalsCounter++;
            }
          });
        } else {
          // No modals are open, just show the success modal immediately.
          displaySuccessModal();
        }
      }
// REPLACES the "saveProfileBtn" click listener to handle Loading State
      document
        .getElementById("saveProfileBtn")
        .addEventListener("click", async function () {
          const saveBtn = this; // Capture the button

          // ðŸŸ¢ 1. START LOADING (Prevent double clicks) ðŸŸ¢
          if (!setButtonLoading(saveBtn, true)) return;

          const formData = new FormData();
          const userId = localStorage.getItem("userId");

          if (!userId) {
              showAlert("User session not found. Please log in again.", "error");
              setButtonLoading(saveBtn, false, "Save Profile"); // Reset
              return;
          }

          formData.append("userId", userId);

          // Personal Info
          formData.append("lastName", document.getElementById("lastName").value);
          formData.append("firstName", document.getElementById("firstName").value);
          formData.append("middleName", document.getElementById("middleName").value);
          formData.append("gender", document.getElementById("gender").value);

          // Academic Info
          const studentIdValue = document.getElementById("studentId").value;
          formData.append("studentId", studentIdValue);
          
          formData.append("course", document.getElementById("program").value); 
          formData.append("major", document.getElementById("major").value);
          formData.append("yearLevel", document.getElementById("yearLevel").value);
          formData.append("schoolYear", document.getElementById("schoolYear").value);

          const yearGraduated = document.getElementById("yearGraduated").value;
          formData.append("yearGraduated", yearGraduated || null);

          // Contact Info
          formData.append("email", document.getElementById("email").value);
          formData.append("phone", document.getElementById("phone").value);

          // Additional Fields
          formData.append("campus", document.getElementById("campus").value);
          formData.append("dob", document.getElementById("dob").value);
          formData.append("pob", document.getElementById("pob").value);
          formData.append("nationality", document.getElementById("nationality").value);
          formData.append("home_address", document.getElementById("home_address").value);
          formData.append("previous_school", document.getElementById("previous_school").value);
          formData.append("primary_school", document.getElementById("primary_school").value);
          formData.append("secondary_school", document.getElementById("secondary_school").value);

          // Get the file
          const schoolIdFile = document.getElementById("schoolIdPicture").files[0];
          if (schoolIdFile) {
            formData.append("school_id_picture", schoolIdFile);
          }

          // --- VALIDATION ---
          const studentIdRegex = /^\d{3}-\d{4}-\d{6}$/;
          if (!studentIdRegex.test(studentIdValue)) {
            showAlert("Invalid Student ID format. Please use 000-0000-000000.", "warning");
            setButtonLoading(saveBtn, false, "Save Profile"); // Reset
            return; 
          }

          if (
            !formData.get("lastName") ||
            !formData.get("firstName") ||
            !formData.get("gender") ||
            !formData.get("course") || 
            !formData.get("yearLevel") ||
            !formData.get("schoolYear") ||
            !formData.get("email") ||
            !formData.get("campus") ||
            !formData.get("dob") ||
            !formData.get("pob") ||
            !formData.get("nationality") ||
            !formData.get("home_address") ||
            !formData.get("primary_school") ||
            !formData.get("secondary_school") ||
            (!schoolIdFile && !userHasExistingId)
          ) {
            showAlert("Please fill in all required fields.", "warning");
            setButtonLoading(saveBtn, false, "Save Profile"); // Reset
            return;
          }

          try {
            const response = await fetch("/api/user/update-profile", {
              method: "POST",
              body: formData, 
            });

            const data = await response.json();

            if (data.success) {
              userProfileComplete = true;
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("profileUpdateModal")
              );
              if (modal) modal.hide();

              showAlert("Profile updated successfully!", "success");

              await checkUserProfileStatus(); 

              if (window.profileSaveCallback) {
                window.profileSaveCallback();
                window.profileSaveCallback = null;
              }

            } else {
               showAlert("Error updating profile: " + data.message, "error");
            }
          } catch (error) {
            console.error("Error saving profile:", error);
            showAlert("Error updating profile. Please try again.", "error");
          } finally {
            // ðŸŸ¢ 2. STOP LOADING (Always runs) ðŸŸ¢
            setTimeout(() => {
                setButtonLoading(saveBtn, false, "Save Profile");
            }, 500);
          }
        });

      // Setup real-time updates
      function setupRealTimeUpdates() {
        // Load requests every 30 seconds when on updates page
        autoRefreshInterval = setInterval(() => {
          if (document.getElementById("updates").classList.contains("active")) {
            loadUserRequests();
          }
        }, 30000);
      }

// Enhanced initialization
      document.addEventListener("DOMContentLoaded", async () => {
        // Check authentication first
        if (!checkAuthentication()) return;

        // ---
        // === STUDENT ID Auto-formatting ===
        // ---
        const studentIdInput = document.getElementById("studentId");
        if (studentIdInput) {
          studentIdInput.addEventListener("input", function (e) {
            let input = e.target.value.replace(/\D/g, ""); // Remove all non-digits
            let formattedInput = "";

            if (input.length > 0) {
              formattedInput = input.substring(0, 3);
            }
            if (input.length > 3) {
              formattedInput += "-" + input.substring(3, 7);
            }
            if (input.length > 7) {
              // 3 digits + 4 digits = 7. Max 6 in last part.
              formattedInput += "-" + input.substring(7, 13);
            }

            e.target.value = formattedInput;
          });
        }
        // ---
        // === END OF BLOCK ===
        // ---

        // Load user data
        const fullname = localStorage.getItem("fullname") || "User";
        const userId = localStorage.getItem("userId") || "N/A";
        if (!fullname || !userId) {
          // Not logged in â†’ back to welcome page
          window.location.href = "/";
          return;
        }

        // Set profile information
        document.getElementById("profileName").textContent = fullname;

        // Check profile status (This will now also show modal if incomplete)
        await checkUserProfileStatus();

        checkNotificationStatus(); // Check for notifications on page load
        setInterval(checkNotificationStatus, 10000); // Check every 10 seconds

        // ---
        // === THIS IS THE FIX (LINE REMOVED) ===
        // === END OF FIX ===
        // ---


        // Setup auto-logout functionality
        setupActivityListeners();

        // Setup real-time updates
        setupRealTimeUpdates();

        // Load initial requests
        await loadUserRequests();

        // Section switching
        const navLinks = document.querySelectorAll(".nav-link");

        navLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const target = link.getAttribute("data-target");
            showSection(target);
          });
        });

        // Navbar scroll effect
        window.addEventListener("scroll", function () {
          const navbar = document.querySelector(".navbar");
          if (window.scrollY > 10) {
            navbar.classList.add("scrolled");
          } else {
            navbar.classList.remove("scrolled");
          }
        });

        // Add logout button functionality
        const logoutBtn = document.querySelector(".btn-outline-danger");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function () {
            logout();
          });
        }

        // Clean up interval when page unloads
        window.addEventListener("beforeunload", () => {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
          }
        });
      });

      // 2. OPEN CATEGORY MODAL LOGIC
function openCategoryModal(category) {
  // Security checks
  if (!checkAuthentication() || !checkSession()) return;

  const container = document.getElementById("categoryItemsContainer");
  const title = document.getElementById("categoryModalTitle");

  // Update Title
  const titles = {
    'academic': 'Academic Records & Grades',
    'certifications': 'Certifications & Status',
    'graduation': 'Graduation & Credentials'
  };
  title.textContent = titles[category] || "Select Document";

  // Filter Data
  const items = Object.entries(servicesData).filter(([key, data]) => data.category === category);

  // Generate Accordion HTML
  let html = '';
  items.forEach(([name, data], index) => {
    const uniqueId = `collapse${index}`;
    // Check if item is already in the list (partial match for notes)
    const isSelected = selectedServicesList.some(s => s.startsWith(name));

    html += `
      <div class="accordion-item mb-2 border rounded shadow-sm">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#${uniqueId}">
            ${name}
            ${isSelected ? '<span class="badge bg-success ms-2"><i class="bi bi-check"></i> Added</span>' : ''}
          </button>
        </h2>
        <div id="${uniqueId}" class="accordion-collapse collapse" data-bs-parent="#categoryItemsContainer">
          <div class="accordion-body">
            <div class="row">
              <div class="col-md-7 border-end">
                <p class="mb-2"><strong>Description:</strong> ${data.description}</p>
                <p class="mb-1 text-muted small"><strong>Requirements:</strong></p>
                <ul class="small text-muted mb-2">
                  ${data.requirements.map(r => `<li>${r.name}</li>`).join('')}
                </ul>
              </div>
              <div class="col-md-5">
                <div class="alert alert-light border">
                  <div class="mb-1"><strong>Fee:</strong> <span class="text-danger">â‚±${data.price.toFixed(2)}</span></div>
                  <div class="mb-0"><strong>Time:</strong> ${data.time}</div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label small fw-bold text-secondary">Optional Note:</label>
                  <input type="text" class="form-control form-control-sm" 
                         id="note-${index}" 
                         placeholder="e.g. Purpose: Scholarship, or Specific Year">
                </div>

                <div class="d-grid">
                  <button class="btn ${isSelected ? 'btn-secondary' : 'btn-primary'}" 
                    onclick="addServiceFromModal('${name}', 'note-${index}')" 
                    ${isSelected ? 'disabled' : ''}>
                    ${isSelected ? 'Already Added' : '<i class="bi bi-plus-circle"></i> Add to Selection'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
  const modal = new bootstrap.Modal(document.getElementById("categoryModal"));
  modal.show();
}

// 3. ADD SERVICE WITH NOTE LOGIC
function addServiceFromModal(serviceName, noteInputId) {
  const noteInput = document.getElementById(noteInputId);
  const note = noteInput ? noteInput.value.trim() : "";

  // Append note to name if it exists: "Service Name [Note: ...]"
  let finalName = serviceName;
  if (note) {
    finalName = `${serviceName} [Note: ${note}]`;
  }

  if (!selectedServicesList.includes(finalName)) {
    selectedServicesList.push(finalName);
    updateSelectedCount();
    
    // UI Feedback
    showToast(`Added: ${finalName}`, "success");
    
    // Refresh the modal content to disable the button
    const currentCategory = servicesData[serviceName].category;
    
    // Close current modal instance then reopen to refresh
    // (Simple way to refresh state)
    const modalEl = document.getElementById("categoryModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    
    setTimeout(() => {
        openCategoryModal(currentCategory);
    }, 300);
  }
}
// ðŸŸ¢ UPDATED: Force 'Declined' to match 'Completed' Layout
// ðŸŸ¢ UPDATED: Force Footer Display (Fixes Missing Info)
async function loadRecentUpdates() {
    const container = document.getElementById('recentUpdatesList');
    if (!container) return;

    try {
        const token = localStorage.getItem('token');
        if (!token) return;

        const response = await fetch('/api/student/updates', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();

        if (result.success && result.updates && result.updates.length > 0) {
            container.innerHTML = result.updates.map(update => {
                let statusIcon = '';
                let statusTitle = '';
                let statusDesc = '';

                // ðŸŸ¢ FIX: Use Fallbacks so it NEVER hides
                const staffName = update.processed_by || "Registrar Staff";
                const windowName = update.window_number ? `Window ${update.window_number}` : "Registrar Office";

                // ðŸŸ¢ THE FOOTER HTML (Always Visible for certain statuses)
                const footerHtml = `
                    <div class="mt-2 small text-muted border-top pt-2 d-flex align-items-center">
                         <i class="bi bi-person-badge-fill me-2"></i> 
                         <span class="fw-bold me-2">${staffName}</span> 
                         <span class="badge bg-light text-dark border">${windowName}</span>
                    </div>`;

                switch (update.status) {
                    case 'waiting':
                    case 'pending':
                         statusIcon = '<div class="update-icon bg-secondary text-white"><i class="bi bi-clock"></i></div>';
                         statusTitle = 'Request Pending';
                         statusDesc = 'Your request is waiting for admin review.';
                         break;
                    case 'reviewing':
                         statusIcon = '<div class="update-icon bg-warning text-dark"><i class="bi bi-search"></i></div>';
                         statusTitle = 'Under Review';
                         statusDesc = 'The admin is currently reviewing your submitted requirements.';
                         break;
                    case 'processing':
                         statusIcon = '<div class="update-icon bg-primary text-white"><i class="bi bi-gear-fill"></i></div>';
                         statusTitle = 'Processing';
                         statusDesc = 'Your request has been approved and is now being processed.';
                         break;
                    case 'completed':
                    case 'claimed':
                        statusIcon = '<div class="update-icon bg-success text-white"><i class="bi bi-check-circle-fill"></i></div>';
                        statusTitle = 'Completed';
                        statusDesc = 'Transaction finished. Document has been claimed.';
                        break;
                    case 'cancelled':
                    case 'declined':
                        statusIcon = '<div class="update-icon bg-danger text-white"><i class="bi bi-x-circle-fill"></i></div>';
                        statusTitle = 'Request Declined';
                        statusDesc = update.decline_reason 
                            ? `<span class="text-danger fw-bold">Reason:</span> ${update.decline_reason}` 
                            : 'Your request was cancelled by the admin.';
                        break;
                    default:
                        statusIcon = '<div class="update-icon bg-light text-muted"><i class="bi bi-question-circle"></i></div>';
                        statusTitle = 'Status Updated';
                        statusDesc = `Current status: ${update.status}`;
                }

                const timeString = new Date(update.submitted_at).toLocaleDateString();

                // ðŸŸ¢ Logic: Show footer for Processed, Completed, OR Declined
                const showFooter = ['processing', 'completed', 'claimed', 'cancelled', 'declined'].includes(update.status);

                return `
                <div class="update-item animate__animated animate__fadeIn">
                    ${statusIcon}
                    <div class="update-content w-100">
                        <div class="d-flex justify-content-between">
                            <h4 class="update-title mb-1">${statusTitle}</h4>
                            <small class="text-muted" style="font-size: 0.75rem;">${timeString}</small>
                        </div>
                        <div class="update-desc mb-1">${statusDesc}</div>
                        ${showFooter ? footerHtml : ''}
                    </div>
                </div>`;
            }).join('');
        } else {
            container.innerHTML = `<div class="text-center py-4 text-muted">No recent updates.</div>`;
        }
    } catch (error) {
        console.error('Error loading updates:', error);
    }
}
// Initialize everything when DOM is ready
document.addEventListener("DOMContentLoaded", () => {
  console.log("Dashboard initialized"); // Debug log

  // Initialize services manager
  window.servicesManager = new ServicesManager();

  // Load initial data
  fetchUserProfile();
  
  // ðŸŸ¢ ADD THIS LINE HERE ðŸŸ¢
  loadRecentUpdates(); 

  // Setup navigation
  setupNavigation();

  // Setup sidebar toggle
  const sidebarToggle = document.getElementById("sidebarToggle");
  if (sidebarToggle) {
    sidebarToggle.addEventListener("click", () => {
      document.querySelector(".sidebar").classList.toggle("active");
    });
  }

  // Close sidebar when clicking outside on mobile
  document.addEventListener("click", (e) => {
    const sidebar = document.querySelector(".sidebar");
    const toggle = document.getElementById("sidebarToggle");
    if (
      window.innerWidth <= 768 &&
      sidebar.classList.contains("active") &&
      !sidebar.contains(e.target) &&
      e.target !== toggle
    ) {
      sidebar.classList.remove("active");
    }
  });
  
  // ðŸŸ¢ OPTIONAL: Auto-refresh updates every 5 seconds
  setInterval(loadRecentUpdates, 5000);
});

    </script>
  </body>
</html>
