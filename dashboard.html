<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RSU REQS - Dashboard</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="/assets/css/dashboard.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <style>
      /* Enhanced styles for better UX */
      .service-card {
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative; /* This is required for the counter */
      }

      /* This is the new counter badge style */
      .service-counter {
        position: absolute;
        top: 12px;
        right: 12px;
        background-color: #6c757d; /* Bootstrap 'secondary' gray */
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        line-height: 1;
        z-index: 2; /* Sits on top of the card content */
      }

      .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .service-card.selected {
        border: 2px solid #007bff;
        background-color: #f8f9fa;
      }

      .queue-status-badge {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 12px;
      }

      .status-approved {
        background: #28a745;
        color: white;
      }

      .status-pending {
        background: #ffc107;
        color: black;
      }

      .status-declined {
        background: #dc3545;
        color: white;
      }

      .status-processing {
        background: #17a2b8;
        color: white;
      }

      .status-completed {
        background: #6f42c1;
        color: white;
      }

      .real-time-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .queue-number-display {
        /* center the content */
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
      }

      .queue-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
      }

      .profile-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .nav-item .notification-dot {
    position: absolute;
    top: 10px; /* Adjust as needed */
    right: 10px; /* Adjust as needed */
    width: 10px;
    height: 10px;
    background-color: #0d6efd; /* Bootstrap 'primary' blue */
    border-radius: 50%;
    border: 2px solid #fff; /* Makes it look clean on the green bg */
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
  /* --- Notification Toast Styles --- */
      .notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        animation: slideInRight 0.3s ease-out forwards;
        border-left: 5px solid;
        font-family: "Poppins", sans-serif;
      }

      .toast-info {
        border-left-color: #0d6efd; /* Blue for info */
      }

      .toast-success {
        border-left-color: #198754; /* Green for success */
      }

      .toast-error {
        border-left-color: #dc3545; /* Red for error */
      }

      .toast-icon {
        margin-right: 15px;
        font-size: 1.2rem;
      }

      .toast-info .toast-icon { color: #0d6efd; }
      .toast-success .toast-icon { color: #198754; }
      .toast-error .toast-icon { color: #dc3545; }
    </style>
  </head>

  <body>
    <!-- for serviceCConfirmationModal - make it have a button to if user wants to add the service or not, so basically the modal just shows the more info about that service-->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold" id="categoryModalTitle">Select Document</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body bg-light">
        <div class="alert alert-info small">
          <i class="bi bi-info-circle me-1"></i> 
          Click on a document name below to expand details, view fees, and add an optional note.
        </div>
        
        <div id="categoryItemsContainer" class="accordion">
          </div>
      </div>
    </div>
  </div>
</div>
    <div
      class="modal fade"
      id="serviceConfirmationModal"
      tabindex="-1"
      aria-labelledby="serviceConfirmationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="serviceConfirmationModalLabel">
              <i class="bi bi-info-circle me-2 text-primary"></i> Service
              Information
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p id="serviceDescription">Service description goes here...</p>
            <p><strong>Fee:</strong> <span id="serviceFee">₱0.00</span></p>
            <h6 class="fw-bold">Requirements:</h6>
            <ul id="serviceRequirements">
              <li>Requirement 1</li>
              <li>Requirement 2</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="confirmAddServiceBtn"
            >
              Add Service
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Selected Services Modal -->
    <div
      class="modal fade"
      id="selectedModal"
      tabindex="-1"
      aria-labelledby="selectedModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="selectedModalLabel">
              <i class="bi bi-pencil-square me-2 text-primary"></i> Selected
              Services
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <div class="row">
              <!-- Left Column: Services -->
              <div class="col-md-6">
                <h6 class="fw-bold mb-2">Services</h6>
                <ul
                  id="selectedServicesList"
                  class="list-group list-group-flush"
                ></ul>
              </div>

              <!-- Right Column: Requirements -->
              <div class="col-md-6">
                <h6 class="fw-bold mb-2">Check List of Requirements</h6>
                <div id="requirementsList"></div>
              </div>
            </div>
          </div>

          <div class="modal-footer flex-column">
            <div class="w-100 d-flex justify-content-between">
              <span class="fw-bold"
                >Total amount: <span id="totalAmount">₱0.00</span></span
              >
            </div>
            <button id="joinQueueBtn" class="btn btn-success w-100 mt-2">
              Join Queue Now
            </button>
          </div>
        </div>
      </div>
    </div>

<div
      class="modal fade"
      id="profileUpdateModal"
      data-bs-backdrop="static" 
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="profileUpdateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="profileUpdateModalLabel">
              <i class="bi bi-person-check me-2 text-primary"></i> Complete Your
              Profile
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i> Please complete your
              profile information before joining the queue.
            </div>

            <form id="profileUpdateForm">
              <h6 class="fw-bold mb-3 mt-0">Personal Information</h6>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="lastName" class="form-label required-field"
                    >Last Name</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="lastName"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="firstName" class="form-label required-field"
                    >First Name</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="firstName"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="middleName" class="form-label">Middle Name</label>
                  <input type="text" class="form-control" id="middleName" />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="gender" class="form-label required-field"
                    >Gender</label
                  >
                  <select class="form-select" id="gender" required>
                    <option value="" selected disabled>Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="phone" class="form-label required-field"
                    >Phone Number</label
                  >
                  <input
                    type="tel"
                    class="form-control"
                    id="phone"
                    required
                    placeholder="+639..."
                  />
                  <div class="form-text">
                    Use the same number from registration.
                  </div>
                </div>
              </div>

              <h6 class="fw-bold mb-3 mt-4">Academic Information</h6>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="studentId" class="form-label required-field"
                    >Student ID</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="studentId"
                    required
                    placeholder="000-0000-000000"
                    maxlength="15"
                  />
                  <div class="form-text">
                    Format: 000-0000-000000
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="program" class="form-label required-field"
                    >Program</label
                  >
                  <select class="form-select" id="program" required>
                    <option value="" selected disabled>Select Program</option>
                    <option value="BS Computer Science">
                      BS Computer Science
                    </option>
                    <option value="BS Information Technology">
                      BS Information Technology
                    </option>
                    <option value="BS Business Administration">
                      BS Business Administration
                    </option>
                    <option value="BS Education">BS Education</option>
                    <option value="BS Engineering">BS Engineering</option>
                    <option value="BS Nursing">BS Nursing</option>
                    <option value="BS Accountancy">BS Accountancy</option>
                    <option value="BS Psychology">BS Psychology</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3 align-items-center">
                <div class="col-md-6">
                  <label for="schoolIdPicture" class="form-label required-field"
                    >School ID Picture (Front)</label
                  >
                  <input
                    type="file"
                    class="form-control"
                    id="schoolIdPicture"
                    accept="image/*"
                  />
                  <div class="form-text">
                    Upload a clear picture of your School ID.
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">ID Preview:</label>
                  <div
                    id="schoolIdPicturePreview"
                    class="mt-1"
                    style="
                      width: 150px;
                      height: 95px;
                      overflow: hidden;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                      display: none;
                      background: #f8f9fa;
                    "
                  >
                    <img
                      src=""
                      alt="ID Preview"
                      style="
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        display: block;
                      "
                    />
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="major" class="form-label"
                    >Major (if applicable)</label
                  >
                  <input type="text" class="form-control" id="major" />
                </div>
                <div class="col-md-6">
                  <label for="yearLevel" class="form-label required-field"
                    >Year Level</label
                  >
                  <select class="form-select" id="yearLevel" required>
                    <option value="" selected disabled>
                      Select Year Level
                    </option>
                    <option value="1st Year">1st Year</option>
                    <option value="2nd Year">2nd Year</option>
                    <option value="3rd Year">3rd Year</option>
                    <option value="4th Year">4th Year</option>
                    <option value="5th Year">5th Year</option>
                    <option value="Graduate">Graduate</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="schoolYear" class="form-label required-field"
                    >School Year</label
                  >
                  <select class="form-select" id="schoolYear" required>
                    <option value="" selected disabled>
                      Select School Year
                    </option>
                    <option value="2023-2024">2023-2024</option>
                    <option value="2024-2025">2024-2025</option>
                    <option value="2025-2026">2025-2026</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="yearGraduated" class="form-label"
                    >Year Graduated (if applicable)</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="yearGraduated"
                    min="2000"
                    max="2030"
                    placeholder="e.g. 2024"
                  />
                </div>
              </div>

              <h6 class="fw-bold mb-3 mt-4">Additional Information</h6>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="campus" class="form-label required-field"
                    >Campus/College</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="campus"
                    placeholder="e.g. Main Campus, CAS, etc."
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="dob" class="form-label required-field"
                    >Date of Birth</label
                  >
                  <input type="date" class="form-control" id="dob" required />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="pob" class="form-label required-field"
                    >Place of Birth</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="pob"
                    placeholder="City, Province"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="nationality" class="form-label required-field"
                    >Nationality</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="nationality"
                    placeholder="e.g. Filipino"
                    required
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-12">
                  <label for="home_address" class="form-label required-field"
                    >Home Address</label
                  >
                  <textarea
                    class="form-control"
                    id="home_address"
                    rows="2"
                    placeholder="Street, Barangay, City/Municipality, Province"
                    required
                  ></textarea>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-12">
                  <label for="previous_school" class="form-label"
                    >Previous School Attended (if applicable)</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="previous_school"
                    placeholder="Name of last school attended"
                  />
                </div>
              </div>
              <h6 class="fw-bold mb-3 mt-4">Education Background</h6>
          <div class="row mb-3">
            <div class="col-12">
              <label for="primary_school" class="form-label required-field"
                >Primary (Elementary)</label
              >
              <input
                type="text"
                class="form-control"
                id="primary_school"
                placeholder="Name of your primary/elementary school"
                required
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12">
              <label for="secondary_school" class="form-label required-field"
                >Secondary (High School)</label
              >
              <input
                type="text"
                class="form-control"
                id="secondary_school"
                placeholder="Name of your secondary/high school"
                required
              />
            </div>
          </div>

              <h6 class="fw-bold mb-3 mt-4">Contact Information</h6>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="email" class="form-label required-field"
                    >Email Address</label
                  >
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    required
                    placeholder="example@gmail.com"
                  />
                  <div class="form-text">
                    Use the same email from registration.
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveProfileBtn">
              Save Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    
    <div id="feedbackModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title"><i class="bi bi-star-fill me-2"></i> Service Feedback</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="feedbackRequestId">
            
            <div class="mb-4 text-center">
              <label class="form-label fw-bold d-block">SQD 0. I am satisfied with the service that I availed.</label>
              <div class="rating-stars h2 text-warning" style="cursor: pointer;">
                <i class="bi bi-star" data-value="1" onclick="setRating(1)"></i>
                <i class="bi bi-star" data-value="2" onclick="setRating(2)"></i>
                <i class="bi bi-star" data-value="3" onclick="setRating(3)"></i>
                <i class="bi bi-star" data-value="4" onclick="setRating(4)"></i>
                <i class="bi bi-star" data-value="5" onclick="setRating(5)"></i>
              </div>
              <input type="hidden" id="sqd0Rating" value="0">
              <div id="ratingText" class="text-muted small">Tap a star to rate</div>
            </div>

            <hr>

            <h6 class="fw-bold">Service Quality Dimensions</h6>
            <p class="small text-muted">Please check if you Agree/Disagree with the following:</p>
            
            <div id="sqdQuestions">
              </div>

            <hr>
            <div class="mb-3">
              <label class="form-label fw-bold">Comments / Complaints / Suggestions</label>
              <textarea class="form-control" id="feedbackComments" rows="3" placeholder="Describe your overall experience..."></textarea>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" onclick="submitFeedback()">Submit Feedback</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="d-flex flex-grow-1 justify-content-center align-items-center margin-auto"
    >
      <div class="card-custom">
        <nav class="navbar navbar-expand-lg navbar-dark">
          <div class="container-fluid navbar-container">
            <!-- Brand (Logo + Text) -->
            <a class="navbar-brand" href="#">
              <img
                src="../assets/img/updated_RegistrarLogo.jpg"
                alt="Admission, Registration, and Scholarship & Grants Office"
                class="me-2"
              />
              <span class="info text-white fw-bold">
                RSU REQS
                <!-- <p id="welcome" style="font-size: 15px;">Welcome!</p>
                            <p id="info" style="font-size: 15px;"></p> -->
              </span>
            </a>

            <!-- Modern Mobile Toggler -->
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarNav"
              aria-controls="navbarNav"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar Links -->
            <div
              class="collapse navbar-collapse justify-content-end"
              id="navbarNav"
            >
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link active" href="#" data-target="home">
                    <i class="bi bi-house-door me-1"></i> Home
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-target="services">
                    <i class="bi bi-list-check me-1"></i> Services
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-target="docs">
                    <i class="bi bi-file-earmark-pdf me-1"></i> Docs
                  </a>
                </li>
                <li class="nav-item" style="position: relative;">
              <a class="nav-link" href="#" data-target="updates">
                <i class="bi bi-megaphone me-1"></i> Updates
              </a>
              <span class="notification-dot" id="updates-notification-dot" style="display: none;"></span>
            </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-target="profile">
                    <i class="bi bi-person-circle me-1"></i> Profile
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <!-- Home Section -->
        <div id="home" class="section active">
          <div class="home-content">
            <!-- Queue Number Display (shown when user has active queue) -->
            <div
              id="queueNumberDisplay"
              class="queue-number-display"
              style="display: none"
            >
              <h4>Your Current Queue Number</h4>
              <div class="queue-number" id="currentQueueNumber">A-001</div>
              <p id="queueStatusMessage">Waiting for approval</p>
            </div>

            <div class="text-center">
              <h2>Registrar's Office Services</h2>
              <p>
                Select the service you need from the Registrar's Office. <br />
                Queue numbers will be assigned automatically based on current
                demand.
              </p>
            </div>

            <!-- Profile Warning (shown when profile incomplete) -->
            <div
              id="profileWarning"
              class="profile-warning"
              style="display: none"
            >
              <div class="d-flex align-items-center">
                <i
                  class="bi bi-exclamation-triangle-fill me-3 text-warning"
                  style="font-size: 1.5rem"
                ></i>
                <div>
                  <h5 class="mb-1">Complete Your Profile</h5>
                  <p class="mb-0">
                    You need to complete your profile before submitting service
                    requests.
                  </p>
                </div>
                <button
                  class="btn btn-warning ms-auto"
                  onclick="showProfileUpdateModal()"
                >
                  Complete Profile
                </button>
              </div>
            </div>
            <div class="text-center mt-4" id="homeActionBtnContainer">
              <button
                id="viewServicesBtn"
                class="btn btn-primary btn-lg"
                style="display: none"
                onclick="showSection('services')"
              >
                <i class="bi bi-list-check me-1"></i> View Services
              </button>
            </div>
            <div class="container mt-5">
              <div class="row">
                <div class="col-md-6">
                  <div class="card mb-4">
                    <div
                      class="card-header bg-dark text-white fw-bold text-center"
                    >
                      REMINDERS
                    </div>
                    <div class="card-body">
                      <ol class="list-unstyled">
                        <li>
                          <p>
                            Under existing laws, only the record owner may
                            request or claim documents related to their school
                            records. To verify the identity of the requester or
                            claimant, one (1) valid ID must be presented when
                            requesting or claiming documents. Acceptable IDs
                            include: Student ID, PhilHealth ID, National ID,
                            Police Clearance, Driver's License, Passport, UMID,
                            PRC ID, Voter's ID, Postal ID, TIN ID, or any valid
                            ID with the requester's or claimant's photo and
                            signature.
                          </p>
                        </li>
                        <li>
                          <p>
                            RSU reserves the right to deny or cancel any
                            document request due to incomplete requirements or
                            pending accountabilities.
                          </p>
                        </li>
                        <li>
                          <p>
                            When claiming documents, present the claim stub
                            along with the Official Receipt and a valid ID. If a
                            representative will pick up the documents, they must
                            present an authorization letter and a valid ID.
                          </p>
                        </li>
                      </ol>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card mb-4">
                    <div
                      class="card-header bg-dark text-white fw-bold text-center"
                    >
                      PROCEDURES
                    </div>
                    <div class="card-body">
                      <ol class="list-unstyled">
                        <li>
                          <p>
                            <strong>Obtain and Fill-Out the Form:</strong>
                            Secure this form from the Registration Unit. Ensure
                            all required fields are properly filled out.
                          </p>
                        </li>
                        <li>
                          <p>
                            <strong>Make payment:</strong> Visit the Cashier's
                            Office to pay the fee for the documents.
                          </p>
                        </li>
                        <li>
                          <p>
                            <strong>Return to the Registration Unit:</strong>
                            After payment, submit this form to the Registration
                            Unit for student record verification and other
                            instructions.
                          </p>
                        </li>
                        <li>
                          <p>
                            <strong>Submit Lacking Documents:</strong> If
                            notified of any lacking documents, provide them to
                            complete your request.
                          </p>
                        </li>
                        <li>
                          <p>
                            <strong>Collect the Claim Stub:</strong> Once
                            verification is complete, receive the claim stub
                            from the Registration Unit.
                          </p>
                        </li>
                        <li>
                          <p>
                            <strong>Pick Up Your Documents:</strong> On the date
                            indicated on your claim stub, return to the
                            Registration Unit to collect your documents.
                          </p>
                        </li>
                      </ol>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="container mt-5 mb-5">
            <div class="card">
              <div
                class="card-header bg-dark text-white fw-bold text-center py-3"
              >
                PROCESSING FEE AND TIME
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-bordered table-striped mb-0">
                    <thead>
                      <tr>
                        <th scope="col">Document Type</th>
                        <th scope="col">Document Fee</th>
                        <th scope="col">Processing Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>CAV Graduate/ Undergraduate</td>
                        <td>25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td>Certificate of Upper 25</td>
                        <td>25.00</td>
                        <td>14 working days</td>
                      </tr>
                      <tr>
                        <td>Certificate of Graduation</td>
                        <td>25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td>Certificate of Honors/ PD907</td>
                        <td>25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td>Certificate of Grades</td>
                        <td>25.00</td>
                        <td>7 working days</td>
                      </tr>
                      <tr>
                        <td>Certificate of Enrolment</td>
                        <td>25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td>Certificate of Units Earned</td>
                        <td>25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td>
                          Certificate of English as a Medium of Instruction
                        </td>
                        <td>25.00</td>
                        <td>5 working days</td>
                      </tr>
                      <tr>
                        <td>Transcript of Records (Duplicate Copy)</td>
                        <td>40.00/page</td>
                        <td>7 working days</td>
                      </tr>
                      <tr>
                        <td>Diploma (Duplicate Copy)</td>
                        <td>100.00</td>
                        <td>1 month</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

<div id="services" class="section">
  <div class="home-content">
    <div class="text-center mb-5">
      <h2>Select a Category</h2>
      <p class="text-muted">Choose a category below to find the specific document you need.</p>
    </div>

    <div class="row justify-content-center g-4">
      <div class="col-md-4">
        <div class="card h-100 service-category-card text-center p-4 shadow-sm" 
             style="cursor: pointer; transition: transform 0.2s;"
             onclick="openCategoryModal('academic')"
             onmouseover="this.style.transform='scale(1.03)'"
             onmouseout="this.style.transform='scale(1)'">
          <div class="mb-3">
            <i class="bi bi-journal-bookmark-fill text-primary" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold">Academic Records & Grades</h4>
          <p class="text-muted small">Transcript of Records, Certificate of Grades, Units Earned</p>
          <button class="btn btn-outline-primary btn-sm mt-3">Select Documents</button>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100 service-category-card text-center p-4 shadow-sm"
             style="cursor: pointer; transition: transform 0.2s;"
             onclick="openCategoryModal('certifications')"
             onmouseover="this.style.transform='scale(1.03)'"
             onmouseout="this.style.transform='scale(1)'">
          <div class="mb-3">
            <i class="bi bi-patch-check-fill text-success" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold">Certifications & Status</h4>
          <p class="text-muted small">Enrollment, Honors, Class Ranking, Medium of Instruction</p>
          <button class="btn btn-outline-success btn-sm mt-3">Select Documents</button>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100 service-category-card text-center p-4 shadow-sm"
             style="cursor: pointer; transition: transform 0.2s;"
             onclick="openCategoryModal('graduation')"
             onmouseover="this.style.transform='scale(1.03)'"
             onmouseout="this.style.transform='scale(1)'">
          <div class="mb-3">
            <i class="bi bi-mortarboard-fill text-warning" style="font-size: 3.5rem;"></i>
          </div>
          <h4 class="fw-bold">Graduation & Credentials</h4>
          <p class="text-muted small">Diploma, Graduation Cert, CAV, Transfer Credentials</p>
          <button class="btn btn-outline-warning btn-sm mt-3">Select Documents</button>
        </div>
      </div>
    </div>

    <div class="hero-buttons mt-5 text-center">
      <button class="btn btn-custom btn-lg px-5" onclick="viewSelectedServices()">
        <i class="bi bi-basket me-2"></i> View Selected Items
        <span id="selectedCountBadge" class="badge bg-danger ms-2" style="display: none">0</span>
      </button>
    </div>
  </div>
</div>



        <!-- Docs Section -->
        <div id="docs" class="section">
          <div class="home-content">
            <div class="text-center">
              <h2>Forms & Documents</h2>
              <p>
                Download and print the forms you need for your requested
                services.
              </p>
            </div>
            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                Transcript of Records Request Form
              </h4>
              <p>Use this form to request your official academic transcript.</p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>

            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i> Add/Drop
                Form
              </h4>
              <p>
                Use this form to add or drop subjects from your current
                enrollment.
              </p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>

            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                Completion Form
              </h4>
              <p>
                Use this form to request completion of grades for your courses.
              </p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>

            <div class="update-card">
              <h4>
                <i class="bi bi-file-earmark-pdf text-danger me-2"></i> Diploma
                Request Form
              </h4>
              <p>Use this form to request issuance of your diploma.</p>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download me-1"></i> Download PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Updates Section -->
        <div id="updates" class="section">
          <div class="home-content">
            <div class="text-center mb-4">
              <h2>Your Service Requests</h2>
              <p>Track the status of your requested services in real-time.</p>
              <button
                class="btn btn-outline-primary btn-sm"
                onclick="loadUserRequests()"
              >
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
              </button>
            </div>
            <div class="mb-3 px-3">
            <label for="serviceFilter" class="form-label fw-bold">Filter by Service:</label>
            <select class="form-select" id="serviceFilter" onchange="filterRequests()">
              <option value="all" selected>All Services</option>
              <option value="Transcript of Records">Issuance of Transcript of Records</option>
              <option value="Completion Grade Form">Issuance of Completion Grade Form</option>
              <option value="Diploma Issuance">Issuance of Diploma</option>
              <option value="Issuance of Transfer Credentials">Issuance of Transfer Credentials</option>
            </select>
          </div>

            <!-- Real-time status indicators -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-primary" id="totalRequests">
                    0
                  </div>
                  <div class="stat-label">Total Requests</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-warning" id="pendingRequests">
                    0
                  </div>
                  <div class="stat-label">Pending</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-success" id="approvedRequests">
                    0
                  </div>
                  <div class="stat-label">Approved</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center">
                  <div class="stat-number text-info" id="processingRequests">
                    0
                  </div>
                  <div class="stat-label">Processing</div>
                </div>
              </div>
            </div>

            <div id="requestsContainer">
              <!-- Requests will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="profile" class="section">
          <div class="home-content">
            <h2 class="mb-4">Your Profile</h2>

            <div class="alert-profile" id="profilePageWarning" style="display: none;">
          <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>
          <strong>Profile Incomplete</strong> - Please update your profile information to access all features.
        </div>
            <div class="profile-card">
              <div class="profile-header">
                <div class="profile-avatar" id="profileAvatarInitials">JS</div>
                <div class="profile-info">
                  <h3 id="profileName">John Smith</h3>
                  <p class="text-muted" id="profileEmail"></p>
                </div>
              </div>

              <div class="profile-details">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Full Name:</strong>
                    <span id="profileNameDisplay">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Gender:</strong>
                    <span id="profileGender">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Student ID:</strong>
                    <span id="profileStudentId">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Phone:</strong>
                    <span id="profilePhone">+63 912 345 6789</span>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Course:</strong>
                    <span id="profileCourse">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Year Level:</strong>
                    <span id="profileYear">Not set</span>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>School Year:</strong>
                    <span id="profileSchoolYear">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Year Graduated:</strong>
                    <span id="profileYearGraduated">N/A</span>
                  </div>
                </div>
                <hr />
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Campus/College:</strong>
                    <span id="profileCampus">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Date of Birth:</strong>
                    <span id="profileDob">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Place of Birth:</strong>
                    <span id="profilePob">Not set</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Nationality:</strong>
                    <span id="profileNationality">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-12">
                    <strong>Home Address:</strong>
                    <span id="profileHomeAddress">Not set</span>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-12">
                    <strong>Previous School:</strong>
                    <span id="profilePreviousSchool">N/A</span>
                  </div>
            </div>
            <hr />
            <div class="row mb-3">
              <div class="col-12">
                <strong>Primary (Elementary):</strong>
                <span id="profilePrimarySchool">Not set</span>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                <strong>Secondary (High School):</strong>
                <span id="profileSecondarySchool">Not set</span>
              </div>
            </div>

            <div class="profile-id-preview" id="profileIdPictureContainer" style="display: none; margin-top: 20px; text-align: center;">
              <h6 class="fw-bold">Your School ID</h6>
              <div style="max-width: 250px; border: 1px solid #ddd; border-radius: 8px; padding: 5px; background: #f9f9f9; margin: 0 auto;">
                <img id="profileIdPicture" src="" alt="School ID Preview" style="width: 100%; height: auto; border-radius: 5px;">
              </div>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                  <div class="stat-number" id="profileStatTotal">0</div>
                  <div class="stat-label">Services Requested</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="profileStatCompleted">0</div>
                  <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="profileStatInProgress">0</div>
                  <div class="stat-label">In Progress</div>
                </div>
              </div>

              <div class="mt-4">
                <button
                  class="btn btn-primary me-2"
                  onclick="showProfileUpdateModal()"
                >
                  <i class="bi bi-pencil me-1"></i> Update Profile
                </button>
                <button class="btn btn-outline-danger">
                  <i class="bi bi-box-arrow-right me-1"></i> Logout
                </button>
              </div>
            </div>

            <!-- Profile Update Form (visible when editing) -->
            <div
              id="profileUpdateFormSection"
              class="profile-update-form"
              style="display: none"
            >
              <h4 class="mb-4">Update Your Profile</h4>
              <form id="inlineProfileForm">
                <!-- Form content would go here -->
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="/assets/js/dashboard.js"></script> -->

    <script>
      // ===== AUTHENTICATION CHECK =====
      function checkAuthentication() {
        const userId = localStorage.getItem("userId");
        if (!userId) {
          // Not logged in → redirect to welcome page
          window.location.href = "/";
          return false;
        }
        return true;
      }

      // ===== UTILITY FUNCTIONS =====

      // Auto logout functionality for security
      let inactivityTimer;

      function resetInactivityTimer() {
        // Clear existing timer
        clearTimeout(inactivityTimer);

        // Set new timer (30 minutes = 1800000 ms)
        inactivityTimer = setTimeout(logout, 1800000); // 30 minutes
      }

      function logout() {
        // Remove user data from localStorage
        localStorage.removeItem("fullname");
        localStorage.removeItem("userId");
        localStorage.removeItem("userPhone");
        localStorage.removeItem("userEmail");
        localStorage.removeItem("loginTime");

        // Redirect to login page
        window.location.href = "/login";
      }

      function setupActivityListeners() {
        // Reset timer on any of these events
        const events = [
          "mousedown",
          "mousemove",
          "keypress",
          "scroll",
          "touchstart",
        ];

        events.forEach((event) => {
          document.addEventListener(event, resetInactivityTimer);
        });

        // Initialize the timer
        resetInactivityTimer();
      }

      // Check session function
      function checkSession() {
        const loginTime = localStorage.getItem("loginTime");
        const now = new Date().getTime();
        const sessionDuration = 30 * 60 * 1000; // 30 minutes in milliseconds

        if (loginTime && now - loginTime > sessionDuration) {
          logout();
          return false;
        }
        return true;
      }
      // --- NEW: Function to check for unread notifications ---
async function checkNotificationStatus() {
  const userId = localStorage.getItem("userId");
  if (!userId) return;

  try {
    const response = await fetch(
      `/api/user/notifications-status?userId=${userId}`
    );
    const data = await response.json();

    const dot = document.getElementById("updates-notification-dot");
    if (data.success && data.hasUnread) {
      if (dot) dot.style.display = "block";
    } else {
      if (dot) dot.style.display = "none";
    }
  } catch (error) {
    console.error("Error checking notifications:", error);
  }
}

      // Show profile update modal function
      // Show profile update modal function
      function showProfileUpdateModal() {
        // This function now calls loadUserProfile() to pre-fill all fields
        // from the database before showing the modal.
        loadUserProfile();
      }

      // Enhanced profile modal with callback
      function showProfileUpdateModalWithCallback(callback) {
        const modal = new bootstrap.Modal(
          document.getElementById("profileUpdateModal")
        );

        // Store callback for after profile save
        window.profileSaveCallback = callback;

        // Pre-fill phone and email from localStorage
        const phone = localStorage.getItem("userPhone") || "";
        const email = localStorage.getItem("userEmail") || "";

        document.getElementById("phone").value = phone;
        document.getElementById("email").value = email;

        modal.show();
      }

      // Show service confirmation modal function
      function showServiceConfirmationModal(serviceName) {
        // Check if service is already selected
        if (selectedServicesList.includes(serviceName)) {
          showAlert("This service is already in your selected list.", "info");
          return; // Don't show the modal if already added
        }

        const service = servicesData[serviceName];

        // --- THIS IS THE NEW LINE ---
        document.getElementById(
          "serviceConfirmationModalLabel"
        ).innerHTML = `<i class="bi bi-info-circle me-2 text-primary"></i> ${serviceName}`;
        // --- END NEW LINE ---

        document.getElementById("serviceDescription").textContent =
          service.description;
        document.getElementById("serviceRequirements").innerHTML =
  service.requirements.map((r) => `<li>${r.name}</li>`).join("");
        document.getElementById("serviceFee").textContent = service.price
          ? `₱${service.price.toFixed(2)}`
          : "N/A";

        // Update confirm button
        const confirmBtn = document.getElementById("confirmAddServiceBtn");
        confirmBtn.onclick = function () {
          // This function handles the actual "add" logic
          const addServiceAction = () => {
            // Double-check it wasn't added in the meantime (unlikely, but safe)
            if (!selectedServicesList.includes(serviceName)) {
              selectedServicesList.push(serviceName);
              updateSelectedCount(); // <-- THIS is where count is updated
              refreshModal();

              // Add visual feedback to the card
              const serviceCard = document.querySelector(
                `.service-card[onclick="selectService('${serviceName}')"]`
              );
              if (serviceCard) {
                serviceCard.classList.add("selected");
              }
            }

            // Hide this modal
            const serviceModal = bootstrap.Modal.getInstance(
              document.getElementById("serviceConfirmationModal")
            );
            serviceModal.hide();

            // Auto-show 'View Selected Services' modal if it's the first item
            if (selectedServicesList.length === 1 && userProfileComplete) {
              viewSelectedServices();
            }
          };

          if (!userProfileComplete) {
            // Show profile modal first
            const serviceModal = bootstrap.Modal.getInstance(
              document.getElementById("serviceConfirmationModal")
            );
            serviceModal.hide();
            showProfileUpdateModalWithCallback(addServiceAction); // Pass the action as a callback
          } else {
            // Profile is complete, just run the add action
            addServiceAction();
          }
        };

        const modal = new bootstrap.Modal(
          document.getElementById("serviceConfirmationModal")
        );
        modal.show();
      }

// Update profile display
      function updateProfileDisplay(user) {
        // NEW: Update name fields in the modal for editing
        const avatar = document.getElementById("profileAvatarInitials");
        if (avatar && user.first_name && user.last_name) {
          // Get first letter of last name (e.g., "M" from "Mantes")
          const lastNameInitial = user.last_name.charAt(0);
          // Get first letter of first name (e.g., "V" from "Vuns")
          const firstNameInitial = user.first_name.charAt(0);
          
          // Combine them and set the text
          avatar.textContent = (lastNameInitial + firstNameInitial).toUpperCase();
        }
        if (user.first_name)
          document.getElementById("firstName").value = user.first_name;
        if (user.last_name)
          document.getElementById("lastName").value = user.last_name;
        if (user.middle_name)
          document.getElementById("middleName").value = user.middle_name;
        if (user.gender) document.getElementById("gender").value = user.gender;

        // NEW: Update profile display
        if (user.fullname) {
          document.getElementById("profileName").textContent = user.fullname;
          document.getElementById("profileNameDisplay").textContent =
            user.fullname;
        }
        if (user.gender)
          document.getElementById("profileGender").textContent = user.gender;

        // Existing fields
        if (user.student_id)
          document.getElementById("profileStudentId").textContent =
            user.student_id;
        if (user.course)
          document.getElementById("profileCourse").textContent = user.course;
        if (user.year_level)
          document.getElementById("profileYear").textContent = user.year_level;
        if (user.school_year)
          document.getElementById("profileSchoolYear").textContent =
            user.school_year;
        if (user.year_graduated) {
          document.getElementById("profileYearGraduated").textContent =
            user.year_graduated;
        } else {
          document.getElementById("profileYearGraduated").textContent = "N/A";
        }

        // Update phone and email display in profile section
        if (user.phone)
          document.getElementById("profilePhone").textContent = user.phone;
        if (user.email)
          document.getElementById("profileEmail").textContent = user.email;

        // Also update email in the modal
        if (user.email) document.getElementById("email").value = user.email;

        // --- ADDED NEW FIELDS ---
        document.getElementById("profileCampus").textContent =
          user.campus || "Not set";
        document.getElementById("profileDob").textContent = user.dob
          ? new Date(user.dob).toLocaleDateString()
          : "Not set";
        document.getElementById("profilePob").textContent =
          user.pob || "Not set";
        document.getElementById("profileNationality").textContent =
          user.nationality || "Not set";
        document.getElementById("profileHomeAddress").textContent =
          user.home_address || "Not set";
        document.getElementById("profilePreviousSchool").textContent =
          user.previous_school || "N/A";
        document.getElementById("profilePrimarySchool").textContent =
          user.primary_school || "Not set";
        document.getElementById("profileSecondarySchool").textContent =
          user.secondary_school || "Not set";
          // --- END ADDED FIELDS ---

        const idContainer = document.getElementById(
          "profileIdPictureContainer"
        );
        const idImage = document.getElementById("profileIdPicture");

        if (user.school_id_picture) {
          // Check if it's a Base64 string (New system) or a Filename (Old system fallback)
          if (user.school_id_picture.startsWith("data:")) {
             idImage.src = user.school_id_picture;
          } else {
             // Fallback for any old images (though these won't load on Vercel)
             idImage.src = "/uploads/" + user.school_id_picture;
          }
          idContainer.style.display = "block";
        } else {
          // No picture, hide the container
          idContainer.style.display = "none";
        }
      }

      // ---
      // === ADD THIS ENTIRE NEW FUNCTION ===
      // ---
      function updateServiceRequestCounters(requests) {
        const serviceCounts = {};

        // 1. Count all past services
        for (const request of requests) {
          // request.services is an array, e.g., ["Transcript of Records"]
          if (Array.isArray(request.services)) {
            for (const serviceName of request.services) {
              serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
            }
          }
        }

        // 2. Hide all counters first to reset them on refresh
        document.querySelectorAll('.service-counter').forEach(counter => {
          counter.style.display = 'none';
          counter.textContent = '';
        });

        // 3. Update the DOM for each service that has a count
        for (const serviceName in serviceCounts) {
          const count = serviceCounts[serviceName];
          if (count > 0) {
            // Find the card using the unique onclick attribute
            const serviceCard = document.querySelector(
              `.card[onclick="selectService('${serviceName}')"]`
            );
            
            if (serviceCard) {
              // Find the counter element *inside* that specific card
              const counterElement = serviceCard.querySelector('.service-counter');
              if (counterElement) {
                counterElement.textContent = `Requested: ${count}`;
                counterElement.style.display = 'inline-block'; // Make it visible
              }
            }
          }
        }
      }
      // ---
      // === END OF NEW FUNCTION ===
      // ---

// ===== NAVIGATION FUNCTION =====
function showSection(targetId) {
  const sections = document.querySelectorAll(".section");
  const navLinks = document.querySelectorAll(".nav-link");

  // Update active states
  sections.forEach((sec) => sec.classList.remove("active"));
  navLinks.forEach((l) => l.classList.remove("active"));

  const targetLink = document.querySelector(
    `.nav-link[data-target="${targetId}"]`
  );
  if (targetLink) {
    targetLink.classList.add("active");
  }

  const targetSection = document.getElementById(targetId);
  if (targetSection) {
    targetSection.classList.add("active");
  }

  // --- NEW LOGIC FOR NOTIFICATIONS ---
  if (targetId === "updates") {
    // 1. Instantly hide the dot
    const dot = document.getElementById("updates-notification-dot");
    if (dot) dot.style.display = "none";

    // 2. Tell the backend to mark all as read
    const userId = localStorage.getItem("userId");
    if (userId) {
      fetch("/api/user/mark-notifications-read", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: userId }),
      }).catch((err) => console.error("Error marking read:", err));
    }

    // 3. Load the requests
    loadUserRequests();
  }
  // --- END NEW LOGIC ---

  // Close mobile menu if open
  const navbar = document.querySelector(".navbar-collapse");
  if (navbar.classList.contains("show")) {
    new bootstrap.Collapse(navbar).hide();
  }
}

      // ===== API FUNCTIONS =====

      // Check if profile is complete
      async function checkProfileComplete() {
        const userId = localStorage.getItem("userId");

        if (!userId) {
          console.error("No user ID found in localStorage");
          return false;
        }

        try {
          const response = await fetch(
            `/api/user/can-join-queue?userId=${userId}`
          );

          // Check if response is OK (status 200-299)
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          return data.success && data.canJoinQueue;
        } catch (error) {
          console.error("Error checking profile status:", error);
          return false;
        }
      }

async function checkUserProfileStatus() {
  const userId = localStorage.getItem("userId");
  if (!userId) return false;

  try {
    const response = await fetch(`/api/user/profile?userId=${userId}`);
    const data = await response.json();

    if (data.success) {
      // --- THIS IS THE FIX ---
      // This line displays your name, ID, image, etc. on the profile tab
      updateProfileDisplay(data.user);
      // --- END OF FIX ---

      // Check if profile is complete (1 = complete, 0 = incomplete)
      userProfileComplete = data.user.profile_complete;

      // Get elements for BOTH warnings
      const homeTabWarning = document.getElementById("profileWarning");
      const profileTabWarning = document.getElementById("profilePageWarning"); // <-- The new ID
      const viewServicesBtn = document.getElementById("viewServicesBtn");

      // Show/hide warnings based on completion status
      if (homeTabWarning) {
        homeTabWarning.style.display = userProfileComplete ? "none" : "flex";
      }
      if (profileTabWarning) {
        profileTabWarning.style.display = userProfileComplete
          ? "none"
          : "block";
      }

      // Show/hide view services button
      if (viewServicesBtn) {
        viewServicesBtn.style.display = userProfileComplete ? "block" : "none";
      }

      // --- This line was already correct ---
      checkAllFilesUploaded(); // Re-check button status after profile state changes

      // If profile is NOT complete, call loadUserProfile()
      // which will pre-fill what it can, and then show the modal.
      if (!userProfileComplete) {
        await loadUserProfile(); // Load data into modal and show it
      }

      return userProfileComplete;
    }
  } catch (error) {
    console.error("Error checking profile status:", error);
  }
  return false;
}

async function loadUserProfile() {
        const userId = localStorage.getItem("userId");
        if (!userId) return;

        try {
          const response = await fetch(`/api/user/profile?userId=${userId}`);

          if (!response.ok) {
            if (response.status === 404) {
              const modal = new bootstrap.Modal(document.getElementById("profileUpdateModal"));
              modal.show();
              return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const user = data.user;

          // ... (Keep all your existing form population code: lastName, firstName, etc.) ...
          document.getElementById("lastName").value = user.last_name || "";
          document.getElementById("firstName").value = user.first_name || "";
          document.getElementById("middleName").value = user.middle_name || "";
          document.getElementById("gender").value = user.gender || "";
          document.getElementById("phone").value = user.phone || "";
          document.getElementById("studentId").value = user.student_id || "";
          document.getElementById("program").value = user.course || ""; 
          document.getElementById("major").value = user.major || "";
          document.getElementById("yearLevel").value = user.year_level || "";
          document.getElementById("schoolYear").value = user.school_year || "";
          document.getElementById("yearGraduated").value = user.year_graduated || "";
          document.getElementById("email").value = user.email || "";
          
          document.getElementById("campus").value = user.campus || "";
          document.getElementById("dob").value = user.dob ? user.dob.split("T")[0] : "";
          document.getElementById("pob").value = user.pob || "";
          document.getElementById("nationality").value = user.nationality || "";
          document.getElementById("home_address").value = user.home_address || "";
          document.getElementById("previous_school").value = user.previous_school || "";
          document.getElementById("primary_school").value = user.primary_school || "";
          document.getElementById("secondary_school").value = user.secondary_school || "";

          // Image Preview Logic (Keep existing)
          const previewContainer = document.getElementById("schoolIdPicturePreview");
          const imgElement = previewContainer.querySelector("img");
          if (user.school_id_picture) {
            if (user.school_id_picture.startsWith("data:")) {
               imgElement.src = user.school_id_picture;
            } else {
               imgElement.src = `/uploads/${user.school_id_picture}`;
            }
            previewContainer.style.display = "block";
            userHasExistingId = true; 
          } else {
            previewContainer.style.display = "none";
            userHasExistingId = false; 
          }

          updateProfileDisplay(user);

          // 🟢 NEW LOGIC: Hide Close/Cancel buttons if profile is incomplete 🟢
          const modalEl = document.getElementById("profileUpdateModal");
          const closeBtn = modalEl.querySelector(".btn-close");     // The X button in header
          const cancelBtn = modalEl.querySelector(".btn-secondary"); // The Cancel button in footer

          if (user.profile_complete === 0) {
             // Mandatory Mode: Hide buttons so they MUST save
             if (closeBtn) closeBtn.style.display = "none";
             if (cancelBtn) cancelBtn.style.display = "none";
          } else {
             // Edit Mode: Show buttons so they can cancel
             if (closeBtn) closeBtn.style.display = "block";
             if (cancelBtn) cancelBtn.style.display = "block";
          }

          // Show the modal
          const modal = new bootstrap.Modal(modalEl);
          modal.show();

        } catch (error) {
          console.error("Error loading user profile:", error);
          // Fallback: show modal if error
          const modal = new bootstrap.Modal(document.getElementById("profileUpdateModal"));
          modal.show();
        }
      }

      // Save profile data to server
      async function saveProfileToServer(profileData) {
        const userId = localStorage.getItem("userId");

        try {
          const response = await fetch("/api/user/update-profile", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: userId,
              ...profileData,
            }),
          });

          const data = await response.json();

          if (data.success) {
            // Reload profile data
            await loadUserProfile();
            return true;
          } else {
            showAlert("Error updating profile: " + data.message, "error");
            return false;
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          showAlert("Error updating profile. Please try again.", "error");
          return false;
        }
      }

      // ===== SERVICES DATA AND FUNCTIONS =====

      // Services data
const servicesData = {
  // --- Group 1: Academic Records ---
  "Transcript of Records": {
    category: "academic",
    description: "Official academic record showing all courses and grades.",
    requirements: [{ name: "Clearance" }, { name: "Documentary Stamp" }, { name: "Receipt of Payment" }],
    price: 40.00,
    time: "7 working days"
  },
  "Certificate of Grades": {
    category: "academic",
    description: "Official certification of grades for specific semesters.",
    requirements: [{ name: "Request Form" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "7 working days"
  },
  "Certificate of Units Earned": {
    category: "academic",
    description: "Certification of total units earned in the program.",
    requirements: [{ name: "Request Form" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },

  // --- Group 2: Certifications ---
  "Certificate of Enrolment": {
    category: "certifications",
    description: "Proof that the student is currently enrolled.",
    requirements: [{ name: "Study Load" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Certificate of Honors": {
    category: "certifications",
    description: "Certification for Dean's Listers or Latin Honors.",
    requirements: [{ name: "Copy of Grades" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Certificate of Upper 25": {
    category: "certifications",
    description: "Certification of class ranking (Upper 25%).",
    requirements: [{ name: "Request Letter" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "14 working days"
  },
  "Certificate of English as Medium": {
    category: "certifications",
    description: "Certifies that English is the medium of instruction.",
    requirements: [{ name: "Request Form" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },

  // --- Group 3: Graduation ---
  "Certificate of Graduation": {
    category: "graduation",
    description: "Proof of graduation from the institution.",
    requirements: [{ name: "Clearance" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Diploma (Duplicate Copy)": {
    category: "graduation",
    description: "Re-issuance of Diploma.",
    requirements: [{ name: "Notarized Affidavit of Loss" }, { name: "Receipt of Payment" }],
    price: 100.00,
    time: "1 month"
  },
  "CAV (CHED/DFA)": {
    category: "graduation",
    description: "Certification, Authentication and Verification.",
    requirements: [{ name: "Diploma & TOR Photocopies" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "5 working days"
  },
  "Transfer Credentials": {
    category: "graduation",
    description: "Honorable Dismissal / Transfer Credentials.",
    requirements: [{ name: "Clearance" }, { name: "Receipt of Payment" }],
    price: 25.00,
    time: "On Process"
  }
};

      // ===== ENHANCED DASHBOARD FUNCTIONALITY =====
      let selectedServicesList = [];
      let autoRefreshInterval;
      let userProfileComplete = false;
      let userHasExistingId = false;

      // Enhanced service selection with visual feedback
      function selectService(serviceName) {
        if (!checkAuthentication() || !checkSession()) return;

        // Use a reliable selector to find the card
        const serviceCard = document.querySelector(
          `.service-card[onclick="selectService('${serviceName}')"]`
        );

        if (selectedServicesList.includes(serviceName)) {
          // Deselect service by clicking the card again
          selectedServicesList = selectedServicesList.filter(
            (s) => s !== serviceName
          );
          if (serviceCard) serviceCard.classList.remove("selected");

          // Update count and modal list
          updateSelectedCount();
          refreshModal();
        } else {
          // Service is not selected, so show confirmation modal to add it.
          // The "Add Service" button in the modal will handle the logic.
          showServiceConfirmationModal(serviceName);
        }

        // All other logic (updateSelectedCount, refreshModal, etc.)
        // has been removed from here. It now lives inside the
        // confirmation modal's "Add Service" button.
      }

      // Update selected services count
      function updateSelectedCount() {
        const badge = document.getElementById("selectedCountBadge");
        if (badge) {
          if (selectedServicesList.length > 0) {
            badge.textContent = selectedServicesList.length;
            badge.style.display = "inline";
          } else {
            badge.style.display = "none";
          }
        }
      }
      // --- NEW FUNCTION: Checks if all required files are uploaded ---
function checkAllFilesUploaded() {
  const joinQueueBtn = document.getElementById("joinQueueBtn");
  const requiredUploadInputs = document.querySelectorAll(
    ".requirement-upload[required]"
  );

  // If no services are selected, or no required inputs, the button should be disabled by default
  if (selectedServicesList.length === 0) {
    joinQueueBtn.disabled = true;
    return;
  }

  let allFilesProvided = true;
  requiredUploadInputs.forEach((input) => {
    if (input.files.length === 0) {
      allFilesProvided = false;
    }
  });

  // Enable button only if all required files are provided AND profile is complete
  joinQueueBtn.disabled = !allFilesProvided || !userProfileComplete;

  // Optional: Add/remove a class for styling if you want a visual change
  if (joinQueueBtn.disabled) {
    joinQueueBtn.classList.remove("btn-success");
    joinQueueBtn.classList.add("btn-secondary"); // Gray out
  } else {
    joinQueueBtn.classList.remove("btn-secondary");
    joinQueueBtn.classList.add("btn-success"); // Green
  }
}
// --- END NEW FUNCTION ---

      // Enhanced view services function
      function viewSelectedServices() {
        if (!checkAuthentication() || !checkSession()) return;

        if (selectedServicesList.length === 0) {
          showAlert("Please select at least one service first.", "warning");
          return;
        }

        if (!userProfileComplete) {
          showProfileUpdateModal(); 
          return;
        }

        refreshModal();
        const selectedModal = new bootstrap.Modal(
          document.getElementById("selectedModal")
        );
        selectedModal.show();
      }

      function addServiceToList(serviceName) {
        if (!selectedServicesList.includes(serviceName)) {
          selectedServicesList.push(serviceName);
          refreshModal();
        }
      }

      function removeService(serviceName) {
        selectedServicesList = selectedServicesList.filter(
          (s) => s !== serviceName
        );

        // Use querySelector to find the correct card
        const serviceCard = document.querySelector(
          `.service-card[onclick="selectService('${serviceName}')"]`
        );
        if (serviceCard) {
          serviceCard.classList.remove("selected");
        }

        updateSelectedCount();
        refreshModal();
      }

function refreshModal() {
  const modalBodyLeft = document.getElementById("selectedServicesList");
  const modalBodyRight = document.getElementById("requirementsList");
  const totalAmountEl = document.getElementById("totalAmount");
  const joinQueueBtn = document.getElementById("joinQueueBtn");

  if (selectedServicesList.length === 0) {
    modalBodyLeft.innerHTML = "<p class='p-3 text-center'>No services selected yet.</p>";
    modalBodyRight.innerHTML = "";
    totalAmountEl.textContent = "₱0.00";
    joinQueueBtn.disabled = true;
  } else {
    let total = 0;
    let servicesHTML = "";
    let requirementsHTML = "";

    selectedServicesList.forEach((fullString, serviceIndex) => {
      // Logic to separate "Service Name" from "[Note: ...]"
      let baseName = fullString;
      let noteDisplay = "";

      if (fullString.includes("[Note:")) {
         const parts = fullString.split(" [Note:");
         baseName = parts[0];
         noteDisplay = parts[1].replace("]", ""); // Clean up the closing bracket
      }

      // Lookup data using the base name
      const service = servicesData[baseName];

      if (!service) {
        console.error("Service data missing for:", baseName);
        return;
      }

      total += service.price || 0;

      servicesHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>${baseName}</strong>
              ${noteDisplay ? `<br><small class="text-primary"><i class="bi bi-pencil-fill me-1"></i> ${noteDisplay}</small>` : ''}
              <div class="small text-muted mt-1">Fee: ₱${service.price.toFixed(2)}</div>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeService('${fullString}')">
                <i class="bi bi-trash"></i>
            </button>
        </li>
      `;

      // Requirements
      requirementsHTML += `<div class="mb-3 p-2 border rounded"><h6 class="fw-bold text-primary">${baseName}</h6>`;
      
      if (service.requirements && service.requirements.length > 0) {
        service.requirements.forEach((req, reqIndex) => {
          const inputId = `file-${serviceIndex}-${reqIndex}`;
          requirementsHTML += `
            <div class="mb-2">
              <label for="${inputId}" class="form-label mb-1 small">
                ${req.name} <span class="text-danger">*</span>
              </label>
              <input type="file" class="form-control form-control-sm requirement-upload"
                id="${inputId}"
                data-service-name="${fullString}" 
                data-requirement-name="${req.name}"
                required onchange="checkAllFilesUploaded()" />
            </div>
          `;
        });
      }
      requirementsHTML += `</div>`;
    });

    modalBodyLeft.innerHTML = servicesHTML;
    modalBodyRight.innerHTML = requirementsHTML;
    totalAmountEl.textContent = `₱${total.toFixed(2)}`;
    checkAllFilesUploaded();
  }
}

// Enhanced Join Queue Function with Loading & Toast
document
  .getElementById("joinQueueBtn")
  .addEventListener("click", async function () {
    if (!checkAuthentication() || !checkSession()) return;

    if (selectedServicesList.length === 0) {
      showToast("Please select at least one service.", "error");
      return;
    }

    if (!userProfileComplete) {
      showToast("Please complete your profile first.", "error");
      return;
    }

    // --- Validation Logic ---
    const fileInputs = document.querySelectorAll(
      ".requirement-upload[required]"
    );
    let allFilesUploaded = true;

    fileInputs.forEach((input) => {
      if (input.files.length === 0) {
        allFilesUploaded = false;
        input.classList.add("is-invalid");
      } else {
        input.classList.remove("is-invalid");
      }
    });

    if (!allFilesUploaded) {
      showToast("Please upload all required files.", "error");
      return;
    }

    // --- 1. SHOW LOADING TOAST ---
    showToast("Submitting your request...", "info");

    // --- 2. BUTTON LOADING STATE ---
    const joinBtn = document.getElementById("joinQueueBtn");
    const originalText = joinBtn.innerHTML;
    joinBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2"></span> Submitting...';
    joinBtn.disabled = true;

    // Prepare Data
    const userId = localStorage.getItem("userId");
    const formData = new FormData();
    formData.append("userId", userId);
    selectedServicesList.forEach((service) => {
      formData.append("services[]", service.trim());
    });
    fileInputs.forEach((input) => {
      if (input.files.length > 0) {
        formData.append("requirements_files", input.files[0]);
        formData.append("requirement_names[]", input.dataset.requirementName);
      }
    });

    try {
      // Submit to backend
      const response = await fetch("/api/queue/submit-request", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();

if (result.success) {
        // --- PASTE THIS NEW CODE HERE ---
        // 1. Get the current user's name from LocalStorage
        const studentName = localStorage.getItem("fullname") || "Student";
        
        // 2. Trigger the Admin Dashboard event
        localStorage.setItem('latestRequest', JSON.stringify({ 
            name: studentName, 
            timestamp: Date.now() 
        }));
        // --- END OF NEW CODE ---

        // Close modal
        const selectedModal = bootstrap.Modal.getInstance(
          document.getElementById("selectedModal")
        );
        if (selectedModal) selectedModal.hide();

        // --- 3. SHOW SUCCESS TOAST ---
        showToast("Request submitted successfully!", "success");

        // Show detailed success modal (your existing one)
        showSubmissionSuccessModal(result.requestId);

        // Reset UI
        selectedServicesList = [];
        resetServiceSelectionUI();
        updateSelectedCount();
        await loadUserRequests();
      }else {
        showToast("Error: " + result.message, "error");
      }
    } catch (error) {
      console.error("Error submitting service request:", error);
      showToast("Network error. Please try again.", "error");
    } finally {
      // --- 4. RESET BUTTON STATE ---
      // Slight delay to prevent flickering if the response is instant
      setTimeout(() => {
        joinBtn.innerHTML = "Join Queue Now";
        joinBtn.disabled = false;
      }, 500);
    }
  });
      // Enhanced service request submission
      async function submitServiceRequest() {
        const userId = localStorage.getItem("userId");

        try {
          // Show loading state
          const joinBtn = document.getElementById("joinQueueBtn");
          const originalText = joinBtn.innerHTML;
          joinBtn.innerHTML =
            '<i class="bi bi-hourglass-split me-1"></i> Submitting...';
          joinBtn.disabled = true;

          // Calculate total amount and prepare requirements
          let totalAmount = 0;
          const requirements = [];

          selectedServicesList.forEach((serviceName) => {
            const service = servicesData[serviceName];
            totalAmount += service.price || 0;
            requirements.push({
              service: serviceName,
              requirements: service.requirements,
            });
          });

          // Submit to backend
          const response = await fetch("/api/queue/submit-request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: userId,
              services: selectedServicesList,
              totalAmount: totalAmount,
              requirements: requirements,
            }),
          });

          const result = await response.json();

          if (result.success) {
            // Close the modal
            const selectedModal = bootstrap.Modal.getInstance(
              document.getElementById("selectedModal")
            );
            if (selectedModal) selectedModal.hide();

            // Show success message with request ID
            showSubmissionSuccessModal(result.requestId);

            // Clear selected services and reset UI
            selectedServicesList = [];
            resetServiceSelectionUI();
            updateSelectedCount();

            // Reload user requests
            await loadUserRequests();
          } else {
            showAlert("Error submitting request: " + result.message, "error");
          }
        } catch (error) {
          console.error("Error submitting service request:", error);
          showAlert("Error submitting request. Please try again.", "error");
        } finally {
          // Reset button state
          const joinBtn = document.getElementById("joinQueueBtn");
          // --- THIS LINE IS CORRECTED ---
          joinBtn.innerHTML = "Join Queue Now";
          joinBtn.disabled = false;
        }
      }

      // Reset service selection UI
      function resetServiceSelectionUI() {
        // Remove selected class from all service cards
        document.querySelectorAll(".service-card.selected").forEach((card) => {
          card.classList.remove("selected");
        });
      }

// Enhanced user requests loading with real-time updates
      async function loadUserRequests() {
        const userId = localStorage.getItem("userId");

        if (!userId) return;

        try {
          const response = await fetch(
            `/api/user/service-requests?userId=${userId}`
          );
          const result = await response.json();

         if (result.success) {
            // 1. Render the cards to the DOM
            displayUserRequests(result.requests);
            
            // 2. Update the status counters (Total, Pending, Approved, Processing)
            updateRequestStats(result.requests);
            
            // 3. Check if there's an active queue to display the big banner
            checkForActiveQueue(result.requests);

            // 4. Update the "Requested: X" counters on the Services tab cards
            updateServiceRequestCounters(result.requests);
            
            // 5. Re-apply any active filter (e.g. if user selected "Transcript of Records")
            filterRequests(); 
          }
        } catch (error) {
          console.error("Error loading user requests:", error);
        }
      }

      // Add this new function alongside your other functions like loadUserRequests()

      /**
       * Begins the resubmission process for a declined request.
       * @param {string} requestId The ID of the declined request.
       */
      async function resubmitRequest(requestId) {
        if (!userProfileComplete) {
          showAlert("Please ensure your profile is complete before resubmitting.", "warning");
          showProfileUpdateModal();
          return;
        }

        // Show a simple loading alert
        showAlert("Loading original request details...", "info");
        const userId = localStorage.getItem("userId");

        try {
          // Call the new API endpoint you created in Step 1
          const response = await fetch(`/api/user/request-details?requestId=${requestId}&userId=${userId}`);
          const data = await response.json();

          if (data.success && data.services.length > 0) {
            // 1. Clear any services the user might have been selecting
            selectedServicesList = [];

            // 2. Add services from the old, declined request
            // We must ensure we add the *exact* service names from servicesData
            for (const serviceName of data.services) {
              if (servicesData[serviceName]) {
                selectedServicesList.push(serviceName);
              } else {
                console.warn(`Service "${serviceName}" from old request is no longer valid.`);
              }
            }

            if (selectedServicesList.length === 0) {
                showAlert("Could not resubmit. The services from this request are no longer available.", "error");
                return;
            }

            // 3. Update the UI and show the "Selected Services" modal
            updateSelectedCount();
            
            // This existing function will open the modal and pre-fill it
            // because we just populated selectedServicesList.
            viewSelectedServices(); 
            
            // Add a helpful alert in the modal
            setTimeout(() => {
                document.getElementById("requirementsList").insertAdjacentHTML(
                    'afterbegin',
                    '<div class="alert alert-warning small"><i class="bi bi-exclamation-triangle me-1"></i> <strong>Resubmitting:</strong> Please upload your corrected requirements files below.</div>'
                );
            }, 500); // Delay to ensure modal is visible

          } else {
            showAlert(`Error: ${data.message || "Could not find details for this request."}`, "error");
          }
        } catch (error) {
          console.error("Error resubmitting request:", error);
          showAlert("An error occurred. Please try again.", "error");
        }
      }

// Enhanced request display with Progress Bar
      function displayUserRequests(requests) {
        const container = document.getElementById("requestsContainer");
        if (!container) return;

        if (requests.length === 0) {
          container.innerHTML = `
            <div class="update-card text-center">
                <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                <h4>No Service Requests</h4>
                <p>You haven't submitted any service requests yet.</p>
            </div>
        `;
          return;
        }

        container.innerHTML = requests
          .map((request) => {
            const statusInfo = getStatusInfo(
              request.status,
              request.queue_status
            );
            
            const queueInfo = request.queue_number
              ? `<div class="mt-2">
                <strong>Queue Number:</strong> 
                <span class="badge queue-status-badge bg-secondary">${request.queue_number}</span>
            </div>`
              : "";

            // 🟢 PROGRESS BAR LOGIC 🟢
            let progressHtml = '';
            if (request.queue_status === 'processing' && request.progress) {
                const p = request.progress; // { current: 1, total: 5, checked: [...] }
                const percent = Math.round((p.current / p.total) * 100);
                
                progressHtml = `
                  <div class="mt-3 p-3 bg-light rounded border">
                    <div class="d-flex justify-content-between align-items-end mb-1">
                      <label class="small fw-bold text-primary">Processing Status</label>
                      <span class="small fw-bold text-dark">${percent}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                           role="progressbar" 
                           style="width: ${percent}%">
                      </div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                       <small class="text-muted" style="font-size: 11px;">Day ${p.current} of ${p.total}</small>
                       <small class="text-muted" style="font-size: 11px;">${p.total - p.current} days remaining</small>
                    </div>
                  </div>
                `;
            }

            // --- FEEDBACK BUTTON LOGIC ---
            let feedbackBtn = '';
            
            // Logic: Show button only if Completed (or Claimed) AND No Feedback exists yet
            const isFinished = (request.queue_status === "completed" || request.queue_status === "claimed" || request.live_queue_status === "completed");
            
            if (isFinished && !request.feedback_id) {
                feedbackBtn = `
                  <div class="mt-3 text-end border-top pt-2">
                    <span class="small text-muted me-2">How was our service?</span>
                    <button class="btn btn-sm btn-outline-warning" onclick="openFeedbackModal('${request.request_id}')">
                      <i class="bi bi-star"></i> Rate Service
                    </button>
                  </div>
                `;
            } else if (request.feedback_id) {
                 feedbackBtn = `
                  <div class="mt-3 text-end border-top pt-2">
                    <span class="badge bg-light text-success border"><i class="bi bi-check-circle"></i> Rated</span>
                  </div>
                `;
            }

            return `
            <div class="update-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4 class="mb-0">${request.services.join(", ")}</h4>
                    <span class="queue-status-badge ${statusInfo.class}">${statusInfo.text}</span>
                </div>
                <p class="text-muted">
                    <strong>Request ID:</strong> ${request.request_id} | 
                    <strong>Submitted:</strong> ${new Date(request.submitted_at).toLocaleString()}
                </p>
                
                ${queueInfo}

                ${progressHtml}

                ${
                  request.status === "approved" && request.approved_by
                    ? `
                    <div class="alert alert-success mt-2">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        <strong>Approved</strong> by ${request.approved_by} 
                        <span class="text-muted small ms-1">(${new Date(request.approved_at).toLocaleDateString()})</span>
                        ${request.approve_notes ? `<br><small class="text-muted">${request.approve_notes}</small>` : ""}
                    </div>
                `
                    : ""
                }
                ${
                  request.status === "declined" && request.declined_by
                    ? `
                    <div class="alert alert-danger mt-2">
                        <strong>✗ Declined</strong> by ${
                          request.declined_by
                        } on ${new Date(request.declined_at).toLocaleString()}
                        <br><strong>Reason:</strong> ${request.decline_reason}
                    </div>

                    <div class="mt-2 text-end">
                        <button class="btn btn-warning btn-sm" onclick="resubmitRequest('${
                          request.request_id
                        }')">
                            <i class="bi bi-arrow-clockwise me-1"></i> Resubmit This Request
                        </button>
                    </div>
                    `
                    : ""
                }
                
                
                ${
                  request.queue_status === "completed" || request.live_queue_status === "completed"
                    ? `
                    <div class="alert alert-primary mt-3 border-0 shadow-sm" style="background-color: #e7f1ff; color: #004085;">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-patch-check-fill fs-1 text-success"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="fw-bold mb-1 text-success">Ready to Claim!</h5>
                                <p class="mb-2 small">Your document processing is complete.</p>
                                
                                <div class="bg-white p-2 rounded border border-primary-subtle mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Processed at:</small>
                                        <strong class="text-primary">${request.window_number || "Registrar Office"}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">Staff:</small>
                                        <strong>${request.completed_by || "Staff"}</strong>
                                    </div>
                                </div>

                                ${
                                  request.final_claim_details
                                    ? `<div class="mt-2 pt-2 border-top border-primary border-opacity-25">
                                        <small class="text-uppercase fw-bold opacity-75" style="font-size: 10px;">Message / Instructions:</small><br>
                                        <div class="fst-italic mt-1">"${request.final_claim_details}"</div>
                                       </div>`
                                    : ""
                                }
                            </div>
                        </div>
                    </div>
                `
                    : ""
                }
            </div>
        `;
          })
          .join("");
      }
// --- NEW FUNCTION: Filters requests on the "Updates" page ---
function filterRequests() {
  const filterValue = document.getElementById("serviceFilter").value;
  const requestCards = document.querySelectorAll("#requestsContainer .update-card");
  let visibleCount = 0;

  requestCards.forEach((card) => {
    // Check if it's an empty state card, if so, ignore it
    if (card.querySelector(".bi-inbox")) {
      return;
    }

    const titleElement = card.querySelector("h4");
    if (!titleElement) return; // Safety check

    const servicesText = titleElement.textContent; // e.g., "Transcript of Records, Completion Grade Form"

    if (filterValue === "all" || servicesText.includes(filterValue)) {
      card.style.display = "block";
      visibleCount++;
    } else {
      card.style.display = "none";
    }
  });

  // Handle "No results" message
  const container = document.getElementById("requestsContainer");
  let noResultMsg = container.querySelector(".no-results-message");

  if (visibleCount === 0 && requestCards.length > 0 && filterValue !== 'all') {
    if (!noResultMsg) {
      noResultMsg = document.createElement("div");
      noResultMsg.className = "update-card text-center text-muted no-results-message";
      container.appendChild(noResultMsg);
    }
    noResultMsg.innerHTML = `<i class="bi bi-search display-4 mb-3"></i><h4>No requests found</h4><p>No requests match the filter "${filterValue}".</p>`;
    noResultMsg.style.display = 'block';
  } else if (noResultMsg) {
    noResultMsg.style.display = 'none'; // Just hide it
  }
}

  // --- FEEDBACK LOGIC ---
      const sqdQuestionsList = [
        "SQD 1. I spent a reasonable amount of time for my transaction.",
        "SQD 2. The office followed the transaction's requirements.",
        "SQD 3. The steps needed to do for my transaction were easy and simple.",
        "SQD 4. I easily found information about my transaction.",
        "SQD 5. I paid a reasonable amount of fees.",
        "SQD 6. I feel the office was fair to everyone.",
        "SQD 7. I was treated courteously by the staff.",
        "SQD 8. I got what I needed from the government office."
      ];

      function openFeedbackModal(requestId) {
        document.getElementById('feedbackRequestId').value = requestId;
        setRating(0);
        document.getElementById('feedbackComments').value = '';
        
        const container = document.getElementById('sqdQuestions');
        container.innerHTML = sqdQuestionsList.map((q, index) => `
          <div class="mb-2 row align-items-center bg-light p-2 rounded">
            <div class="col-md-7 small mb-1 mb-md-0">${q}</div>
            <div class="col-md-5">
              <select class="form-select form-select-sm sqd-select" data-index="${index+1}">
                <option value="5">Strongly Agree</option>
                <option value="4" selected>Agree</option>
                <option value="3">Neutral</option>
                <option value="2">Disagree</option>
                <option value="1">Strongly Disagree</option>
                <option value="0">N/A</option>
              </select>
            </div>
          </div>
        `).join('');

        new bootstrap.Modal(document.getElementById('feedbackModal')).show();
      }

      function setRating(rating) {
        document.getElementById('sqd0Rating').value = rating;
        const stars = document.querySelectorAll('.rating-stars i');
        const text = document.getElementById('ratingText');
        const texts = ["Tap a star", "Very Dissatisfied", "Dissatisfied", "Neutral", "Satisfied", "Very Satisfied"];
        
        stars.forEach((star, index) => {
          star.className = index < rating ? 'bi bi-star-fill' : 'bi bi-star';
        });
        text.textContent = texts[rating] || texts[0];
      }

      async function submitFeedback() {
        const requestId = document.getElementById('feedbackRequestId').value;
        const sqd0 = document.getElementById('sqd0Rating').value;
        const comments = document.getElementById('feedbackComments').value;
        const userId = localStorage.getItem("userId");

        if(sqd0 == 0) {
          alert("Please provide an Overall Satisfaction rating.");
          return;
        }

        const sqdData = {};
        document.querySelectorAll('.sqd-select').forEach(sel => {
           sqdData[`SQD${sel.dataset.index}`] = sel.value;
        });

        // Mock CC Data (simplified)
        const ccData = { cc1: 1, cc2: 1, cc3: 1 }; 

        try {
          const response = await fetch('/api/user/submit-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId, userId, sqd0, sqdData, ccData, comments })
          });
          
          if(response.ok) {
            showToast("Feedback submitted! Thank you.", "success");
            bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
            loadUserRequests(); // Hide button
          } else {
            showToast("Error submitting feedback.", "error");
          }
        } catch(e) { console.error(e); }
      }
// --- END OF NEW FUNCTION ---

      // Enhanced status information function
      function getStatusInfo(status, queueStatus) {
        // If queue is completed, show completed status regardless of approval status
        if (queueStatus === "completed") {
          return { class: "status-completed", text: "✅ Completed" };
        }

        // If queue is processing, show processing status
        if (queueStatus === "processing") {
          return { class: "status-processing", text: "⚙️ Processing" };
        }

        // Otherwise, show the regular approval status
        switch (status) {
          case "pending":
            return { class: "status-pending", text: "⏳ Pending Approval" };
          case "approved":
            return { class: "status-approved", text: "✅ Approved" };
          case "declined":
            return { class: "status-declined", text: "❌ Declined" };
          default:
            return { class: "status-pending", text: "⏳ Pending" };
        }
      }

      // Update request statistics
      function updateRequestStats(requests) {
        // --- Calculations ---
        const total = requests.length;
        const pending = requests.filter((r) => r.status === "pending").length;
        const approved = requests.filter(
          (r) => r.status === "approved" && r.queue_status === "in_queue"
        ).length;
        
        // FIX: This now correctly counts "processing" status
        const processing = requests.filter(
          (r) => r.queue_status === "processing"
        ).length;

        // --- NEW: Profile Stat Calculations ---
        const completed = requests.filter(
          (r) => r.queue_status === "completed"
        ).length;

        // "In Progress" = pending + approved (in_queue) + processing
        const inProgress = pending + approved + processing; 

        // --- Update "Updates" Tab Stats ---
        document.getElementById("totalRequests").textContent = total;
        document.getElementById("pendingRequests").textContent = pending;
        document.getElementById("approvedRequests").textContent = approved;
        document.getElementById("processingRequests").textContent = processing;

        // --- NEW: Update "Profile" Tab Stats ---
        document.getElementById("profileStatTotal").textContent = total;
        document.getElementById("profileStatCompleted").textContent = completed;
        document.getElementById("profileStatInProgress").textContent = inProgress;
      }

      // Enhanced function to check for active queue
      function checkForActiveQueue(requests) {
        const activeRequest = requests.find(
          (r) =>
            (r.status === "approved" && r.queue_status === "in_queue") ||
            (r.status === "approved" && r.queue_status === "processing") ||
            (r.status === "approved" && r.queue_status === "completed")
        );

        const queueDisplay = document.getElementById("queueNumberDisplay");

        if (activeRequest && queueDisplay) {
          document.getElementById("currentQueueNumber").textContent =
            activeRequest.queue_number;

          // Update status message based on actual queue status
          let statusMessage = "In Queue - Waiting for processing";
          if (activeRequest.queue_status === "processing") {
            statusMessage = "Currently being processed";
          } else if (activeRequest.queue_status === "completed") {
            statusMessage = "Request completed";
          }

          document.getElementById("queueStatusMessage").textContent =
            statusMessage;
          queueDisplay.style.display = "block";
        } else if (queueDisplay) {
          queueDisplay.style.display = "none";
        }
      }

      // Real-time alert system
      function showAlert(message, type = "info") {
        const alertClass =
          {
            success: "alert-success",
            error: "alert-danger",
            warning: "alert-warning",
            info: "alert-info",
          }[type] || "alert-info";

        const alertId = "alert-" + Date.now();
        const alertHTML = `
        <div id="${alertId}" class="alert ${alertClass} real-time-alert alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

        document.body.insertAdjacentHTML("beforeend", alertHTML);

        // Auto remove after 5 seconds
        setTimeout(() => {
          const alert = document.getElementById(alertId);
          if (alert) {
            alert.remove();
          }
        }, 5000);
      }
// --- NEW: Toast Notification Helper ---
      function showToast(message, type = "info") {
        // Remove existing toast if any
        const existingToast = document.querySelector(".notification-toast");
        if (existingToast) existingToast.remove();

        // Create element
        const toast = document.createElement("div");
        toast.className = `notification-toast toast-${type}`;

        // Icon based on type
        let iconClass = "bi-info-circle-fill";
        if (type === "success") iconClass = "bi-check-circle-fill";
        if (type === "error") iconClass = "bi-exclamation-triangle-fill";

        toast.innerHTML = `
            <i class="bi ${iconClass} toast-icon"></i>
            <span style="font-weight: 500; color: #333;">${message}</span>
        `;

        document.body.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.animation = "slideOutRight 0.3s ease-in forwards";
            setTimeout(() => {
              if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
          }
        }, 3000);
      }

      // Function to show success modal after submission
      function showSubmissionSuccessModal(requestId) {
        const displaySuccessModal = () => {
          const successHTML = `
<div class="modal fade" id="submissionSuccessModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle-fill me-2"></i> Request Submitted
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <i class="bi bi-clock text-warning" style="font-size: 3rem;"></i>
        </div>
        <h5>Request Submitted for Approval</h5>
        <p>Your service request has been submitted and is waiting for admin approval.</p>
        <div class="alert alert-info">
          <strong>Request ID:</strong> ${requestId}<br>
          <strong>Status:</strong> <span class="badge bg-warning">Pending Approval</span>
        </div>
        <p>You will be notified once your request is approved or if additional information is needed.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
`;

          // Remove any existing success modal to prevent conflicts
          const existingModal = document.getElementById(
            "submissionSuccessModal"
          );
          if (existingModal) {
            existingModal.remove();
          }

          // Add new modal to body
          document.body.insertAdjacentHTML("beforeend", successHTML);

          // Get the newly added modal element
          const successModalEl = document.getElementById(
            "submissionSuccessModal"
          );

          // Initialize and show the Bootstrap modal
          const successModal = new bootstrap.Modal(successModalEl);
          successModal.show();

          // --- CRITICAL FIX START ---
          // Use 'hidden.bs.modal' event to remove the modal from DOM
          // This ensures that after it's visually hidden and transition is done,
          // the element (and its descendants) are completely gone,
          // preventing aria-hidden focus issues.
          successModalEl.addEventListener(
            "hidden.bs.modal",
            function () {
              this.remove();
            },
            { once: true }
          ); // Use { once: true } to remove the listener after it fires
          // --- CRITICAL FIX END ---
        };

        // Find all currently open modals
        const openModals = document.querySelectorAll(".modal.show");

        if (openModals.length > 0) {
          // If there are open modals, ensure they are all hidden first
          let modalsToHideCount = openModals.length;
          let hiddenModalsCounter = 0;

          // Define a callback to show the success modal after all others have hidden
          const showSuccessAfterOthersHidden = () => {
            hiddenModalsCounter++;
            if (hiddenModalsCounter === modalsToHideCount) {
              displaySuccessModal();
            }
          };

          openModals.forEach((modalEl) => {
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
              // Listen for each modal to finish hiding
              modalEl.addEventListener(
                "hidden.bs.modal",
                showSuccessAfterOthersHidden,
                { once: true }
              );
              modalInstance.hide(); // Command it to hide
            } else {
              // If for some reason a modal is 'show' but not initialized,
              // just increment the counter and remove it.
              modalEl.remove();
              hiddenModalsCounter++;
            }
          });
        } else {
          // No modals are open, just show the success modal immediately.
          displaySuccessModal();
        }
      }
// REPLACES the "saveProfileBtn" click listener to handle FormData AND auto-refresh
      document
        .getElementById("saveProfileBtn")
        .addEventListener("click", async function () {

          const formData = new FormData();
          const userId = localStorage.getItem("userId");

          if (!userId) {
              showAlert("User session not found. Please log in again.", "error");
              return;
          }

          formData.append("userId", userId);

          // Personal Info
          formData.append("lastName", document.getElementById("lastName").value);
          formData.append("firstName", document.getElementById("firstName").value);
          formData.append("middleName", document.getElementById("middleName").value);
          formData.append("gender", document.getElementById("gender").value);

          // Academic Info
          // ---
          // === THIS IS THE FIX: Get studentId value directly ===
          // ---
          const studentIdValue = document.getElementById("studentId").value;
          formData.append("studentId", studentIdValue);
          // ---
          // === END OF FIX ===
          // ---
          formData.append("course", document.getElementById("program").value); 
          formData.append("major", document.getElementById("major").value);
          formData.append("yearLevel", document.getElementById("yearLevel").value);
          formData.append("schoolYear", document.getElementById("schoolYear").value);

          const yearGraduated = document.getElementById("yearGraduated").value;
          formData.append("yearGraduated", yearGraduated || null);

          // Contact Info
          formData.append("email", document.getElementById("email").value);
          formData.append("phone", document.getElementById("phone").value);

          // --- ADDED NEW FIELDS ---
          formData.append("campus", document.getElementById("campus").value);
          formData.append("dob", document.getElementById("dob").value);
          formData.append("pob", document.getElementById("pob").value);
          formData.append("nationality", document.getElementById("nationality").value);
          formData.append("home_address", document.getElementById("home_address").value);
          formData.append("previous_school", document.getElementById("previous_school").value);
          formData.append("primary_school", document.getElementById("primary_school").value);
          formData.append("secondary_school", document.getElementById("secondary_school").value);
          // --- END ADDED FIELDS ---

          // Get the file
          const schoolIdFile = document.getElementById("schoolIdPicture").files[0];
          if (schoolIdFile) {
            formData.append("school_id_picture", schoolIdFile);
          }

          // --- ⬇️ MODIFIED VALIDATION BLOCK ⬇️ ---

          // --- 1. ADD NEW, SPECIFIC VALIDATION FOR STUDENT ID ---
          const studentIdRegex = /^\d{3}-\d{4}-\d{6}$/;
          if (!studentIdRegex.test(studentIdValue)) {
            showAlert(
              "Invalid Student ID format. Please use 000-0000-000000.",
              "warning"
            );
            return; // Stop execution
          }
          // --- END OF NEW VALIDATION ---


          // --- 2. REMOVE studentId check from the main 'if' block ---
          if (
            !formData.get("lastName") ||
            !formData.get("firstName") ||
            !formData.get("gender") ||
            // !formData.get("studentId") || <-- THIS LINE IS REMOVED
            !formData.get("course") || 
            !formData.get("yearLevel") ||
            !formData.get("schoolYear") ||
            !formData.get("email") ||
            !formData.get("campus") ||
            !formData.get("dob") ||
            !formData.get("pob") ||
            !formData.get("nationality") ||
            !formData.get("home_address") ||
            !formData.get("primary_school") ||
            !formData.get("secondary_school") ||
            (!schoolIdFile && !userHasExistingId) // Validated ID check
          ) {
            // Updated error message
            showAlert( "Please fill in all required fields. The School ID Picture is required for first-time profile completion.", "warning" );
            return;
          }
          // --- ⬆️ END OF MODIFICATION ⬆️ ---

          try {
            const response = await fetch("/api/user/update-profile", {
              method: "POST",
              body: formData, 
            });

            const data = await response.json();

            if (data.success) {
              userProfileComplete = true;
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("profileUpdateModal")
              );
              if (modal) modal.hide();

              showAlert("Profile updated successfully!", "success");

              // await loadUserProfile(); // <-- THIS LINE WAS THE BUG. IT IS NOW REMOVED.

              // This function will now fetch the new data, update the
              // profile page, and hide the warning banners.
              await checkUserProfileStatus(); 

              if (window.profileSaveCallback) {
                window.profileSaveCallback();
                window.profileSaveCallback = null;
              }

            } else {
               showAlert("Error updating profile: " + data.message, "error");
            }
          } catch (error) {
            console.error("Error saving profile:", error);
            showAlert("Error updating profile. Please try again.", "error");
          }
        });

      // Setup real-time updates
      function setupRealTimeUpdates() {
        // Load requests every 30 seconds when on updates page
        autoRefreshInterval = setInterval(() => {
          if (document.getElementById("updates").classList.contains("active")) {
            loadUserRequests();
          }
        }, 30000);
      }

// Enhanced initialization
      document.addEventListener("DOMContentLoaded", async () => {
        // Check authentication first
        if (!checkAuthentication()) return;

        // ---
        // === STUDENT ID Auto-formatting ===
        // ---
        const studentIdInput = document.getElementById("studentId");
        if (studentIdInput) {
          studentIdInput.addEventListener("input", function (e) {
            let input = e.target.value.replace(/\D/g, ""); // Remove all non-digits
            let formattedInput = "";

            if (input.length > 0) {
              formattedInput = input.substring(0, 3);
            }
            if (input.length > 3) {
              formattedInput += "-" + input.substring(3, 7);
            }
            if (input.length > 7) {
              // 3 digits + 4 digits = 7. Max 6 in last part.
              formattedInput += "-" + input.substring(7, 13);
            }

            e.target.value = formattedInput;
          });
        }
        // ---
        // === END OF BLOCK ===
        // ---

        // Load user data
        const fullname = localStorage.getItem("fullname") || "User";
        const userId = localStorage.getItem("userId") || "N/A";
        if (!fullname || !userId) {
          // Not logged in → back to welcome page
          window.location.href = "/";
          return;
        }

        // Set profile information
        document.getElementById("profileName").textContent = fullname;

        // Check profile status (This will now also show modal if incomplete)
        await checkUserProfileStatus();

        checkNotificationStatus(); // Check for notifications on page load
        setInterval(checkNotificationStatus, 10000); // Check every 10 seconds

        // ---
        // === THIS IS THE FIX (LINE REMOVED) ===
        // === END OF FIX ===
        // ---


        // Setup auto-logout functionality
        setupActivityListeners();

        // Setup real-time updates
        setupRealTimeUpdates();

        // Load initial requests
        await loadUserRequests();

        // Section switching
        const navLinks = document.querySelectorAll(".nav-link");

        navLinks.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const target = link.getAttribute("data-target");
            showSection(target);
          });
        });

        // Navbar scroll effect
        window.addEventListener("scroll", function () {
          const navbar = document.querySelector(".navbar");
          if (window.scrollY > 10) {
            navbar.classList.add("scrolled");
          } else {
            navbar.classList.remove("scrolled");
          }
        });

        // Add logout button functionality
        const logoutBtn = document.querySelector(".btn-outline-danger");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function () {
            logout();
          });
        }

        // Clean up interval when page unloads
        window.addEventListener("beforeunload", () => {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
          }
        });
      });

      // 2. OPEN CATEGORY MODAL LOGIC
function openCategoryModal(category) {
  // Security checks
  if (!checkAuthentication() || !checkSession()) return;

  const container = document.getElementById("categoryItemsContainer");
  const title = document.getElementById("categoryModalTitle");

  // Update Title
  const titles = {
    'academic': 'Academic Records & Grades',
    'certifications': 'Certifications & Status',
    'graduation': 'Graduation & Credentials'
  };
  title.textContent = titles[category] || "Select Document";

  // Filter Data
  const items = Object.entries(servicesData).filter(([key, data]) => data.category === category);

  // Generate Accordion HTML
  let html = '';
  items.forEach(([name, data], index) => {
    const uniqueId = `collapse${index}`;
    // Check if item is already in the list (partial match for notes)
    const isSelected = selectedServicesList.some(s => s.startsWith(name));

    html += `
      <div class="accordion-item mb-2 border rounded shadow-sm">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#${uniqueId}">
            ${name}
            ${isSelected ? '<span class="badge bg-success ms-2"><i class="bi bi-check"></i> Added</span>' : ''}
          </button>
        </h2>
        <div id="${uniqueId}" class="accordion-collapse collapse" data-bs-parent="#categoryItemsContainer">
          <div class="accordion-body">
            <div class="row">
              <div class="col-md-7 border-end">
                <p class="mb-2"><strong>Description:</strong> ${data.description}</p>
                <p class="mb-1 text-muted small"><strong>Requirements:</strong></p>
                <ul class="small text-muted mb-2">
                  ${data.requirements.map(r => `<li>${r.name}</li>`).join('')}
                </ul>
              </div>
              <div class="col-md-5">
                <div class="alert alert-light border">
                  <div class="mb-1"><strong>Fee:</strong> <span class="text-danger">₱${data.price.toFixed(2)}</span></div>
                  <div class="mb-0"><strong>Time:</strong> ${data.time}</div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label small fw-bold text-secondary">Optional Note:</label>
                  <input type="text" class="form-control form-control-sm" 
                         id="note-${index}" 
                         placeholder="e.g. Purpose: Scholarship, or Specific Year">
                </div>

                <div class="d-grid">
                  <button class="btn ${isSelected ? 'btn-secondary' : 'btn-primary'}" 
                    onclick="addServiceFromModal('${name}', 'note-${index}')" 
                    ${isSelected ? 'disabled' : ''}>
                    ${isSelected ? 'Already Added' : '<i class="bi bi-plus-circle"></i> Add to Selection'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
  const modal = new bootstrap.Modal(document.getElementById("categoryModal"));
  modal.show();
}

// 3. ADD SERVICE WITH NOTE LOGIC
function addServiceFromModal(serviceName, noteInputId) {
  const noteInput = document.getElementById(noteInputId);
  const note = noteInput ? noteInput.value.trim() : "";

  // Append note to name if it exists: "Service Name [Note: ...]"
  let finalName = serviceName;
  if (note) {
    finalName = `${serviceName} [Note: ${note}]`;
  }

  if (!selectedServicesList.includes(finalName)) {
    selectedServicesList.push(finalName);
    updateSelectedCount();
    
    // UI Feedback
    showToast(`Added: ${finalName}`, "success");
    
    // Refresh the modal content to disable the button
    const currentCategory = servicesData[serviceName].category;
    
    // Close current modal instance then reopen to refresh
    // (Simple way to refresh state)
    const modalEl = document.getElementById("categoryModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    
    setTimeout(() => {
        openCategoryModal(currentCategory);
    }, 300);
  }
}


    </script>
  </body>
</html>
