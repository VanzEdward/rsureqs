<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Queue Management Dashboard</title>
    <link rel="stylesheet" href="assets/css/admindashb.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/improved_admindash.css" />
    <!-- MOVED THE OTHER STYLES IN THE IMPROVED_ADMINDASHB.CSS FOR BETTER ORGANIZATION -->
  </head>

  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <img
          src="/assets/img/updated_RegistrarLogo.jpg"
          width="50"
          height="50"
          alt="Office of the University Registrar"
          onerror="this.style.display='none'"
        />
        <div class="sidebar-title">Registrar Staff</div>
      </div>

      <div class="menu-item active" data-page="queue">
        <i class="bi bi-list-task menu-icon"></i>
        <span>Queue Management</span>
      </div>

      <div class="menu-item" data-page="documents">
        <i class="bi bi-file-earmark-text menu-icon"></i>
        <span>Service Requests</span>
      </div>

      <div class="menu-item" data-page="reports">
        <i class="bi bi-bar-chart menu-icon"></i>
        <span>Reports</span>
      </div>

      <div class="menu-item" data-page="settings">
        <i class="bi bi-gear menu-icon"></i>
        <span>Settings</span>
      </div>
      <div
        class="menu-item"
        data-page="staff-management"
        id="nav-staff-management"
        style="display: none"
      >
        <i class="bi bi-people-fill menu-icon"></i>
        <span>Staff Accounts</span>
      </div>

      <div class="request-card">
        <div class="request-number" id="totalRequestsToday">0</div>
        <div class="request-label">Request Today</div>
      </div>

      <div class="user-card">
        <div class="user-avatar" id="sidebarAvatar">...</div>
        <div class="user-info">
          <h4 id="sidebarStaffName">Loading...</h4>
          <p id="sidebarStaffRole">Registrar Staff</p>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div id="queue-page" class="page active">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win1-count" class="text-primary fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 1</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win2-count" class="text-warning fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 2</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win3-count" class="text-info fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 3</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100">
              <div
                class="card-body text-center d-flex flex-column justify-content-center"
              >
                <h2 id="win4-count" class="text-danger fw-bold mb-0">0</h2>
                <p class="text-muted small mb-0">Window 4</p>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h3 class="section-title fs-5 mb-3">Newly Processing Request</h3>
            <div
              id="current-serving-container"
              class="current-serving-container"
            >
              <div class="card shadow-sm">
                <div class="card-body text-center text-muted py-4">
                  <i class="bi bi-hourglass-split mb-2 fs-3"></i>
                  <p class="mb-0">Loading status...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h3 class="section-title fs-5 mb-3">New Requests</h3>
            <div
              class="requests-container-bg"
              style="
                background-color: #f0f2f5;
                border-radius: 12px;
                padding: 20px;
                min-height: 200px;
              "
            >
              <div
                id="requests-list"
                class="requests-scroll-area"
                style="max-height: 400px; overflow-y: auto"
              >
                <div id="no-requests-msg" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-3"></i>
                  <p class="mb-0 mt-2">No New Requests</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-12">
            <h3 class="section-title fs-5 mb-3">All Requests Being Served</h3>
            <div
              class="requests-container-bg"
              style="
                background-color: #f0f2f5;
                border-radius: 12px;
                padding: 20px;
                min-height: 100px;
                margin-bottom: 20px;
              "
            >
              <div
                id="all-processing-list"
                class="requests-scroll-area"
                style="max-height: 250px; overflow-y: auto"
              >
                <div id="no-processing-msg" class="text-center text-muted py-4">
                  <i class="bi bi-person-slash fs-3"></i>
                  <p class="mb-0 mt-2">No Requests Currently in Progress</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Service Request Page -->
      <div id="documents-page" class="page">
        <div
          class="header d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4"
        >
          <h1 class="mb-0 fs-4 fw-bold">Service Request Management</h1>

          <div
            class="search-wrapper d-flex align-items-center shadow-sm"
            style="border-radius: 50px; overflow: hidden; background: #f8f9fa"
          >
            <input
              type="text"
              id="serviceRequestSearchInput"
              class="form-control border-0 bg-transparent"
              style="
                height: 40px;
                padding: 0 16px;
                outline: none;
                box-shadow: none;
              "
              placeholder="Search..."
            />
            <button
              class="btn btn-primary"
              id="serviceRequestSearchBtn"
              type="button"
              style="
                height: 40px;
                width: 48px;
                border-radius: 50px;
                border: none;
                margin-left: -1px;
              "
            >
              <i class="bi bi-search text-white"></i>
            </button>
          </div>
        </div>

        <div id="onQueueContainer" class="mb-5"></div>
        <div id="processingRequestsContainer" class="mb-5"></div>

        <hr class="border-secondary opacity-10 my-4" />

        <h3 class="section-title fs-6 text-secondary fw-bold mb-3">
          <i class="bi bi-clock-history me-2"></i>History (This Session)
        </h3>
        <div id="completedRequestsContainer" class="mb-4"></div>
      </div>

      <!-- Reports Page -->
      <div id="reports-page" class="page">
        <div class="header">
          <h1>Analytics Dashboard</h1>
        </div>

        <div class="analytics-grid">
          <div class="summary-card">
            <div class="summary-number" id="totalRequestsSummary">0</div>
            <div class="summary-label">Total Today's Request</div>
          </div>
          <div class="summary-card">
            <div class="summary-number" id="completedSummary">0</div>
            <div class="summary-label">Completed Today</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="info-card">
            <h3>Client Satisfaction Rating</h3>
            <p style="font-size: 14px; color: #666">
              Based on SQD0 (Overall Satisfaction).
            </p>
            <div
              class="chart-container"
              style="position: relative; height: 250px; width: 100%"
            >
              <canvas id="satisfactionChart"></canvas>
            </div>
          </div>

          <div class="info-card">
            <h3>
              Recent Client Requests <span style="color: #999">(Today)</span>
            </h3>
            <ul class="request-list" id="recentRequestsList"></ul>
          </div>
        </div>

        <div class="history-table" id="queueReportHistoryContainer">
          <h2 class="history-title">Queue Report History</h2>
          <div
            class="history-item empty"
            style="text-align: center; color: #999; padding: 20px 0"
          >
            No reports found.
          </div>
        </div>
      </div>

      <div id="report-detail-page" class="page">
        <div class="header">
          <h1>Queue Report Details</h1>
          <button class="btn btn-secondary" onclick="showPage('reports')">
            <i class="bi bi-arrow-left"></i> Back to Reports
          </button>
        </div>

        <div class="history-section mt-4 bg-white p-4 rounded shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="history-title mb-0">Queue Report History</h2>
            <div id="historyBreadcrumbs" class="text-muted small"></div>
          </div>

          <div id="historyContentArea">
            <div class="text-center py-5">
              <div class="spinner-border text-primary"></div>
              <p class="mt-2 text-muted">Loading history...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Detail Report Page
      <div id="report-detail-page" class="page">
        <div class="header">
          <h1>Queue Report Details</h1>
          <button class="btn btn-secondary" onclick="showPage('reports')">
            <i class="bi bi-arrow-left"></i> Back to Reports
          </button>
        </div>

        <div class="report-header">
          <h2 class="report-title">Queue Report History</h2>
          <div class="report-date">Friday 8am-4pm<br />August 5, 2025</div>

          <div class="service-summary">
            <h3 class="summary-title">Overall Service Requested</h3>
            <div class="summary-grid">
              <div>
                <div class="service-item">
                  <span class="service-name">Transcript of Grades:</span>
                  <span class="service-count">2</span>
                </div>
                <div class="service-item">
                  <span class="service-name">Certification of Grade Form:</span>
                  <span class="service-count">7</span>
                </div>
                <div class="service-item">
                  <span class="service-name">Adding/Dropping Subjects:</span>
                  <span class="service-count">3</span>
                </div>
              </div>
              <div>
                <div class="service-item">
                  <span class="service-name">Signature Related Services:</span>
                  <span class="service-count">26</span>
                </div>
                <div class="service-item">
                  <span class="service-name">Grade Slip:</span>
                  <span class="service-count">11</span>
                </div>
              </div>
            </div>

            <div class="total-requests">
              <div class="total-label">Total Requests</div>
              <div class="total-number">52</div>
            </div>
          </div>
        </div>

        <div class="data-table">
          <div class="table-section">
            <div class="table-header-title">Transcript of Grades</div>
            <div class="table-row header-row">
              <div class="table-cell header">Name</div>
              <div class="table-cell header">Year/Course/Major</div>
              <div class="table-cell header">Year Graduated</div>
              <div class="table-cell header">Student ID</div>
            </div>
            <div class="table-row">
              <div class="table-cell">Sarah Jane Maralo</div>
              <div class="table-cell">N/A</div>
              <div class="table-cell">2024</div>
              <div class="table-cell">2019-0987654</div>
            </div>
          </div>
        </div>
      </div> -->

      <!-- --------------------------------------------- SETTINGS PAGE ------------------------------------------------->
      <div id="settings-page" class="page">
        <div class="header">
          <h1>Settings</h1>
        </div>

        <div class="settings-section">
          <div
            class="staff-info-card"
            style="
              box-shadow: none;
              padding: 0;
              margin-bottom: 20px;
              background: transparent;
            "
          >
            <div class="staff-header d-flex align-items-center mb-3">
              <div class="staff-avatar">
                <span id="staffAvatarInitials">AD</span>
              </div>
              <div>
                <h4 id="staffFullName" class="mb-1">Loading...</h4>
                <p class="text-muted mb-0" id="staffEmail">Loading...</p>
                <span class="badge bg-primary" id="staffRole">Loading...</span>
              </div>
            </div>

            <div class="staff-details">
              <div class="row">
                <div class="col-md-6">
                  <p>
                    <strong>Department:</strong>
                    <span id="staffDepartment">Loading...</span>
                  </p>
                  <p>
                    <strong>Phone:</strong>
                    <span id="staffPhone">Loading...</span>
                  </p>
                </div>
                <div class="col-md-6">
                  <p>
                    <strong>Last Login:</strong>
                    <span id="staffLastLogin">Loading...</span>
                  </p>
                  <p>
                    <strong>Member Since:</strong>
                    <span id="staffMemberSince">Loading...</span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <button class="btn-logout" onclick="handleLogout()">
            <i class="bi bi-box-arrow-right"></i> Log out
          </button>
        </div>

        <div class="settings-section">
          <h2 class="settings-section-title">Manage Queue System Settings</h2>

          <div class="settings-item" onclick="toggleFontSize()">
            <div class="settings-item-icon">Aa</div>
            <span>Change Font Size</span>
            <span class="settings-value" id="fontSizeValue">Medium</span>
          </div>
          <div
            class="settings-item d-flex align-items-center justify-content-between"
          >
            <div class="d-flex align-items-center">
              <i class="bi bi-moon-stars-fill me-2"></i>
              <div>
                <div>Dark Mode</div>
                <small class="text-muted"
                  >Toggle between light and dark theme</small
                >
              </div>
            </div>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="darkModeSwitch"
              />
              <label class="form-check-label" for="darkModeSwitch"></label>
            </div>
          </div>
        </div>
      </div>

      <div id="staff-management-page" class="page">
        <div
          class="header d-flex justify-content-between align-items-center mb-4"
        >
          <h1>Staff Account Management</h1>
          <button
            class="btn btn-success"
            onclick="toggleModal('registerStaffModal')"
          >
            <i class="bi bi-plus-lg"></i> Register New Staff
          </button>
        </div>

        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="p-3 ps-4">Staff Name</th>
                    <th class="p-3">Role</th>
                    <th class="p-3">Department</th>
                    <th class="p-3">Current Status</th>
                    <th class="p-3 text-end pe-4">Actions</th>
                  </tr>
                </thead>
                <tbody id="staffListContainer"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- --------------------------------------------- SETTING'S MODALS HERE ------------------------------------------------->

    <!-- Account Details Modal -->
    <div id="accountDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Registrar Staff Account Details</h3>
          <span class="modal-close" onclick="toggleModal('accountDetailsModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" value="Jila Santos" class="form-input" />
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input
              type="email"
              value="jila.santos@rsu.edu"
              class="form-input"
            />
          </div>
          <div class="form-group">
            <label>Role</label>
            <input
              type="text"
              value="Registrar Staff"
              class="form-input"
              disabled
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('accountDetailsModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveAccountDetails()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Manage Account Password</h3>
          <span class="modal-close" onclick="toggleModal('passwordModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Current Password</label>
            <input
              type="password"
              class="form-input"
              placeholder="Enter current password"
            />
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input
              type="password"
              class="form-input"
              placeholder="Enter new password"
            />
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input
              type="password"
              class="form-input"
              placeholder="Confirm new password"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('passwordModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="changePassword()">
            Change Password
          </button>
        </div>
      </div>
    </div>

    <!-- Approve Request Modal -->
    <div id="approveRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Approve Service Request</h3>
          <span class="modal-close" onclick="toggleModal('approveRequestModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="approveRequestId" />
          <div class="form-group">
            <label>Request Details</label>
            <div id="approveRequestDetails" class="request-details-preview">
              <!-- Request details will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label>Admin Notes (Optional)</label>
            <textarea
              id="approveNotes"
              class="form-input"
              rows="3"
              placeholder="Add any notes for the student..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('approveRequestModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-success"
            onclick="serviceRequestManager.confirmApproveRequest()"
          >
            Approve Request
          </button>
        </div>
      </div>
    </div>

    <!-- Decline Request Modal -->
    <div id="declineRequestModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Decline Service Request</h3>
          <span class="modal-close" onclick="toggleModal('declineRequestModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="declineRequestId" />
          <div class="form-group">
            <label>Request Details</label>
            <div id="declineRequestDetails" class="request-details-preview">
              <!-- Request details will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label
              >Reason for Declining <span style="color: red">*</span></label
            >
            <textarea
              id="declineReason"
              class="form-input"
              rows="4"
              placeholder="Please provide a clear reason for declining this request..."
              required
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('declineRequestModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-danger"
            onclick="serviceRequestManager.confirmDeclineRequest()"
          >
            Decline Request
          </button>
        </div>
      </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3>Service Request Details</h3>
          <span class="modal-close" onclick="toggleModal('requestDetailsModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <div id="requestDetailsContent">
            <!-- Request details will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('requestDetailsModal')"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <div
      id="windowSelectionModal"
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div
          class="modal-content shadow-lg"
          style="border-radius: 15px; border: none"
        >
          <div class="modal-header justify-content-center border-0 pt-4">
            <h4 class="m-0 fw-bold text-primary">Select Your Window</h4>
          </div>
          <div class="modal-body px-4 pb-4">
            <p class="text-muted text-center mb-4">
              Please select which window you are assigned to for this session.
            </p>
            <div class="d-grid gap-3">
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 1', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 1
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 2', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 2
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 3', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 3
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                onclick="selectWindow('Window 4', event)"
              >
                <i class="bi bi-display me-3 fs-5"></i> Window 4
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="windowDetailsModal"
      class="modal fade"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div
          class="modal-content border-0 shadow-lg"
          style="max-width: 800px; width: 100%"
        >
          <div class="modal-header bg-light border-0">
            <h5
              class="modal-title fw-bold text-primary"
              id="windowDetailsTitle"
            >
              Window Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div
            class="modal-body p-4"
            style="
              background-color: #f8f9fa;
              max-height: 60vh;
              overflow-y: auto;
            "
          >
            <div id="windowDetailsList"></div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <button
              type="button"
              class="btn btn-secondary px-4"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="editStaffModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Staff Account</h3>
          <span class="modal-close" onclick="toggleModal('editStaffModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="editStaffId" />
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="editStaffName" class="form-input" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="editStaffEmail" class="form-input" />
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="text" id="editStaffPhone" class="form-input" />
          </div>
          <div class="form-group">
            <label>Department</label>
            <input type="text" id="editStaffDept" class="form-input" />
          </div>
          <div class="form-group">
            <label>Role</label>
            <select id="editStaffRole" class="form-select form-input">
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label>Reset Password (Optional)</label>
            <input
              type="password"
              id="editStaffPassword"
              class="form-input"
              placeholder="Leave blank to keep current"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('editStaffModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="staffManager.updateStaff()">
            Save Changes
          </button>
        </div>
      </div>
    </div>
    <div id="registerStaffModal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3>Register New Staff Member</h3>
          <span class="modal-close" onclick="toggleModal('registerStaffModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <form id="dashboardRegisterForm">
            <div class="row mb-3">
              <div class="col-md-5">
                <label class="form-label"
                  >Last Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-input"
                  id="regLastName"
                  required
                />
              </div>
              <div class="col-md-5">
                <label class="form-label"
                  >First Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-input"
                  id="regFirstName"
                  required
                />
              </div>
              <div class="col-md-2">
                <label class="form-label">M.I.</label>
                <input
                  type="text"
                  class="form-input"
                  id="regMiddleInitial"
                  maxlength="2"
                  placeholder="Opt"
                />
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label"
                  >Phone <span class="text-danger">*</span></label
                >
                <input
                  type="tel"
                  class="form-input"
                  id="regPhone"
                  placeholder="09..."
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label"
                  >Sex <span class="text-danger">*</span></label
                >
                <select class="form-select form-input" id="regSex" required>
                  <option value="" selected disabled>Select...</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label"
                >Email (Username) <span class="text-danger">*</span></label
              >
              <input type="email" class="form-input" id="regEmail" required />
            </div>
            <div class="mb-3">
              <label class="form-label"
                >Permanent Address <span class="text-danger">*</span></label
              >
              <input type="text" class="form-input" id="regAddress" required />
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label"
                  >Password <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control form-input"
                    id="regPassword"
                    required
                    style="border-right: 0"
                  />
                  <span
                    class="input-group-text bg-white"
                    style="cursor: pointer; border-left: 0"
                    onclick="toggleRegPassword('regPassword', this)"
                  >
                    <i class="bi bi-eye"></i>
                  </span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label"
                  >Confirm Password <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control form-input"
                    id="regConfirmPassword"
                    required
                    style="border-right: 0"
                  />
                  <span
                    class="input-group-text bg-white"
                    style="cursor: pointer; border-left: 0"
                    onclick="toggleRegPassword('regConfirmPassword', this)"
                  >
                    <i class="bi bi-eye"></i>
                  </span>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('registerStaffModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-success"
            onclick="submitNewStaffRegistration()"
          >
            Create Account
          </button>
        </div>
      </div>
    </div>

    <div id="progressModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Update Request Progress</h3>
          <span class="modal-close" onclick="toggleModal('progressModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="progressQueueId" />

          <div class="alert alert-info small mb-3">
            <i class="bi bi-info-circle-fill"></i>
            Check off each day as work is completed. You can only "Mark as Done"
            when progress is 100%.
          </div>

          <div class="mb-3">
            <strong>Target Duration:</strong>
            <span id="progressDurationLabel">5 Days</span>
          </div>

          <div
            id="progressCheckboxes"
            class="d-flex flex-column gap-2 mb-3"
            style="max-height: 300px; overflow-y: auto"
          ></div>

          <div class="progress mt-3" style="height: 25px">
            <div
              id="modalProgressBar"
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%"
            >
              0%
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('progressModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="queueManager.saveProgress()">
            Save Progress
          </button>
        </div>
      </div>
    </div>

    <!-- Mark as Done Modal -->
    <div id="markDoneModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header bg-success text-white">
          <h3 class="text-white">
            <i class="bi bi-check-circle-fill me-2"></i> Complete Request
          </h3>
          <span
            class="modal-close text-white"
            onclick="toggleModal('markDoneModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="markDoneQueueId" />

          <div class="text-center mb-4">
            <div
              class="avatar-circle bg-success text-white mx-auto mb-2"
              style="
                width: 60px;
                height: 60px;
                font-size: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
              "
            >
              <i class="bi bi-person-check"></i>
            </div>
            <h5 class="fw-bold">Processing Completed</h5>
            <p class="text-muted">
              You are about to mark this request as done.
            </p>
          </div>

          <div class="mb-3">
            <label
              class="form-label small fw-bold text-uppercase text-secondary"
              >Processed By</label
            >
            <div class="form-control bg-light" id="markDoneStaffName">
              <!-- Staff Name will be injected here -->
            </div>
          </div>

          <div class="mb-3">
            <label
              class="form-label small fw-bold text-uppercase text-secondary"
              >Optional Message / Instructions</label
            >
            <textarea
              class="form-control"
              id="markDoneMessage"
              rows="3"
              placeholder="E.g. Please proceed to Window 3 to claim your document..."
            ></textarea>
            <div class="form-text">
              This message will be visible to the student on their dashboard.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="toggleModal('markDoneModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-success"
            onclick="queueManager.confirmMarkAsDone()"
          >
            Confirm Completion
          </button>
        </div>
      </div>
    </div>

    <div id="confirmServeModal" class="modal">
      <div class="modal-content" style="max-width: 450px">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-person-check-fill me-2"></i> Confirm Action
          </h5>
          <span
            class="modal-close text-white"
            onclick="toggleModal('confirmServeModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body text-center">
          <input type="hidden" id="serveQueueId" />

          <div class="mb-3">
            <div
              class="avatar-circle bg-light text-primary mx-auto mb-2"
              style="
                width: 70px;
                height: 70px;
                font-size: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
              "
            >
              <i class="bi bi-person-up"></i>
            </div>
            <h5 class="fw-bold" id="serveClientName">Student Name</h5>
            <span class="badge bg-primary fs-6 mb-2" id="serveQueueNumber"
              >A-000</span
            >
          </div>

          <p class="text-muted">
            Are you sure you want to serve this client at
            <strong class="text-dark" id="serveWindowName">Window X</strong>?
          </p>

          <div class="alert alert-warning small d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
              This will move the request to "Now Serving" on the TV screen.
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-center">
          <button
            class="btn btn-secondary px-4"
            onclick="toggleModal('confirmServeModal')"
          >
            Cancel
          </button>
          <button
            class="btn btn-primary px-4 fw-bold"
            onclick="queueManager.confirmStartProcessing()"
          >
            Yes, Serve Client
          </button>
        </div>
      </div>
    </div>
    <div id="reviewRequestModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header bg-primary text-white">
          <h3><i class="bi bi-search me-2"></i> Review Requirements</h3>
          <span
            class="modal-close text-white"
            onclick="toggleModal('reviewRequestModal')"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <input type="hidden" id="reviewQueueId" />

          <div
            class="alert alert-light border d-flex justify-content-between align-items-center mb-4"
          >
            <div class="d-flex align-items-center">
              <div
                class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-3"
                style="width: 45px; height: 45px"
              >
                <i class="bi bi-person-fill fs-4"></i>
              </div>
              <div>
                <h5 class="mb-0 fw-bold text-dark" id="reviewStudentName">
                  Student Name
                </h5>
                <small class="text-muted" id="reviewStudentId"
                  >ID: 000-000</small
                >
              </div>
            </div>
            <span class="badge bg-primary fs-4 px-3" id="reviewQueueNumber"
              >A-001</span
            >
          </div>

          <div class="mb-4">
            <h6 class="fw-bold text-secondary text-uppercase small mb-2">
              <i class="bi bi-cart-check-fill me-1"></i> Requested Services
            </h6>
            <div
              id="reviewServicesContainer"
              class="d-flex flex-wrap gap-2 p-3 bg-light rounded border"
            ></div>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-secondary text-uppercase small mb-2">
              <i class="bi bi-folder-fill me-1"></i> Submitted Attachments
            </h6>
            <div
              id="reviewFilesContainer"
              class="bg-white p-2 rounded border"
              style="min-height: 100px"
            ></div>
          </div>

          <div
            id="declineReasonContainer"
            class="mt-3 p-3 bg-danger bg-opacity-10 border border-danger rounded"
            style="display: none"
          >
            <label class="text-danger fw-bold mb-1"
              >Reason for Rejection:</label
            >
            <textarea
              id="reviewDeclineReason"
              class="form-control border-danger"
              rows="2"
              placeholder="E.g., Incorrect file uploaded, blurred image..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button
            class="btn btn-outline-danger"
            onclick="queueManager.toggleDeclineInput()"
          >
            <i class="bi bi-x-circle"></i> Reject / Cancel
          </button>

          <div id="reviewActionButtons">
            <button
              class="btn btn-secondary"
              onclick="toggleModal('reviewRequestModal')"
            >
              Cancel Review
            </button>
            <button
              class="btn btn-success fw-bold px-4"
              onclick="queueManager.submitDecision('process')"
            >
              <i class="bi bi-check-circle"></i> Accept & Process
            </button>
          </div>

          <div id="declineConfirmButtons" style="display: none">
            <button
              class="btn btn-secondary"
              onclick="queueManager.toggleDeclineInput()"
            >
              Back
            </button>
            <button
              class="btn btn-danger fw-bold"
              onclick="queueManager.submitDecision('decline')"
            >
              Confirm Rejection
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="filePreviewModal" class="modal" style="z-index: 1060">
      <div
        class="modal-content"
        style="
          max-width: 90%;
          height: 90vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          class="modal-header bg-dark text-white d-flex justify-content-between align-items-center p-3"
        >
          <h5
            class="m-0 text-truncate"
            id="previewFileName"
            style="max-width: 80%"
          >
            Document Preview
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            onclick="toggleModal('filePreviewModal')"
          ></button>
        </div>

        <div
          class="modal-body p-0 bg-light d-flex justify-content-center align-items-center"
          style="flex-grow: 1; overflow: hidden; position: relative"
        >
          <div id="previewContent" style="width: 100%; height: 100%"></div>
        </div>

        <div class="modal-footer bg-white p-2 justify-content-center">
          <button
            class="btn btn-secondary px-5"
            onclick="toggleModal('filePreviewModal')"
          >
            Close Preview
          </button>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="imagePreviewModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent shadow-none border-0">
          <div class="modal-header border-0 p-2">
            <button
              type="button"
              class="btn-close btn-close-white ms-auto"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-0 text-center">
            <img
              src=""
              id="previewImageTarget"
              class="img-fluid rounded shadow-lg"
              style="max-height: 85vh; object-fit: contain"
              alt="Expanded Proof"
            />
          </div>
        </div>
      </div>
    </div>
    <!-- --------------------------------------------- END OF MANUAL TRANSACTION MODAL ------------------------------------------------->

    <!-- Add Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
      // -------------------------- BOOTSTRAP OFFCANVAS SIDEBAR FOR MOBILE USING OFFCANVAS COMPONENT--------------------------------------

      // Initialize Bootstrap Offcanvas for sidebar on mobile
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.addEventListener("click", () => {
          const offcanvasEl = document.getElementById("sidebarOffcanvas");
          const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
          if (bsOffcanvas && window.innerWidth <= 768) {
            bsOffcanvas.hide();
          }
        });
      });
      // Keep your existing navigation setup but update it to work with Bootstrap
      function setupNavigation() {
        const menuItems = document.querySelectorAll(".menu-item");
        menuItems.forEach((item) => {
          item.addEventListener("click", () => {
            const targetPage = item.getAttribute("data-page");
            // Remove active class from all menu items and pages
            menuItems.forEach((mi) => mi.classList.remove("active"));
            document
              .querySelectorAll(".page")
              .forEach((page) => page.classList.remove("active"));
            // Add active class to clicked item
            item.classList.add("active");
            // Show target page
            showPage(targetPage);
            // On mobile, the offcanvas will auto-close due to data-bs-dismiss="offcanvas"
          });
        });
      }
      // -------------------------- END OF BOOTSTRAP OFFCANVAS SIDEBAR FOR MOBILE USING OFFCANVAS COMPONENT--------------------------------------

      // -------------------------- SHOW PAGE FUNCTION TO HANDLE PAGE NAVIGATION -----------------------------------------------------
      function showPage(page) {
        // Hide all pages
        document.querySelectorAll(".page").forEach((p) => {
          p.classList.remove("active");

          // Clear search bar if leaving documents page
          if (p.id === "documents-page") {
            const searchInput = document.getElementById(
              "serviceRequestSearchInput"
            );
            if (searchInput && searchInput.value !== "") {
              searchInput.value = "";
              const searchBtn = document.getElementById(
                "serviceRequestSearchBtn"
              );
              if (searchBtn) searchBtn.click();
            }
          }
        });

        // Show target page
        const pageToShow = document.getElementById(page + "-page");

        if (pageToShow) {
          pageToShow.classList.add("active");

          // Refresh data for specific pages
          if (page === "queue" && queueManager) {
            queueManager.loadQueues();
          } else if (page === "documents" && serviceRequestManager) {
            serviceRequestManager.loadServiceRequests();
          } else if (page === "reports") {
            updateReportsData();

            // Update charts from managers if they exist
            if (queueManager)
              queueManager.loadQueues().then(() => updateReportsData());
            if (serviceRequestManager)
              serviceRequestManager
                .loadServiceRequests()
                .then(() => updateReportsData());

            //  NEW: LOAD HISTORY MANAGER 
            // This initializes the Month/Week/Day view you requested
            if (typeof historyManager !== "undefined") {
              historyManager.loadHistory();
            }
          } else if (page === "github") {
            loadGitHubData();
          } else if (page === "staff-management") {
            if (typeof staffManager !== "undefined") {
              staffManager.loadAllStaff();
            }
          }
        } else {
          // This 'else' handles cases where the page ID doesn't exist
          console.error("Page not found:", page);
          // Fallback to queue page
          const fallback = document.getElementById("queue-page");
          if (fallback) fallback.classList.add("active");
        }
      }
      // -------------------------- END SHOW PAGE FUNCTION -----------------------------------------------------

      // -------------------------- END SHOW PAGE FUNCTION TO HANDLE PAGE NAVIGATION -----------------------------------------------------

      // Initialize managers
      let serviceRequestManager;
      let queueManager;
      let isQueuePaused = false;
      let fcrChartInstance = null;
      let currentWindow = null;
      let windowSelectionModalObj = null;

      // ---------------------------------------------------
      //  SERVICE DURATION MAPPING (in Days) 
      // These names MUST match the keys in dashboard.html
      // ---------------------------------------------------
      const SERVICE_DURATIONS = {
        "Transcript of Records": 7,
        "Certificate of Grades": 7,
        "Certificate of Units Earned": 5,
        "Certificate of Enrolment": 5,
        "Certificate of Honors": 5, // Fixed name
        "Certificate of Upper 25": 14,
        "Certificate of English as Medium": 5, // Fixed name
        "Certificate of Graduation": 5,
        "Diploma (Duplicate Copy)": 30,
        "CAV (CHED/DFA)": 5, // Fixed name
        "Transfer Credentials": 5,
      };

      // Admin Dashboard Authentication Helper
      const adminToken = localStorage.getItem("adminToken");
      console.log(
        "Admin token from localStorage:",
        adminToken ? "Present" : "Missing"
      );
      let currentStaff = null;
      // Function to make authenticated API calls
      function makeAuthenticatedRequest(url, options = {}) {
        if (!adminToken) {
          console.error("No admin token found, redirecting to login");
          adminLogout();
          return Promise.reject("No admin token");
        }
        const defaultOptions = {
          headers: {
            Authorization: `Bearer ${adminToken}`,
            "Content-Type": "application/json",
            ...options.headers,
          },
        };
        console.log("Making authenticated request to:", url);
        return fetch(url, { ...defaultOptions, ...options });
      }

      // ---------------------------------------------------------
      // BLOCK 1: Display Staff Info & Handle Super Admin (FIXED)
      // ---------------------------------------------------------
      function displayStaffInfo(staff) {
        currentStaff = staff; // Update global variable

        // 1. Update Sidebar Name
        const sidebarNameEl = document.getElementById("sidebarStaffName");
        if (sidebarNameEl) {
          sidebarNameEl.textContent = staff.full_name;
        }

        // 2. Update Sidebar Role
        const sidebarRoleEl = document.getElementById("sidebarStaffRole");
        if (sidebarRoleEl) {
          const formattedRole = staff.role
            .replace("_", " ")
            .replace(/\b\w/g, (s) => s.toUpperCase());
          sidebarRoleEl.textContent = formattedRole;
        }

        // 3. Update Sidebar Avatar Initials
        const sidebarAvatarEl = document.getElementById("sidebarAvatar");
        let initials = "AD"; // Default
        if (sidebarAvatarEl) {
          if (staff.first_name && staff.last_name) {
            initials = (
              staff.first_name.charAt(0) + staff.last_name.charAt(0)
            ).toUpperCase();
          } else if (staff.full_name) {
            initials = staff.full_name.substring(0, 2).toUpperCase();
          }
          sidebarAvatarEl.textContent = initials;
        }

        // 4. Update Settings Page Details (FIXED SECTION)
        if (document.getElementById("staffFullName"))
          document.getElementById("staffFullName").textContent =
            staff.full_name;

        if (document.getElementById("staffEmail"))
          document.getElementById("staffEmail").textContent = staff.email;

        if (document.getElementById("staffRole"))
          document.getElementById("staffRole").textContent = staff.role
            .replace("_", " ")
            .toUpperCase();

        if (document.getElementById("staffDepartment"))
          document.getElementById("staffDepartment").textContent =
            staff.department || "Not Specified";

        if (document.getElementById("staffPhone"))
          document.getElementById("staffPhone").textContent =
            staff.phone || "Not Specified";

        if (document.getElementById("staffLastLogin"))
          document.getElementById("staffLastLogin").textContent =
            staff.last_login
              ? new Date(staff.last_login).toLocaleString()
              : "First Login";

        if (document.getElementById("staffMemberSince"))
          document.getElementById("staffMemberSince").textContent =
            staff.created_at
              ? new Date(staff.created_at).toLocaleDateString()
              : "N/A";

        // Update Avatar in Settings Page to match Sidebar
        if (document.getElementById("staffAvatarInitials"))
          document.getElementById("staffAvatarInitials").textContent = initials;

        //  5. SUPER ADMIN CHECK 
        if (staff.role === "super_admin") {
          console.log(" Super Admin Detected");

          // A. Show the "Staff Accounts" tab in sidebar
          const staffNav = document.getElementById("nav-staff-management");
          if (staffNav) staffNav.style.display = "flex";

          // B. Force "Supervisor" mode (Bypasses Window Selection)
          localStorage.setItem("assignedWindow", "Supervisor");
          currentWindow = "Supervisor";

          // Update UI to show Supervisor mode
          const winDisplay = document.getElementById("currentWindowDisplay");
          if (winDisplay) winDisplay.textContent = "Supervisor";

          const sidebarTitle = document.querySelector(".sidebar-title");
          if (sidebarTitle)
            sidebarTitle.innerHTML = `Super Admin<br><small style="font-size:11px; color:#ccc;">Supervisor View</small>`;

          // C. Load staff data immediately
          if (typeof staffManager !== "undefined") {
            staffManager.loadAllStaff();
          }
        }
      }

      // Check authentication on page load
      // Check authentication on page load
      if (!adminToken) {
        window.location.href = "/adminLogin";
      } else {
        console.log("Admin token found, verifying...");
        // Verify token is still valid on page load
        makeAuthenticatedRequest("/api/admin/me")
          .then((response) => {
            console.log("Auth check response status:", response.status);
            return response.json();
          })
          .then((data) => {
            console.log("Auth check response:", data);
            if (!data.success) {
              console.log("Token invalid, logging out");
              adminLogout();
            } else {
              console.log("Admin logged in:", data.admin);

              // 1. Update Sidebar info (Name, Role, Avatar)
              displayStaffInfo(data.admin);

              // 2. Load initial data
              if (queueManager) {
                queueManager.loadQueues();
              }
              if (serviceRequestManager) {
                serviceRequestManager.loadServiceRequests();
              }

              //  3. PASTE THIS HERE: CHECK WINDOW ASSIGNMENT 
              // We call this here because we need 'currentStaff' (set in displayStaffInfo)
              // to be ready so we know if they are a Super Admin or not.
              checkWindowAssignment();
            }
          })
          .catch((error) => {
            console.error("Auth check failed:", error);
            adminLogout();
          });
      }

      // Admin logout function
      function adminLogout() {
        localStorage.removeItem("admin");
        localStorage.removeItem("adminToken");
        localStorage.removeItem("assignedWindow"); // Clear client-side cache
        window.location.href = "/adminLogin";
      }

      // Global function to unassign the window
      async function unassignWindowOnServer(windowToUnassign) {
        // Use the passed argument, or fall back to the global variable
        const targetWindow = windowToUnassign || currentWindow;

        if (targetWindow && adminToken) {
          try {
            console.log("Attempting to unassign:", targetWindow);
            await makeAuthenticatedRequest("/api/admin/unassign-window", {
              method: "POST",
              body: JSON.stringify({ windowNumber: targetWindow }),
            });
            console.log("Server unassign success");
          } catch (e) {
            console.warn("Failed to unassign window on server.", e);
          }
        }
        // Clear client-side state
        currentWindow = null;
        localStorage.removeItem("assignedWindow");
      }

      // Navigation functionality
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Admin dashboard initialized");

        //  FIX: REMOVED the line localStorage.removeItem("assignedWindow");
        // This allows the browser to remember the window on refresh.

        // Initialize managers
        serviceRequestManager = new ServiceRequestManager();
        queueManager = new QueueManager();
        // Pre-load data in the background on page load
        serviceRequestManager.loadServiceRequests();
        queueManager.loadQueues();

        // Set up navigation
        setupNavigation();

        // Show initial page
        showPage("queue");

        // Load preferences
        loadPreferences();

        // Set up enhanced auto-refresh
        setupEnhancedAutoRefresh();

        //  FIX: Ensure window check runs after everything else is ready 
        // This function will now check local storage first before showing the modal.
        // checkWindowAssignment();
      });

      //  FIXED: Loads History Manager when opening details 
      function showReportDetail(reportId) {
        // 1. Navigate to the detail page
        showPage("report-detail");

        // 2. Trigger the History Loader
        if (typeof historyManager !== "undefined") {
          historyManager.loadHistory();
        }
      }
      //  END OF REPLACEMENT 

      function toggleQueuePause() {
        isQueuePaused = !isQueuePaused;
        const btn = document.getElementById("pauseQueueBtn");
        if (isQueuePaused) {
          btn.innerHTML = " Resume Queue";
          showNotification("Queue processing paused", "warning");
        } else {
          btn.innerHTML = " Pause Queue";
          showNotification("Queue processing resumed", "success");
        }
      }

      function updateReportsData() {
        // Update report statistics

        // 1. Update from Queue Manager
        if (queueManager && queueManager.queues) {
          //  FIX: Calculate totals using ALL statuses (including claimed)
          const waitingCount = (queueManager.queues.waiting || []).length;
          const processingCount = (queueManager.queues.processing || []).length;
          const readyCount = (queueManager.queues.ready || []).length;
          const completedCount = (queueManager.queues.completed || []).length; // Ready to claim
          const claimedCount = (queueManager.queues.claimed || []).length; // Picked up (New)
          const priorityCount = (queueManager.queues.priority || []).length;

          // Total = Everyone who entered the queue today
          const total =
            waitingCount +
            processingCount +
            readyCount +
            completedCount +
            claimedCount +
            priorityCount;

          // Completed = Ready to Claim + Already Picked Up
          const totalFinished = completedCount + claimedCount;

          // Update the text on screen
          document.getElementById("totalRequestsSummary").textContent = total;
          document.getElementById("completedSummary").textContent =
            totalFinished;
          document.getElementById("totalRequestsToday").textContent = total;

          // 3. Update the Recent Requests list
          renderRecentRequests(queueManager.queues);
          // 4. Update the Report History list
          renderReportHistory(queueManager.queues);
        }

        // 2. Update Satisfaction Chart (Keep existing logic)
        // Note: We keep this separate to avoid breaking the chart if it fails
        if (typeof renderSatisfactionChart === "function") {
          // Re-fetch satisfaction stats to ensure chart is up to date
          makeAuthenticatedRequest("/api/admin/satisfaction-stats")
            .then((res) => res.json())
            .then((data) => {
              if (data.success) renderSatisfactionChart(data.stats);
            })
            .catch((e) => console.error("Stats error", e));
        }
      }
      //  END OF REPLACEMENT 
      //  ADD THIS ENTIRE NEW FUNCTION 

      async function updateReportsData() {
        // 1. Update Queue Counts (Keep your existing logic)
        if (queueManager && queueManager.queues) {
          // ... (Your existing counting logic for Total, Completed, etc.)
          const waitingCount = (queueManager.queues.waiting || []).length;
          const processingCount = (queueManager.queues.processing || []).length;
          const readyCount = (queueManager.queues.ready || []).length;
          const completedCount = (queueManager.queues.completed || []).length;
          const claimedCount = (queueManager.queues.claimed || []).length;
          const priorityCount = (queueManager.queues.priority || []).length;

          const total =
            waitingCount +
            processingCount +
            readyCount +
            completedCount +
            claimedCount +
            priorityCount;
          const totalFinished = completedCount + claimedCount;

          document.getElementById("totalRequestsSummary").textContent = total;
          document.getElementById("completedSummary").textContent =
            totalFinished;
          document.getElementById("totalRequestsToday").textContent = total;

          renderRecentRequests(queueManager.queues);
          renderReportHistory(queueManager.queues);
        }

        // 2.  NEW: FETCH & RENDER SATISFACTION CHART 
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/satisfaction-stats"
          );
          const result = await response.json();

          if (result.success) {
            // Pass the stats array (e.g. [{rating: 5, count: 10}, ...]) to the renderer
            renderSatisfactionChart(result.stats);
          }
        } catch (e) {
          console.error("Error loading satisfaction stats", e);
        }
      }

      function renderSatisfactionChart(stats) {
        const ctx = document.getElementById("satisfactionChart");
        if (!ctx) return;

        // Initialize counts for 5 stars, 4 stars, ... 1 star
        // Index 0 = 5 Stars, Index 4 = 1 Star
        const counts = [0, 0, 0, 0, 0];
        let total = 0;
        let weightedSum = 0;

        // Process the data from the API
        // stats example: [{rating: 5, count: 10}, {rating: 4, count: 2}]
        if (Array.isArray(stats)) {
          stats.forEach((item) => {
            const r = item.rating;
            if (r >= 1 && r <= 5) {
              // Map rating to array index (5 -> 0, 4 -> 1, etc.)
              counts[5 - r] = item.count;
              total += item.count;
              weightedSum += r * item.count;
            }
          });
        }

        // Calculate Average (e.g., 4.85)
        const average = total > 0 ? (weightedSum / total).toFixed(2) : "0.00";

        // Destroy old chart if it exists to prevent glitching/overlay
        if (window.satisfactionChartInstance) {
          window.satisfactionChartInstance.destroy();
        }

        // Create the Chart
        window.satisfactionChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: [
              "5 - Very Satisfied",
              "4 - Satisfied",
              "3 - Neutral",
              "2 - Dissatisfied",
              "1 - Very Dissatisfied",
            ],
            datasets: [
              {
                label: "Responses",
                data: counts,
                backgroundColor: [
                  "#198754", // Green (5)
                  "#20c997", // Teal (4)
                  "#ffc107", // Yellow (3)
                  "#fd7e14", // Orange (2)
                  "#dc3545", // Red (1)
                ],
                borderRadius: 5,
                barThickness: 20,
              },
            ],
          },
          options: {
            indexAxis: "y", // Horizontal Bar Chart
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `Average Rating: ${average} / 5.0 (${total} reviews)`,
                font: { size: 16 },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    const percentage =
                      total > 0
                        ? ((value / total) * 100).toFixed(1) + "%"
                        : "0%";
                    return `${value} Responses (${percentage})`;
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
              },
            },
          },
        });
      }

      /**
       * Populates the 'Recent Client Requests' list on the Reports page.
       */
      function renderRecentRequests(queues) {
        const listElement = document.getElementById("recentRequestsList");
        if (!listElement) {
          console.warn("Recent requests list element not found.");
          return;
        }

        // 1. Combine all available queue arrays
        //  FIX: We added '...(queues.claimed || [])' so picked-up items stay in the list
        const allRequests = [
          ...(queues.waiting || []),
          ...(queues.processing || []),
          ...(queues.ready || []),
          ...(queues.completed || []),
          ...(queues.claimed || []),
          ...(queues.priority || []),
        ];

        // 2. Sort by 'submitted_at' time, most recent first
        allRequests.sort(
          (a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)
        );

        // 3. Handle empty state
        if (allRequests.length === 0) {
          listElement.innerHTML = `
                <li class="request-list-item empty">
                  No requests found for today.
                </li>
              `;
          return;
        }

        // 4. Build and inject the HTML
        listElement.innerHTML = allRequests
          .map((request) => {
            // Safely get service name
            const services = Array.isArray(request.services)
              ? request.services
              : [];
            let mainService = "General Request";
            if (services.length > 0) {
              try {
                const parsedServices = JSON.parse(services[0]);
                mainService = Array.isArray(parsedServices)
                  ? parsedServices[0]
                  : services[0];
              } catch (e) {
                mainService = services[0];
              }
            } else if (request.service) {
              mainService = request.service;
            }

            // Status Badge Logic
            let statusBadge = "";
            if (request.status === "claimed") {
              statusBadge =
                '<span class="badge bg-secondary ms-2" style="font-size: 10px;">Picked Up</span>';
            } else if (request.status === "completed") {
              statusBadge =
                '<span class="badge bg-success ms-2" style="font-size: 10px;">Ready</span>';
            }

            // Utility to prevent XSS
            const escape = (str) => {
              if (str === null || str === undefined) return "";
              return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
            };

            //  FIX: Remove Note from display 
            let cleanService = mainService;
            if (
              typeof cleanService === "string" &&
              cleanService.includes(" [Note:")
            ) {
              cleanService = cleanService.split(" [Note:")[0];
            }

            const clientName = escape(request.user_name);
            const serviceName = escape(cleanService);
            return `
                <li class="request-list-item">
                  <div class="client-name" title="${clientName}">
                    ${clientName} ${statusBadge}
                  </div>
                  <div class="service-name" title="${serviceName}">${serviceName}</div>
                </li>
              `;
          })
          .join("");
      }

      function setupAutoRefresh() {
        // Refresh queue data every 10 seconds
        setInterval(() => {
          if (
            !isQueuePaused &&
            document.getElementById("queue-page").classList.contains("active")
          ) {
            queueManager.loadQueues();
          }
        }, 10000);

        // Refresh service requests every 30 seconds
        setInterval(() => {
          if (
            document
              .getElementById("documents-page")
              .classList.contains("active")
          ) {
            serviceRequestManager.loadServiceRequests();
          }
        }, 30000);
      }

      // Modal functions
      function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.toggle("active");
        }
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.classList.remove("active");
        }
      };

      // Theme toggle
      let currentTheme = "light";
      function toggleTheme() {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        document.getElementById("themeValue").textContent =
          currentTheme === "light" ? "Light" : "Dark";

        if (currentTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          document.body.classList.add("dark-theme");
        } else {
          document.documentElement.removeAttribute("data-theme");
          document.body.classList.remove("dark-theme");
        }

        showNotification(
          "Theme changed to " + (currentTheme === "light" ? "Light" : "Dark")
        );

        // Save to localStorage
        localStorage.setItem("adminTheme", currentTheme);
      }

      // Font size toggle
      const fontSizes = ["Small", "Medium", "Large"];
      let currentFontSizeIndex = 1;
      function toggleFontSize() {
        currentFontSizeIndex = (currentFontSizeIndex + 1) % fontSizes.length;
        const fontSize = fontSizes[currentFontSizeIndex];
        document.getElementById("fontSizeValue").textContent = fontSize;

        const sizes = {
          Small: "14px",
          Medium: "16px",
          Large: "18px",
        };

        document.body.style.fontSize = sizes[fontSize];
        showNotification("Font size changed to " + fontSize);

        // Save to localStorage
        localStorage.setItem("adminFontSize", fontSize);
      }

      // Load saved preferences
      function loadPreferences() {
        // Load theme
        const savedTheme = localStorage.getItem("adminTheme");
        if (savedTheme) {
          currentTheme = savedTheme;
          document.getElementById("themeValue").textContent =
            savedTheme === "light" ? "Light" : "Dark";
          if (savedTheme === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
            document.body.classList.add("dark-theme");
          }
        }

        // Load font size
        const savedFontSize = localStorage.getItem("adminFontSize");
        if (savedFontSize) {
          const sizes = { Small: "14px", Medium: "16px", Large: "18px" };
          document.body.style.fontSize = sizes[savedFontSize];
          document.getElementById("fontSizeValue").textContent = savedFontSize;
          currentFontSizeIndex = fontSizes.indexOf(savedFontSize);
        }
      }

      // Save functions
      function saveAccountDetails() {
        showNotification("Account details saved successfully!");
        toggleModal("accountDetailsModal");
      }

      function changePassword() {
        showNotification("Password changed successfully!");
        toggleModal("passwordModal");
      }

      // Notification system
      function showNotification(message, type = "success") {
        // Remove existing notification if any
        const existingNotif = document.querySelector(".notification-toast");
        if (existingNotif) {
          existingNotif.remove();
        }

        // Create notification
        const notification = document.createElement("div");
        notification.className = "notification-toast";
        notification.textContent = message;

        // Style based on type
        const bgColor =
          type === "error"
            ? "#d32f2f"
            : type === "warning"
            ? "#f57c00"
            : "#2e7d32";
        notification.style.cssText = `
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  background: ${bgColor};
                  color: white;
                  padding: 15px 25px;
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                  z-index: 10000;
                  animation: slideInRight 0.3s ease-out;
              `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = "slideOutRight 0.3s ease-out";
            setTimeout(() => {
              if (notification.parentNode) {
                notification.remove();
              }
            }, 300);
          }
        }, 3000);
      }

      // Service Request Management
      class ServiceRequestManager {
        constructor() {
          this.currentAdmin = "Jila Santos";
          this.requests = [];
        }

        async loadServiceRequests() {
          try {
            console.log("Loading service requests...");
            const response = await makeAuthenticatedRequest(
              "/api/admin/service-requests"
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              this.requests = result.requests || [];
              this.renderRequests();
              this.updateStats();
            } else {
              console.error("Error loading service requests:", result.message);
              this.showEmptyState();
            }
          } catch (error) {
            console.error("Error loading service requests:", error);
            this.showEmptyState();
          }
        }

        showEmptyState() {
          const containers = [
            "pendingRequestsContainer",
            "approvedRequestsContainer",
            "declinedRequestsContainer",
          ];

          containers.forEach((containerId) => {
            const container = document.getElementById(containerId);
            if (container) {
              container.innerHTML = `<div class="empty-state"><p class="text-muted text-center py-4">No requests found.</p></div>`;
            }
          });
          this.updateStats();
        }

        renderRequests() {
          this.renderProcessingRequests(); // Active cards
          this.renderCompletedRequests(); // History
          this.renderPendingRequests();
          this.renderApprovedRequests();
          this.renderDeclinedRequests();
        }

        //  REPLACED FUNCTION: Splits requests into 'Processing' and 'On Queue' 
        renderProcessingRequests() {
          const containerProcessing = document.getElementById(
            "processingRequestsContainer"
          );
          const containerOnQueue = document.getElementById("onQueueContainer");

          if (!containerProcessing || !containerOnQueue) return;

          // 1. Get active queue data
          const processingQueueItems =
            queueManager && queueManager.queues
              ? queueManager.queues.processing
              : [];

          // 2. Get Current Window Identity
          let activeWindow = localStorage.getItem("assignedWindow");
          if (!activeWindow || activeWindow === "null")
            activeWindow = currentWindow;

          // Helper
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();
          const myCleanWindow = cleanString(activeWindow);

          // 3. Filter: Find ALL requests for THIS window
          const myRequests = processingQueueItems.filter(
            (item) =>
              cleanString(item.window_number) === myCleanWindow &&
              item.status !== "reviewing"
          );

          // 4. Sort: Oldest Started to Newest Started
          myRequests.sort(
            (a, b) => new Date(a.started_at) - new Date(b.started_at)
          );

          //  5. SEPARATE LISTS BASED ON PROGRESS 
          const listProcessing = [];
          const listOnQueue = [];

          // Style Config
          let borderColor = "#0d6efd";
          let badgeClass = "bg-primary";
          if (myCleanWindow.includes("2")) {
            borderColor = "#ffc107";
            badgeClass = "bg-warning text-dark";
          }
          if (myCleanWindow.includes("3")) {
            borderColor = "#0dcaf0";
            badgeClass = "bg-info text-dark";
          }
          if (myCleanWindow.includes("4")) {
            borderColor = "#dc3545";
            badgeClass = "bg-danger";
          }

          // Process Loop
          myRequests.forEach((req) => {
            const services = Array.isArray(req.services) ? req.services : [];

            // Calculate Duration
            let maxDays = 3;
            services.forEach((s) => {
              let sName = s;
              if (s.includes("[")) sName = s.split(" [")[0];
              if (
                typeof SERVICE_DURATIONS !== "undefined" &&
                SERVICE_DURATIONS[sName] &&
                SERVICE_DURATIONS[sName] > maxDays
              ) {
                maxDays = SERVICE_DURATIONS[sName];
              }
            });

            // Parse Progress
            let progress = { current: 0, total: maxDays, checked: [] };
            if (req.progress_data) {
              try {
                const parsed =
                  typeof req.progress_data === "string"
                    ? JSON.parse(req.progress_data)
                    : req.progress_data;
                progress.current = parsed.current || 0;
                progress.total = maxDays;
                progress.checked = parsed.checked || [];
              } catch (e) {
                console.warn("Error parsing progress", e);
              }
            }

            const percent =
              maxDays > 0 ? Math.round((progress.current / maxDays) * 100) : 0;
            const isComplete = percent >= 100;

            // Generate Card HTML
            const cardHtml = `
                <div class="card border-0 shadow-sm animate__animated animate__fadeIn mb-3">
                    <div class="card-body p-4" style="border-left: 8px solid ${
                      isComplete ? "#198754" : borderColor
                    };">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <div class="d-flex align-items-center mb-1">
                                    <h3 class="fw-bold mb-0 me-2">${this.escapeHtml(
                                      req.user_name
                                    )}</h3>
                                    ${
                                      isComplete
                                        ? `<span class="badge bg-success bg-opacity-10 text-success border border-success ms-2"><i class="bi bi-broadcast me-1"></i> Live on TV</span>`
                                        : `<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary ms-2"><i class="bi bi-eye-slash me-1"></i> Hidden on TV</span>`
                                    }
                                </div>
                                <p class="text-muted mb-0 fs-6">Student ID: <strong>${this.escapeHtml(
                                  req.student_id
                                )}</strong></p>
                            </div>
                            <div class="text-end">
                                <span class="badge ${badgeClass} fs-5 px-3 py-2 rounded-pill shadow-sm">${this.escapeHtml(
              req.queue_number
            )}</span>
                            </div>
                        </div>

                        <div class="bg-light p-3 rounded mb-3">
                            <label class="text-secondary small fw-bold text-uppercase mb-1">Requested Services</label>
                            <div class="fs-6 fw-semibold text-dark mb-2">
                                <i class="bi bi-gear-wide-connected me-2 text-primary"></i>
                                ${this.escapeHtml(services.join(", "))}
                            </div>

                            <div class="d-flex align-items-center mt-3">
                                <div class="flex-grow-1 me-3">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Progress (${
                                          progress.current
                                        }/${maxDays} Days)</span>
                                        <span class="fw-bold ${
                                          isComplete
                                            ? "text-success"
                                            : "text-primary"
                                        }">${percent}%</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar ${
                                          isComplete
                                            ? "bg-success"
                                            : "bg-primary"
                                        }" role="progressbar" style="width: ${percent}%"></div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="queueManager.openProgressModal('${
                                  req.queue_id
                                }', ${maxDays}, '${encodeURIComponent(
              JSON.stringify(progress.checked)
            )}')">
                                    <i class="bi bi-pencil-square"></i> Update
                                </button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                            <div class="text-muted small">
                                <i class="bi bi-clock me-1"></i> Started: ${new Date(
                                  req.started_at
                                ).toLocaleTimeString()}
                            </div>
                            <div class="d-inline-block">
                                <button class="btn ${
                                  isComplete ? "btn-success" : "btn-secondary"
                                } px-4 fw-bold shadow-sm"
                                    onclick="queueManager.markAsDone('${
                                      req.queue_id
                                    }')"
                                    ${
                                      !isComplete
                                        ? 'disabled style="cursor: not-allowed; opacity: 0.6;"'
                                        : ""
                                    }>
                                    <i class="bi bi-check-circle-fill me-2"></i> Mark as Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Sort into Lists
            if (isComplete) {
              listOnQueue.push(cardHtml);
            } else {
              listProcessing.push(cardHtml);
            }
          });

          // 6. RENDER "PROCESSING" (0-99%)
          if (listProcessing.length > 0) {
            containerProcessing.innerHTML = `
                  <h3 class="section-title fs-5 text-primary fw-bold mb-3">
                      <i class="bi bi-person-workspace me-2"></i> Processing (${
                        listProcessing.length
                      })
                  </h3>
                  ${listProcessing.join("")}
              `;
          } else {
            containerProcessing.innerHTML = `
                  <h3 class="section-title fs-5 text-secondary fw-bold mb-3">
                      <i class="bi bi-person-workspace me-2"></i> Processing (0)
                  </h3>
                  <div class="text-center py-4 bg-white rounded shadow-sm border mb-3">
                      <p class="text-muted mb-0">No active requests in progress.</p>
                  </div>`;
          }

          // 7. RENDER "ON QUEUE" (100% - Ready to Complete)
          if (listOnQueue.length > 0) {
            containerOnQueue.innerHTML = `
                  <div class="alert alert-success border-0 shadow-sm mb-3 d-flex align-items-center">
                      <i class="bi bi-broadcast me-3 fs-3"></i>
                      <div>
                          <h4 class="alert-heading fw-bold mb-0">On Queue / Live on TV</h4>
                          <p class="mb-0 small">These requests are at 100% progress and are visible on the TV screen. Click "Mark as Done" when the student approaches.</p>
                      </div>
                  </div>
                  ${listOnQueue.join("")}
              `;
            containerOnQueue.style.display = "block";
          } else {
            // Hide the container if empty to keep UI clean
            containerOnQueue.innerHTML = "";
            containerOnQueue.style.display = "none";
          }
        }

        //  FIXED: Shows both 'Ready' and 'Picked Up' in History 
        renderCompletedRequests() {
          const container = document.getElementById(
            "completedRequestsContainer"
          );
          if (!container) return;

          // 1. Get BOTH Completed and Claimed items
          const completedItems =
            queueManager && queueManager.queues
              ? queueManager.queues.completed
              : [];
          const claimedItems =
            queueManager && queueManager.queues
              ? queueManager.queues.claimed
              : [];

          // Combine them into one history list
          const allHistory = [...completedItems, ...claimedItems];

          // 2. Get Current Window Identity
          let activeWindow = localStorage.getItem("assignedWindow");
          if (!activeWindow || activeWindow === "null")
            activeWindow = currentWindow;

          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();
          const myCleanWindow = cleanString(activeWindow);

          // 3. Filter: Only show items processed by THIS window
          const myHistory = allHistory.filter(
            (item) => cleanString(item.window_number) === myCleanWindow
          );

          // 4. Sort: Newest actions first
          // We use 'completed_at' which exists for both statuses
          myHistory.sort(
            (a, b) => new Date(b.completed_at) - new Date(a.completed_at)
          );

          if (myHistory.length === 0) {
            container.innerHTML = `<p class="text-muted small ms-2">No history for this session yet.</p>`;
            return;
          }

          container.innerHTML = myHistory
            .map((req) => {
              const timeFinished = new Date(
                req.completed_at
              ).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

              //  Dynamic Badge Logic 
              let actionButton = "";
              let badgeHtml = "";
              let borderClass = "";

              if (req.status === "claimed") {
                // If already picked up
                badgeHtml = `<span class="badge bg-secondary me-2">A-000</span>`; // Placeholder logic if queue number missing
                if (req.queue_number)
                  badgeHtml = `<span class="badge bg-secondary me-2">${req.queue_number}</span>`;

                borderClass = "border-secondary"; // Grey border
                actionButton = `
            <button class="btn btn-sm btn-outline-secondary disabled" disabled>
                <i class="bi bi-check2-all me-1"></i> Picked Up
            </button>`;
              } else {
                // If just completed (Ready)
                if (req.queue_number)
                  badgeHtml = `<span class="badge bg-success me-2">${req.queue_number}</span>`;

                borderClass = "border-success"; // Green border
                actionButton = `
            <button class="btn btn-sm btn-outline-success"
                onclick="queueManager.markAsClaimed('${req.queue_id}', this)"
                title="Mark as Picked Up">
                <i class="bi bi-box-seam me-1"></i> Picked Up
            </button>`;
              }

              return `
      <div class="card border-0 shadow-sm mb-2" style="border-left: 4px solid ${
        req.status === "claimed" ? "#6c757d" : "#198754"
      } !important;">
        <div class="card-body p-3 d-flex justify-content-between align-items-center">
          <div>
            <div class="d-flex align-items-center">
              ${badgeHtml}
              <strong class="text-dark">${this.escapeHtml(
                req.user_name
              )}</strong>
            </div>
            <div class="small text-muted mt-1">
              <i class="bi bi-clock-history"></i> ${
                req.status === "claimed" ? "Picked up at" : "Ready since"
              } ${timeFinished}
            </div>
          </div>
          ${actionButton}
        </div>
      </div>
    `;
            })
            .join("");
        }

        renderPendingRequests() {
          // (Keep existing logic)
        }
        renderApprovedRequests() {
          // (Keep existing logic)
        }
        renderDeclinedRequests() {
          // (Keep existing logic)
        }
        updateStats() {
          // (Keep existing logic)
        }
        showApproveModal(requestId) {
          // (Keep existing logic)
        }
        showDeclineModal(requestId) {
          // (Keep existing logic)
        }
        viewRequestDetails(requestId) {
          // (Keep existing logic)
        }
        getRequestDetailsHTML(request) {
          // (Keep existing logic)
          return `<div>Preview</div>`; // Simplified for snippet
        }
        getDetailedRequestHTML(request) {
          // (Keep existing logic)
          return `<div>Details</div>`; // Simplified for snippet
        }
        async confirmApproveRequest() {
          // (Keep existing logic)
        }
        async confirmDeclineRequest() {
          // (Keep existing logic)
        }
        escapeHtml(unsafe) {
          if (unsafe === null || unsafe === undefined) return "";
          return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
      }
      /* --------------------------------------------------------------
         SERVICE REQUEST SEARCH  BY REQUESTER NAME ONLY
         -------------------------------------------------------------- */
      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById(
          "serviceRequestSearchInput"
        );
        const searchBtn = document.getElementById("serviceRequestSearchBtn");

        if (!searchInput || !searchBtn) return;

        //  UPGRADED SEARCH: Finds Completed items too 
        const performSearch = () => {
          const term = searchInput.value.trim().toLowerCase();

          // 1. Search Service Requests (Pending/Approved/Declined)
          if (serviceRequestManager?.requests?.length) {
            ["pending", "approved", "declined"].forEach((status) => {
              const containerId = {
                pending: "pendingRequestsContainer",
                approved: "approvedRequestsContainer",
                declined: "declinedRequestsContainer",
              }[status];

              const container = document.getElementById(containerId);
              if (!container) return;

              const items = container.querySelectorAll(".document-item");
              let visible = 0;

              items.forEach((item) => {
                // Search inside the whole card text
                const text = item.textContent.toLowerCase();
                const show = term === "" || text.includes(term);
                item.style.display = show ? "" : "none";
                if (show) visible++;
              });
            });
          }

          // 2.  NEW: Search History / Completed Items 
          const historyContainer = document.getElementById(
            "completedRequestsContainer"
          );
          if (historyContainer) {
            const historyItems = historyContainer.querySelectorAll(".card");
            let historyVisible = 0;

            historyItems.forEach((card) => {
              const text = card.textContent.toLowerCase();
              // If search term is empty, we usually hide history or show all?
              // Your current logic filters by window.
              // This search overrides the window filter ONLY when typing.

              if (term === "") {
                // If cleared, let the original window filter render function handle it
                // (You might need to re-call renderCompletedRequests() here to reset)
                card.style.display = "";
              } else {
                const show = text.includes(term);
                card.style.display = show ? "" : "none";
                if (show) historyVisible++;
              }
            });

            // If searching and found nothing in history, maybe show a message
            if (term !== "" && historyVisible === 0) {
              // Optional: Add "No history found" msg
            }
          }
        };

        // Button click
        searchBtn.addEventListener("click", performSearch);

        // Live search (debounced)
        let debounceTimer;
        searchInput.addEventListener("input", () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(performSearch, 300);
        });

        // Re-apply after every render
        const originalRender = serviceRequestManager.renderRequests.bind(
          serviceRequestManager
        );
        serviceRequestManager.renderRequests = function () {
          originalRender();
          performSearch();
        };
      });

      // Staff Management (Super Admin)
      class StaffManager {
        async loadAllStaff() {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/all-staff"
            );
            const result = await response.json();

            if (result.success) {
              this.renderStaffList(result.staff);
            }
          } catch (error) {
            console.error("Error loading staff:", error);
          }
        }

        renderStaffList(staffList) {
          const container = document.getElementById("staffListContainer");
          if (!container) return;

          container.innerHTML = staffList
            .map((staff) => {
              // Logic: Check if this row is the currently logged-in user
              const isMe = currentStaff && currentStaff.id === staff.id;

              // Logic: Don't show Delete button for your own account
              const deleteButton = isMe
                ? `<button class="btn btn-sm btn-outline-secondary disabled ms-2" title="You cannot delete yourself"><i class="bi bi-trash"></i></button>`
                : `<button class="btn btn-sm btn-outline-danger ms-2" onclick="staffManager.deleteStaff(${staff.id}, '${staff.full_name}')" title="Delete Account"><i class="bi bi-trash"></i></button>`;

              //  FIX: Status Logic 
              let statusBadge = "";

              if (isMe) {
                // If it is YOU, you are definitely Online
                if (staff.role === "super_admin") {
                  statusBadge = `<span class="badge bg-primary">Active: Supervisor</span>`;
                } else if (staff.assigned_window) {
                  statusBadge = `<span class="badge bg-success">Active: ${staff.assigned_window}</span>`;
                } else {
                  statusBadge = `<span class="badge bg-success">Online</span>`;
                }
              } else {
                // For others, rely on database status
                if (staff.assigned_window) {
                  statusBadge = `<span class="badge bg-success">Active: ${staff.assigned_window}</span>`;
                } else {
                  statusBadge =
                    '<span class="text-muted small">Offline / Idle</span>';
                }
              }

              return `
              <tr>
                  <td class="p-3 ps-4">
                      <div class="d-flex align-items-center">
                          <div class="staff-avatar-small me-3 bg-primary text-white rounded-circle d-flex justify-content-center align-items-center" style="width:35px; height:35px; font-size:12px;">
                              ${staff.full_name.charAt(0).toUpperCase()}
                          </div>
                          <div>
                              <div class="fw-bold text-dark">${
                                staff.full_name
                              } ${isMe ? "(You)" : ""}</div>
                              <div class="text-muted small">${staff.email}</div>
                          </div>
                      </div>
                  </td>
                  <td class="p-3"><span class="badge bg-secondary">${staff.role.replace(
                    "_",
                    " "
                  )}</span></td>
                  <td class="p-3">${staff.department || "N/A"}</td>
                  <td class="p-3">
                      ${statusBadge}
                  </td>
                  <td class="p-3 text-end pe-4">
                      <button class="btn btn-sm btn-outline-primary" onclick='staffManager.openEditModal(${JSON.stringify(
                        staff
                      )})'>
                          <i class="bi bi-pencil"></i> Edit
                      </button>
                      ${deleteButton}
                  </td>
              </tr>
          `;
            })
            .join("");
        }

        //  NEW: Delete Staff Function
        async deleteStaff(id, name) {
          if (
            !confirm(
              ` ARE YOU SURE?\n\nYou are about to permanently delete the account for "${name}".\nThis action cannot be undone.`
            )
          ) {
            return;
          }

          try {
            const response = await makeAuthenticatedRequest(
              `/api/admin/delete-staff/${id}`,
              {
                method: "DELETE",
              }
            );

            const result = await response.json();

            if (result.success) {
              showNotification(
                "Staff account deleted successfully.",
                "success"
              );
              this.loadAllStaff(); // Refresh the list immediately
            } else {
              alert("Failed to delete: " + result.message);
            }
          } catch (error) {
            console.error("Delete error:", error);
            alert("An error occurred while deleting the account.");
          }
        }

        openEditModal(staff) {
          document.getElementById("editStaffId").value = staff.id;
          document.getElementById("editStaffName").value = staff.full_name;
          document.getElementById("editStaffEmail").value = staff.email;
          document.getElementById("editStaffPhone").value = staff.phone || "";
          document.getElementById("editStaffDept").value =
            staff.department || "";
          document.getElementById("editStaffRole").value = staff.role;
          document.getElementById("editStaffPassword").value = ""; // Reset password field

          toggleModal("editStaffModal");
        }

        async updateStaff() {
          const id = document.getElementById("editStaffId").value;
          const data = {
            id: id,
            full_name: document.getElementById("editStaffName").value,
            email: document.getElementById("editStaffEmail").value,
            phone: document.getElementById("editStaffPhone").value,
            department: document.getElementById("editStaffDept").value,
            role: document.getElementById("editStaffRole").value,
            password: document.getElementById("editStaffPassword").value,
          };

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/update-staff-account",
              {
                method: "POST",
                body: JSON.stringify(data),
              }
            );
            const result = await response.json();

            if (result.success) {
              showNotification("Staff updated successfully");
              toggleModal("editStaffModal");
              this.loadAllStaff(); // Reload list
            } else {
              alert(result.message);
            }
          } catch (error) {
            alert("Update failed");
          }
        }
      }
      // Initialize global instance
      const staffManager = new StaffManager();

      // Function to handle Super Admin registering new staff
      async function submitNewStaffRegistration() {
        // 1. Gather Data
        const lastName = document.getElementById("regLastName").value;
        const firstName = document.getElementById("regFirstName").value;
        const middleInitial = document.getElementById("regMiddleInitial").value;
        const phone = document.getElementById("regPhone").value;
        const sex = document.getElementById("regSex").value;
        const email = document.getElementById("regEmail").value;
        const address = document.getElementById("regAddress").value;
        const password = document.getElementById("regPassword").value;
        const confirmPassword =
          document.getElementById("regConfirmPassword").value;

        // 2. Validate
        if (
          !lastName ||
          !firstName ||
          !phone ||
          !sex ||
          !email ||
          !address ||
          !password
        ) {
          alert("Please fill in all required fields.");
          return;
        }

        if (password !== confirmPassword) {
          alert("Passwords do not match.");
          return;
        }

        // Construct full name automatically
        const fullName = `${firstName} ${
          middleInitial ? middleInitial + ". " : ""
        }${lastName}`.trim();

        const payload = {
          lastName,
          firstName,
          middleInitial,
          phone,
          sex,
          email,
          address,
          password,
          full_name: fullName,
        };

        // 3. Send to API (using Authenticated Request)
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/register",
            {
              method: "POST",
              body: JSON.stringify(payload),
            }
          );

          const result = await response.json();

          if (result.success) {
            showNotification("Staff account created successfully!", "success");
            toggleModal("registerStaffModal");

            // Clear Form
            document.getElementById("dashboardRegisterForm").reset();

            // Refresh the staff list immediately
            if (typeof staffManager !== "undefined") {
              staffManager.loadAllStaff();
            }
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Registration error:", error);
          alert("Failed to register staff. See console for details.");
        }
      }

      // Queue Manager
      class QueueManager {
        constructor() {
          this.queues = {
            waiting: [],
            processing: [],
            ready: [],
            completed: [],
            priority: [],
          };
          this.isAutoRefresh = true;
          this.lastUpdate = null;
        }

        //  FIXED: Added timestamp to URL to prevent browser caching 
        async loadQueues() {
          try {
            // Add timestamp query param to force fresh fetch
            const response = await makeAuthenticatedRequest(
              `/api/admin/queues?t=${new Date().getTime()}`
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              this.queues = result.queues || {
                waiting: [],
                processing: [],
                ready: [],
                completed: [],
                priority: [],
              };

              this.renderQueueDashboard();
              this.updateQueueStats();
              updateReportsData();
              this.lastUpdate = new Date();
            } else {
              console.error("Error loading queues:", result.message);
              this.showEmptyQueueState();
            }
          } catch (error) {
            console.error("Error loading queues:", error);
            this.showEmptyQueueState();
            if (error.message.includes("No admin token")) {
              // Only redirect if it's definitely an auth error
              adminLogout();
            }
          }
        }

        renderQueueDashboard() {
          this.renderNowServing(); // Renamed from renderCurrentRequest
          this.renderNewRequests();
          this.renderAllProcessing(); // <---  ADD THIS LINE 
        }

        //  NEW FUNCTION: Opens the modal with details 
        showWindowDetails(windowName) {
          // 1. Filter requests for this window
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();
          const targetKey = cleanString(windowName);

          const requests = this.queues.processing.filter(
            (req) => cleanString(req.window_number) === targetKey
          );

          // 2. Get Modal Elements
          const modalTitle = document.getElementById("windowDetailsTitle");
          const modalList = document.getElementById("windowDetailsList");

          if (modalTitle)
            modalTitle.innerHTML = `<i class="bi bi-display me-2"></i> ${windowName} Status`;

          // 3. Populate Modal Content
          if (modalList) {
            if (requests.length === 0) {
              // Idle State
              modalList.innerHTML = `
                              <div class="text-center py-5 text-muted bg-white rounded shadow-sm">
                                  <i class="bi bi-cup-hot display-1 text-secondary opacity-25"></i>
                                  <h4 class="mt-3 fw-bold">Currently Idle</h4>
                                  <p class="mb-0">This window is ready to serve.</p>
                              </div>
                          `;
            } else {
              // Active Processing State
              modalList.innerHTML = requests
                .map((req) => {
                  const services = Array.isArray(req.services)
                    ? req.services
                    : [];
                  return `
                              <div class="card border-0 shadow-sm mb-3 animate__animated animate__fadeIn">
                                  <div class="card-body border-start border-5 border-primary rounded-start">
                                      <div class="d-flex justify-content-between align-items-start mb-2">
                                          <div>
                                              <h5 class="fw-bold mb-0 text-dark">${this.escapeHtml(
                                                req.user_name
                                              )}</h5>
                                              <small class="text-muted">Student ID: ${this.escapeHtml(
                                                req.student_id || "N/A"
                                              )}</small>
                                          </div>
                                          <span class="badge bg-primary rounded-pill px-3 py-2 fs-6">${this.escapeHtml(
                                            req.queue_number
                                          )}</span>
                                      </div>

                                      <div class="p-2 bg-light rounded mt-3">
                                          <div class="d-flex align-items-center text-secondary small mb-1">
                                              <i class="bi bi-gear-wide-connected me-2"></i> Service:
                                          </div>
                                          <div class="fw-semibold text-dark">${services.join(
                                            ", "
                                          )}</div>
                                      </div>

                                      <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                                          <small class="text-muted">
                                              <i class="bi bi-clock me-1"></i> Started: ${new Date(
                                                req.started_at
                                              ).toLocaleTimeString()}
                                          </small>
                                          <span class="badge bg-warning text-dark">In Progress</span>
                                      </div>
                                  </div>
                              </div>
                              `;
                })
                .join("");
            }
          }

          // 4. Show Modal
          const modalEl = document.getElementById("windowDetailsModal");
          if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
          }
        }

        renderAllProcessing() {
          const container = document.getElementById("all-processing-list");
          const noRequestsMsg = document.getElementById("no-processing-msg");

          //  FIX: Filter out 'reviewing' status. Only show real 'processing' items.
          const processingRequests = (this.queues.processing || []).filter(
            (req) => req.status === "processing"
          );

          if (processingRequests.length === 0) {
            container.innerHTML = "";
            if (noRequestsMsg) noRequestsMsg.style.display = "block";
            return;
          }

          if (noRequestsMsg) noRequestsMsg.style.display = "none";

          // Clean string helper
          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();

          container.innerHTML =
            `<div class="active-requests-container">` +
            processingRequests
              .map((request) => {
                const services = Array.isArray(request.services)
                  ? request.services
                  : [];
                const processingTime = this.getProcessingTime(
                  request.started_at
                );
                const winKey = cleanString(request.window_number);

                // Styling Classes
                let winClass = "win-grey";
                let badgeClass = "bg-secondary";

                if (winKey.includes("1")) {
                  winClass = "win-1";
                  badgeClass = "bg-primary";
                } else if (winKey.includes("2")) {
                  winClass = "win-2";
                  badgeClass = "bg-warning text-dark";
                } else if (winKey.includes("3")) {
                  winClass = "win-3";
                  badgeClass = "bg-info text-dark";
                } else if (winKey.includes("4")) {
                  winClass = "win-4";
                  badgeClass = "bg-danger";
                }

                return `
                      <div class="active-request-row ${winClass}">
                          <div class="req-queue-num">${this.escapeHtml(
                            request.queue_number
                          )}</div>

                          <div class="req-info">
                              <h6>${this.escapeHtml(request.user_name)}</h6>
                              <p>${services.join(", ").substring(0, 35)}${
                  services.join(", ").length > 35 ? "..." : ""
                }</p>
                          </div>

                          <div>
                              <span class="req-window-badge badge ${badgeClass}">${this.escapeHtml(
                  request.window_number
                )}</span>
                          </div>

                          <div class="req-time">
                              <i class="bi bi-stopwatch me-1"></i>${processingTime}
                          </div>
                      </div>
                    `;
              })
              .join("") +
            `</div>`;
        }

        //  FIXED: Added ID to card for cleaner DOM updates 
        renderNewRequests() {
          const container = document.getElementById("requests-list");
          const noRequestsMsg = document.getElementById("no-requests-msg");
          if (!container || !noRequestsMsg) return;

          const newRequests = [
            ...(this.queues.priority || []),
            ...(this.queues.waiting || []),
            ...(this.queues.processing || []).filter(
              (q) => q.status === "reviewing"
            ),
          ];

          if (newRequests.length === 0) {
            container.innerHTML = "";
            noRequestsMsg.style.display = "block";
            return;
          }

          noRequestsMsg.style.display = "none";

          // Sort: Priority first, then oldest
          newRequests.sort((a, b) => {
            if (a.is_priority !== b.is_priority)
              return b.is_priority - a.is_priority;
            return new Date(a.submitted_at) - new Date(b.submitted_at);
          });

          container.innerHTML = newRequests
            .map((request) => {
              // ... (Keep existing variable logic for services, isPriority, etc.) ...
              const services = Array.isArray(request.services)
                ? request.services
                : [];
              const isPriority = request.is_priority;
              const isReviewing = request.status === "reviewing";
              const lockedByOthers =
                isReviewing && request.window_number !== currentWindow;

              let actionButton = "";
              let cardStyle = "";

              if (lockedByOthers) {
                cardStyle = "opacity: 0.6; background-color: #f0f0f0;";
                actionButton = `<button class="btn btn-sm btn-secondary" disabled><i class="bi bi-lock-fill"></i> Reviewing: ${request.window_number}</button>`;
              } else if (
                isReviewing &&
                request.window_number === currentWindow
              ) {
                actionButton = `<button class="btn btn-sm btn-warning fw-bold" onclick="queueManager.resumeReview('${request.queue_id}')"><i class="bi bi-play-circle"></i> Resume Review</button>`;
              } else {
                actionButton = `<button class="btn btn-sm btn-primary" onclick="queueManager.lockAndReview('${request.queue_id}')"><i class="bi bi-search me-1"></i> Review Request</button>`;
              }

              // ... inside renderNewRequests ...
              return `
    <div id="req-${request.queue_id}" class="request-card ${
                isPriority ? "priority-card" : ""
              }" style="${cardStyle}">
        <div class="card-info">
            <span class="student-name">
                ${this.escapeHtml(request.user_name)}
                <small class="text-muted ms-2">(${this.escapeHtml(
                  request.queue_number
                )})</small>
                ${
                  isPriority
                    ? '<span class="badge bg-danger ms-2">Priority</span>'
                    : ""
                }
            </span>
            
            <div class="text-muted fw-bold" style="font-size: 0.75rem; margin-top: 2px;">
                <i class="bi bi-mortarboard-fill me-1 text-primary"></i> 
                ${this.escapeHtml(request.course || "N/A")}
            </div>

            <span class="text-secondary small me-2 mt-1 d-block">
                ${services.join(", ").substring(0, 40)}${
                services.join(", ").length > 40 ? "..." : ""
              }
            </span>
        </div>
        <div class="card-actions">
            ${actionButton}
        </div>
    </div>
`;
            })
            .join("");
        }
        renderNowServing() {
          //  FIX: Only look for tickets that are ACTUALLY 'processing', not 'reviewing'
          const myProcessingTicket = (this.queues.processing || []).find(
            (q) =>
              q.window_number === currentWindow && q.status === "processing"
          );

          const container = document.getElementById(
            "current-serving-container"
          ); // You need to update the HTML ID below too

          if (!currentWindow) {
            // Default "Select Window" state
            // (Keep your existing simple logic or update to new style if you prefer)
            return;
          }

          if (!myProcessingTicket) {
            // Idle State
            container.innerHTML = `
                      <div class="now-serving-card text-center py-4">
                          <div class="text-muted opacity-50 mb-2">
                              <i class="bi bi-cup-hot fs-1"></i>
                          </div>
                          <h4 class="text-secondary fw-bold">Window ${currentWindow} is Idle</h4>
                          <p class="text-muted small mb-0">Waiting for next client...</p>
                      </div>
                   `;
          } else {
            // Active State
            const services = Array.isArray(myProcessingTicket.services)
              ? myProcessingTicket.services
              : [];

            container.innerHTML = `
                      <div class="now-serving-card animate__animated animate__fadeIn">
                          <div class="now-serving-header">
                              <span class="serving-status-badge">
                                  <span class="spinner-grow spinner-grow-sm text-success" role="status"></span>
                                  Processing
                              </span>
                              <span class="badge bg-primary fs-6 px-3 py-2 rounded-pill">
                                  ${this.escapeHtml(
                                    myProcessingTicket.queue_number
                                  )}
                              </span>
                          </div>
                          <div class="serving-body">
                              <div class="serving-client-name">${this.escapeHtml(
                                myProcessingTicket.user_name
                              )}</div>
                              <div class="serving-meta">
                                  <span><i class="bi bi-person-badge"></i> ${this.escapeHtml(
                                    myProcessingTicket.student_id
                                  )}</span>
                                  <span><i class="bi bi-clock"></i> Started: ${new Date(
                                    myProcessingTicket.started_at
                                  ).toLocaleTimeString()}</span>
                              </div>
                              <div class="p-2 bg-light rounded border border-light">
                                  <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">Services</small>
                                  <div class="text-dark fw-medium mt-1">
                                      ${this.escapeHtml(services.join(", "))}
                                  </div>
                              </div>
                          </div>
                      </div>
                   `;
          }
        }

        renderProcessingQueue() {
          const container = document.getElementById("processingQueueContainer");
          const badge = document.getElementById("processingBadge");

          if (!container) return;

          const processingQueues = this.queues.processing || [];

          if (badge) {
            badge.textContent = processingQueues.length;
          }

          if (processingQueues.length === 0) {
            container.innerHTML = `
                          <div class="empty-state">
                              <div style="text-align: center; padding: 20px; color: #999;">
                                  No requests currently processing
                              </div>
                          </div>
                      `;
            return;
          }

          container.innerHTML = processingQueues
            .map((queue, index) => {
              const services = Array.isArray(queue.services)
                ? queue.services
                : [];
              const processingTime = this.getProcessingTime(queue.started_at);
              const isCurrent = index === 0;

              return `
                          <div class="queue-item ${
                            isCurrent ? "queue-item-processing" : ""
                          }" style="padding: 15px; border-bottom: 1px solid #eee; ${
                !isCurrent ? "opacity: 0.7;" : ""
              }">
                              <div class="queue-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                  <div>
                                      <strong>${this.escapeHtml(
                                        queue.queue_number
                                      )}</strong>
                                      ${
                                        queue.is_priority
                                          ? '<span class="status-badge" style="background: #d32f2f; margin-left: 8px;">PRIORITY</span>'
                                          : ""
                                      }
                                      ${
                                        isCurrent
                                          ? '<span class="status-badge status-processing">CURRENT</span>'
                                          : '<span class="status-badge status-waiting">NEXT</span>'
                                      }
                                  </div>
                                  <div style="text-align: right;">
                                      <div style="font-size: 12px; color: #666;">${processingTime}</div>
                                  </div>
                              </div>
                              <div style="font-size: 14px; margin-bottom: 5px;">${this.escapeHtml(
                                queue.user_name
                              )}</div>
                              <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                  ${services.slice(0, 2).join(", ")}${
                services.length > 2 ? ` +${services.length - 2} more` : ""
              }
                              </div>
                              <div class="action-buttons">
                                  ${
                                    !isCurrent
                                      ? `
                                      <button class="btn btn-sm btn-primary" onclick="queueManager.makeCurrent('${queue.queue_id}')">Make Current</button>
                                  `
                                      : ""
                                  }
                                  <button class="btn btn-sm btn-success" onclick="queueManager.markAsDone('${
                                    queue.queue_id
                                  }')">Complete</button>
                                  <button class="btn btn-sm btn-warning" onclick="queueManager.notifyStudent('${
                                    queue.queue_id
                                  }')">Notify</button>
                              </div>
                          </div>
                      `;
            })
            .join("");
        }

        getProcessingTime(startedAt) {
          if (!startedAt) return "0m";
          const start = new Date(startedAt);
          const now = new Date();
          const diff = Math.floor((now - start) / (1000 * 60)); // minutes
          return `${diff}m`;
        }

        getNextToServe() {
          if (this.queues.priority && this.queues.priority.length > 0) {
            const nextPriority = this.queues.priority[0];
            return `${nextPriority.queue_number} (Priority)`;
          }

          if (this.queues.waiting && this.queues.waiting.length > 0) {
            const nextRegular = this.queues.waiting[0];
            return `${nextRegular.queue_number} (Regular)`;
          }

          return "No pending requests";
        }

        //  UPDATED: Makes cards clickable and shows status 
        updateQueueStats() {
          // 1. Calculate Sidebar Total
          const waitingCount = (this.queues.waiting || []).length;
          const processingCount = (this.queues.processing || []).length;
          const completedCount = (this.queues.completed || []).length;
          const priorityCount = (this.queues.priority || []).length;
          const totalCount =
            waitingCount + processingCount + completedCount + priorityCount;

          const sidebarTotalEl = document.getElementById("totalRequestsToday");
          if (sidebarTotalEl) sidebarTotalEl.textContent = totalCount;

          // 2. Determine Status
          const windowStatus = {
            window1: false,
            window2: false,
            window3: false,
            window4: false,
          };

          const cleanString = (str) =>
            String(str || "")
              .replace(/[^a-zA-Z0-9]/g, "")
              .toLowerCase();

          (this.queues.processing || []).forEach((ticket) => {
            const winKey = cleanString(ticket.window_number);
            if (windowStatus.hasOwnProperty(winKey)) {
              windowStatus[winKey] = true;
            }
          });

          // 3. Update Cards & Add Click Listeners
          const windows = [
            {
              key: "window1",
              id: "win1-count",
              colorClass: "text-primary",
              name: "Window 1",
            },
            {
              key: "window2",
              id: "win2-count",
              colorClass: "text-warning",
              name: "Window 2",
            },
            {
              key: "window3",
              id: "win3-count",
              colorClass: "text-info",
              name: "Window 3",
            },
            {
              key: "window4",
              id: "win4-count",
              colorClass: "text-danger",
              name: "Window 4",
            },
          ];

          windows.forEach((win) => {
            const isBusy = windowStatus[win.key];
            const element = document.getElementById(win.id);

            if (element) {
              //  Make the Card Clickable 
              const card = element.closest(".card");
              if (card) {
                card.style.cursor = "pointer";
                card.style.transition = "transform 0.2s, box-shadow 0.2s";

                // Add hover effect via JS
                card.onmouseover = () => {
                  card.style.transform = "translateY(-5px)";
                  card.style.boxShadow = "0 10px 20px rgba(0,0,0,0.1)";
                };
                card.onmouseout = () => {
                  card.style.transform = "translateY(0)";
                  card.style.boxShadow = "none";
                };

                // Add Click Event
                card.onclick = () => this.showWindowDetails(win.name);
              }

              // Update Text Status
              if (isBusy) {
                element.textContent = "Processing";
                element.className = `fw-bold mb-0 ${win.colorClass}`;
                element.style.fontSize = "1.5rem";
              } else {
                element.textContent = "Idle";
                element.className = "fw-bold mb-0 text-muted";
                element.style.fontSize = "2rem";
              }
            }
          });
        }

        // New methods for enhanced functionality
        async makePriority(queueId) {
          if (!confirm("Make this request priority?")) return;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/make-priority",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Request moved to priority queue!");
              await this.loadQueues();
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error making priority:", error);
            alert("Error making priority. Please try again.");
          }
        }

        async makeCurrent(queueId) {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/make-current",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Request set as current!");
              await this.loadQueues();
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error making current:", error);
            alert("Error making current. Please try again.");
          }
        }

        async transferToStaff(queueId) {
          const staff = prompt("Enter staff name to transfer to:");
          if (staff) {
            showNotification(`Transferred to ${staff}`);
            // Implementation would go here
          }
        }

        async clearPriorityQueue() {
          if (
            !confirm(
              "Clear all priority requests? This will move them to regular queue."
            )
          )
            return;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/clear-priority",
              {
                method: "POST",
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Priority queue cleared!");
              await this.loadQueues();
            }
          } catch (error) {
            console.error("Error clearing priority:", error);
          }
        }

        async moveToRegular(queueId) {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/move-to-regular",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Moved to regular queue");
              await this.loadQueues();
            }
          } catch (error) {
            console.error("Error moving to regular:", error);
          }
        }
        // ---------------------------------------------------------
        // PASTE THIS INSIDE THE 'QueueManager' CLASS
        // REPLACING THE OLD 'viewDetails' FUNCTION
        // ---------------------------------------------------------

        async viewDetails(queueId) {
          // 1. Find the queue item locally first
          let queueItem = null;
          const allLists = [
            "waiting",
            "processing",
            "ready",
            "completed",
            "priority",
          ];

          for (const listName of allLists) {
            if (this.queues[listName]) {
              const found = this.queues[listName].find(
                (q) => q.queue_id == queueId
              );
              if (found) {
                queueItem = found;
                break;
              }
            }
          }

          if (!queueItem) {
            console.error("Queue item not found:", queueId);
            return;
          }

          // 2. INTELLIGENT DATA FETCHING
          // If the Service Request list is empty, fetch it now to ensure we have the student's profile.
          if (
            !serviceRequestManager.requests ||
            serviceRequestManager.requests.length === 0
          ) {
            // Show a temporary loading state in the modal while we fetch
            const modalContent = document.getElementById(
              "requestDetailsContent"
            );
            modalContent.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Fetching student profile...</p></div>`;
            toggleModal("requestDetailsModal");

            // Wait for the data
            await serviceRequestManager.loadServiceRequests();
          }

          // 3. Look up the Full Request Profile using the Request ID
          // We use loose equality (==) to handle string/number mismatches safely
          let fullRequest = null;
          if (serviceRequestManager.requests) {
            fullRequest = serviceRequestManager.requests.find(
              (r) => r.request_id == queueItem.request_id
            );
          }

          // 4. Consolidate Data (Merge Queue info with Profile info)
          const data = {
            // Basic Queue Info
            queueNo: queueItem.queue_number,
            name: queueItem.user_name,
            studentId: queueItem.student_id || "N/A",
            course: queueItem.course || "N/A",
            year: queueItem.year_level || "N/A",
            services: Array.isArray(queueItem.services)
              ? queueItem.services
              : [],
            status: (queueItem.status || "Waiting").toUpperCase(),

            // Detailed Profile Info (Prefer fullRequest data, fallback to 'N/A')
            email: fullRequest
              ? fullRequest.contact_email
              : queueItem.email || "N/A",
            phone: fullRequest
              ? fullRequest.contact_phone
              : queueItem.phone || "N/A",
            address: fullRequest ? fullRequest.home_address : "N/A",
            campus: fullRequest ? fullRequest.campus : "N/A",
            files: fullRequest ? fullRequest.requirements_paths : [],
          };

          // Logic: If address is missing but we have a valid request ID, user might not have updated their profile
          if (data.address === "N/A" && queueItem.request_id) {
            data.address = "Address not provided by student";
          } else if (data.address === "N/A" && !queueItem.request_id) {
            data.address = "Manual Entry (No Profile)";
          }

          // 5. Generate Files HTML
          let filesHtml =
            '<div class="text-muted small fst-italic p-2 border rounded bg-light">No files attached to this request.</div>';

          if (
            data.files &&
            Array.isArray(data.files) &&
            data.files.length > 0
          ) {
            filesHtml = data.files
              .map((file, idx) => {
                const fileName = file.name || `Document ${idx + 1}`;
                const fileLink = file.file; // Base64 string
                return `
                    <div class="d-flex justify-content-between align-items-center p-2 mb-2 border rounded bg-white shadow-sm">
                        <div class="d-flex align-items-center overflow-hidden">
                            <div class="bg-light rounded p-2 me-3 text-primary">
                                <i class="bi bi-file-earmark-text fs-5"></i>
                            </div>
                            <div class="text-truncate" style="max-width: 250px;">
                                <span class="fw-bold small text-dark d-block text-truncate">${fileName}</span>
                                <span class="text-muted" style="font-size: 10px;">Click to download</span>
                            </div>
                        </div>
                        <a href="${fileLink}" download="${fileName}" class="btn btn-sm btn-primary px-3">
                            <i class="bi bi-download me-1"></i> Download
                        </a>
                    </div>
                  `;
              })
              .join("");
          }

          // 6. Generate Clean Modal UI
          const modalContent = document.getElementById("requestDetailsContent");
          modalContent.innerHTML = `
                <div class="container-fluid p-0">
                    <div class="d-flex align-items-center justify-content-between mb-4 pb-3 border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary text-white rounded-3 d-flex justify-content-center align-items-center me-3 shadow-sm" style="width: 55px; height: 55px;">
                                <h3 class="m-0 fw-bold">${
                                  data.queueNo.includes("-")
                                    ? data.queueNo.split("-")[1]
                                    : data.queueNo
                                }</h3>
                            </div>
                            <div>
                                <h4 class="mb-0 fw-bold text-dark">${
                                  data.name
                                }</h4>
                                <div class="d-flex gap-2 mt-1">
                                    <span class="badge bg-secondary rounded-pill px-2">Queue: ${
                                      data.queueNo
                                    }</span>
                                    <span class="badge ${
                                      data.status === "PROCESSING"
                                        ? "bg-warning text-dark"
                                        : "bg-success"
                                    } rounded-pill px-2">${data.status}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block text-uppercase" style="font-size: 10px; letter-spacing: 0.5px;">Student ID</small>
                            <span class="fw-bold fs-5 font-monospace text-dark">${
                              data.studentId
                            }</span>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-5">
                            <div class="d-flex align-items-center mb-3 text-secondary">
                                <i class="bi bi-person-badge me-2 fs-5"></i>
                                <h6 class="text-uppercase fw-bold small mb-0">Student Profile</h6>
                            </div>

                            <div class="bg-white p-3 rounded-3 border shadow-sm">
                                <div class="mb-3 border-bottom pb-2">
                                    <small class="text-secondary d-block fw-bold" style="font-size:11px">COURSE & YEAR</small>
                                    <div class="text-dark">${data.course}</div>
                                    <div class="text-muted small">${
                                      data.year
                                    }</div>
                                </div>
                                <div class="mb-3 border-bottom pb-2">
                                    <small class="text-secondary d-block fw-bold" style="font-size:11px">CAMPUS</small>
                                    <div class="text-dark">${data.campus}</div>
                                </div>
                                <div class="mb-3 border-bottom pb-2">
                                    <small class="text-secondary d-block fw-bold" style="font-size:11px">CONTACT INFO</small>
                                    <div class="text-dark"><i class="bi bi-telephone me-1 text-muted"></i> ${
                                      data.phone
                                    }</div>
                                    <div class="text-dark text-break"><i class="bi bi-envelope me-1 text-muted"></i> ${
                                      data.email
                                    }</div>
                                </div>
                                <div>
                                    <small class="text-secondary d-block fw-bold" style="font-size:11px">HOME ADDRESS</small>
                                    <div class="text-dark small lh-sm">${
                                      data.address
                                    }</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-7">
                             <div class="mb-4">
                                <div class="d-flex align-items-center mb-3 text-secondary">
                                    <i class="bi bi-list-check me-2 fs-5"></i>
                                    <h6 class="text-uppercase fw-bold small mb-0">Requested Services</h6>
                                </div>
                                <div class="list-group shadow-sm">
                                    ${data.services
                                      .map((s) => {
                                        let sName = s;
                                        let sNote = "";
                                        if (s.includes("[Note:")) {
                                          const parts = s.split(" [Note:");
                                          sName = parts[0];
                                          sNote = parts[1].replace("]", "");
                                        }
                                        return `
                                        <div class="list-group-item border-start border-4 border-primary py-3">
                                            <div class="fw-bold text-dark">${sName}</div>
                                            ${
                                              sNote
                                                ? `<div class="mt-1"><span class="badge bg-light text-primary border border-primary"><i class="bi bi-pencil-fill me-1"></i> ${sNote}</span></div>`
                                                : ""
                                            }
                                        </div>`;
                                      })
                                      .join("")}
                                </div>
                            </div>

                            <div>
                                <div class="d-flex align-items-center mb-3 text-secondary">
                                    <i class="bi bi-paperclip me-2 fs-5"></i>
                                    <h6 class="text-uppercase fw-bold small mb-0">Attachments</h6>
                                </div>
                                <div class="bg-light p-2 rounded-3 border" style="max-height: 250px; overflow-y: auto;">
                                    ${filesHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

          // 7. Open Modal (Ensure it's visible if it wasn't already)
          const modal = document.getElementById("requestDetailsModal");
          if (modal && !modal.classList.contains("active")) {
            toggleModal("requestDetailsModal");
          }
        }
        //  OPEN CONFIRMATION MODAL 
        startProcessing(queueId) {
          // 1. Check Window Assignment
          if (!currentWindow) {
            currentWindow = localStorage.getItem("assignedWindow");
            if (!currentWindow) {
              alert(
                "You must select a Window (1-4) before serving clients. Please refresh."
              );
              checkWindowAssignment();
              return;
            }
          }

          // 2. Get Request Details (Locally)
          // We search both priority and regular queues to find the name/number
          const request =
            (this.queues.priority || []).find((q) => q.queue_id == queueId) ||
            (this.queues.waiting || []).find((q) => q.queue_id == queueId);

          if (!request) {
            console.error("Request not found locally");
            return;
          }

          // 3. Populate Modal
          document.getElementById("serveQueueId").value = queueId;
          document.getElementById("serveClientName").textContent =
            request.user_name;
          document.getElementById("serveQueueNumber").textContent =
            request.queue_number;
          document.getElementById("serveWindowName").textContent =
            currentWindow;

          // 4. Show Modal
          toggleModal("confirmServeModal");
        }

        async notifyStudent(queueId) {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/notify-student",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Student notified successfully!");
              // Update UI to show notified status
              this.updateNotificationStatus(queueId);
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error notifying student:", error);
            alert("Error notifying student. Please try again.");
          }
        }

        //  OPEN MARK DONE MODAL 
        markAsDone(queueId) {
          // Get current staff name from the sidebar or global variable
          const staffName =
            document.getElementById("sidebarStaffName").textContent || "Staff";

          document.getElementById("markDoneQueueId").value = queueId;
          document.getElementById("markDoneStaffName").textContent = staffName;
          document.getElementById("markDoneMessage").value = ""; // Clear previous message

          toggleModal("markDoneModal");
        }

        //  SUBMIT TO API 
        async confirmMarkAsDone() {
          const queueId = document.getElementById("markDoneQueueId").value;
          const claimDetails = document.getElementById("markDoneMessage").value;
          const btn = document.querySelector("#markDoneModal .btn-success");

          // Loading state
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span> Processing...';
          btn.disabled = true;

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/mark-done",
              {
                method: "POST",
                body: JSON.stringify({ queueId, claimDetails }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Request completed successfully!");
              toggleModal("markDoneModal");

              // Refresh Lists
              await this.loadQueues();
              if (serviceRequestManager)
                serviceRequestManager.loadServiceRequests();
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error marking as done:", error);
            alert("Error completing request. Please try again.");
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        }

        async processNextInQueue() {
          const nextQueue =
            this.queues.priority && this.queues.priority.length > 0
              ? this.queues.priority[0]
              : this.queues.waiting && this.queues.waiting.length > 0
              ? this.queues.waiting[0]
              : null;

          if (!nextQueue) {
            alert("No requests in queue to process.");
            return;
          }

          await this.startProcessing(nextQueue.queue_id);
        }

        updateNotificationStatus(queueId) {
          // Update UI to show that student was notified
          const elements = document.querySelectorAll(`[onclick*="${queueId}"]`);
          elements.forEach((element) => {
            const btn = element
              .closest(".action-buttons")
              ?.querySelector('[onclick*="notifyStudent"]');
            if (btn) {
              btn.innerHTML = " Notified";
              btn.disabled = true;
              btn.classList.remove("btn-primary");
              btn.classList.add("btn-success");
            }
          });
        }

        escapeHtml(unsafe) {
          if (unsafe === null || unsafe === undefined) return "";
          return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        showEmptyQueueState() {
          const stats = [
            "waitingCount",
            "processingCount",
            "completedCount",
            "priorityCount",
          ];
          stats.forEach((stat) => {
            const element = document.getElementById(stat);
            if (element) element.textContent = "0";
          });
        }

        //  UPDATED: Handles assigning a new request to a specific window
        async startProcessingFromList(queueId, windowNumber) {
          if (
            !confirm(`Start serving this client and assign to ${windowNumber}?`)
          )
            return;

          // Optional Check: Is the *target* window already serving someone? (This logic is usually handled better server-side, but client-side is faster for UX)
          // If the current admin's window is the target window, let them decide if they want to override the current request.
          // For simplicity, we'll allow assigning, and the backend's sorting will determine who is truly "Now Serving".

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/start-processing",
              {
                method: "POST",
                body: JSON.stringify({
                  queueId: queueId,
                  windowNumber: windowNumber,
                }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification(`Processing started at ${windowNumber}!`);
              await this.loadQueues(); // Refresh all lists

              //  CRITICAL FIX: Explicitly check and update Now Serving if the target window is *this* admin's window.
              if (currentWindow === windowNumber) {
                this.renderNowServing();
              }
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            alert("Error starting processing. Please try again.");
          }
        }

        //  OPEN PROGRESS MODAL 
        //  OPEN PROGRESS MODAL (With Auto-Check Logic) 
        openProgressModal(queueId, totalDays, encodedChecked) {
          const checkedArr =
            encodedChecked && encodedChecked !== "undefined"
              ? JSON.parse(decodeURIComponent(encodedChecked))
              : [];

          document.getElementById("progressQueueId").value = queueId;
          document.getElementById(
            "progressDurationLabel"
          ).textContent = `${totalDays} Working Days`;

          const container = document.getElementById("progressCheckboxes");
          container.innerHTML = ""; // Clear previous

          for (let i = 1; i <= totalDays; i++) {
            const isChecked = checkedArr[i - 1] ? "checked" : "";
            container.innerHTML += `
                    <div class="form-check p-2 border rounded bg-white">
                        <input class="form-check-input ms-1 progress-checkbox" type="checkbox" id="dayCheck${i}" ${isChecked}>
                        <label class="form-check-label ms-2 fw-bold" for="dayCheck${i}">
                            Day ${i} Completed
                        </label>
                    </div>
                `;
          }

          // Update bar initially
          this.updateModalProgressBar(totalDays);

          //  ADD SMART LISTENERS 
          document.querySelectorAll(".progress-checkbox").forEach((box) => {
            box.addEventListener("change", (e) => {
              const currentId = e.target.id; // e.g., "dayCheck3"
              const currentNum = parseInt(currentId.replace("dayCheck", ""));
              const isChecked = e.target.checked;

              if (isChecked) {
                // RULE: If Day 3 is checked, Day 1 & 2 must be checked
                for (let i = 1; i < currentNum; i++) {
                  const prevBox = document.getElementById(`dayCheck${i}`);
                  if (prevBox && !prevBox.checked) {
                    prevBox.checked = true;
                  }
                }
              } else {
                // RULE: If Day 3 is unchecked, Day 4 & 5 must be unchecked
                for (let i = currentNum + 1; i <= totalDays; i++) {
                  const nextBox = document.getElementById(`dayCheck${i}`);
                  if (nextBox && nextBox.checked) {
                    nextBox.checked = false;
                  }
                }
              }

              // Update the visual bar after auto-checking/unchecking
              this.updateModalProgressBar(totalDays);
            });
          });

          toggleModal("progressModal");
        }

        updateModalProgressBar(totalDays) {
          const checkedCount = document.querySelectorAll(
            ".progress-checkbox:checked"
          ).length;
          const percent = Math.round((checkedCount / totalDays) * 100);
          const bar = document.getElementById("modalProgressBar");
          bar.style.width = `${percent}%`;
          bar.textContent = `${percent}%`;

          if (percent === 100) {
            bar.classList.remove("bg-primary");
            bar.classList.add("bg-success");
          } else {
            bar.classList.add("bg-primary");
            bar.classList.remove("bg-success");
          }
        }

        //  SAVE PROGRESS TO DB 
        async saveProgress() {
          const queueId = document.getElementById("progressQueueId").value;
          const checkboxes = document.querySelectorAll(".progress-checkbox");

          const checkedState = Array.from(checkboxes).map((cb) => cb.checked);
          const currentCount = checkedState.filter(Boolean).length;
          const totalCount = checkboxes.length;

          const progressData = {
            current: currentCount,
            total: totalCount,
            checked: checkedState,
          };

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/update-progress",
              {
                method: "POST",
                body: JSON.stringify({ queueId, progressData }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Progress updated!");
              toggleModal("progressModal");
              // Refresh the lists to show new progress bar state
              await this.loadQueues();
              if (serviceRequestManager)
                serviceRequestManager.loadServiceRequests();
            } else {
              alert("Error: " + result.message);
            }
          } catch (error) {
            console.error("Error saving progress:", error);
            alert("Failed to save progress.");
          }
        }

        //  UPDATED FUNCTION: Disables button immediately 
        async markAsClaimed(queueId, btnElement) {
          if (
            !confirm(
              "Has the student received their documents? This will remove the name from the TV screen."
            )
          )
            return;

          // 1. Disable button instantly to prevent double-clicks
          if (btnElement) {
            btnElement.disabled = true;
            btnElement.innerHTML =
              '<span class="spinner-border spinner-border-sm"></span> Saving...';
          }

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/mark-claimed",
              {
                method: "POST",
                body: JSON.stringify({ queueId }),
              }
            );

            const result = await response.json();
            if (result.success) {
              showNotification("Item claimed. Removed from screen.");

              // 2. Refresh lists (The item will vanish from the list here)
              await this.loadQueues();
              if (serviceRequestManager)
                serviceRequestManager.renderCompletedRequests();
            } else {
              alert("Error: " + result.message);
              // Re-enable if error
              if (btnElement) {
                btnElement.disabled = false;
                btnElement.innerHTML =
                  '<i class="bi bi-box-seam me-1"></i> Picked Up';
              }
            }
          } catch (error) {
            console.error("Error marking claimed:", error);
            // Re-enable if error
            if (btnElement) {
              btnElement.disabled = false;
              btnElement.innerHTML =
                '<i class="bi bi-box-seam me-1"></i> Picked Up';
            }
          }
        }

        //  EXECUTE API CALL 
        async confirmStartProcessing() {
          const queueId = document.getElementById("serveQueueId").value;

          // Disable button to prevent double clicks
          const btn = document.querySelector("#confirmServeModal .btn-primary");
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span> Processing...';
          btn.disabled = true;

          // --- OPTIMISTIC UI UPDATE ---
          // Remove card immediately from the "New Requests" list behind the modal
          const cardToRemove = document.getElementById(`req-${queueId}`);
          if (cardToRemove) cardToRemove.remove();

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/start-processing",
              {
                method: "POST",
                body: JSON.stringify({
                  queueId: queueId,
                  windowNumber: currentWindow,
                }),
              }
            );

            const result = await response.json();

            if (result.success) {
              showNotification(
                `Now Serving: ${
                  document.getElementById("serveQueueNumber").textContent
                }`
              );
              toggleModal("confirmServeModal");
              await this.loadQueues();
              this.renderNowServing();
            } else {
              alert("Error: " + result.message);
              // If error, reload queue to bring card back
              this.loadQueues();
            }
          } catch (error) {
            console.error("Error starting processing:", error);
            alert("Connection error. Please try again.");
            this.loadQueues();
          } finally {
            // Reset button
            btn.innerHTML = originalText;
            btn.disabled = false;
            // Close modal if still open
            const modal = document.getElementById("confirmServeModal");
            if (modal.classList.contains("active"))
              toggleModal("confirmServeModal");
          }
        }
        //  1. LOCK FUNCTION (Solves the Conflict)
        async lockAndReview(queueId) {
          if (!currentWindow) {
            alert("Please select a window first.");
            return;
          }

          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/lock-request",
              {
                method: "POST",
                body: JSON.stringify({ queueId, windowNumber: currentWindow }),
              }
            );
            const result = await response.json();

            if (result.success) {
              // Lock successful! Open the review modal
              this.openReviewModal(queueId);
              this.loadQueues(); // Refresh UI so others see it locked
            } else {
              // Failed (Race condition: someone else clicked it 0.1s ago)
              alert(result.message);
              this.loadQueues();
            }
          } catch (error) {
            console.error("Error locking request:", error);
          }
        }

        //  REVIEW MODAL (Fast Fetch + Multiple Services + Previewer) 
        async openReviewModal(queueId) {
          // 1. Show Loading State
          const fileContainer = document.getElementById("reviewFilesContainer");
          const serviceContainer = document.getElementById(
            "reviewServicesContainer"
          );

          // Safety check: ensure containers exist before trying to set innerHTML
          if (fileContainer)
            fileContainer.innerHTML = `<div class="text-center py-3"><div class="spinner-border text-primary spinner-border-sm"></div><small class="ms-2">Loading files...</small></div>`;
          if (serviceContainer)
            serviceContainer.innerHTML = `<div class="text-center py-2"><small class="text-muted">Loading services...</small></div>`;

          toggleModal("reviewRequestModal");

          try {
            // 2. Fetch Data (Fast Lane API)
            const response = await makeAuthenticatedRequest(
              `/api/admin/request-details-by-queue/${queueId}`
            );
            const result = await response.json();

            if (!result.success) {
              alert(result.message);
              toggleModal("reviewRequestModal");
              return;
            }

            const data = result.data; // { user_name, services, requirements_paths, ... }

            // 3. Populate Header Info
            document.getElementById("reviewQueueId").value = queueId;
            document.getElementById("reviewStudentName").textContent =
              data.user_name || "Unknown";
            document.getElementById("reviewStudentId").textContent =
              "ID: " + (data.student_id || "N/A");
            document.getElementById("reviewQueueNumber").textContent =
              data.queue_number;

            //  4. POPULATE SERVICES (Handles Multiple) 
            let services = data.services || [];
            try {
              if (typeof services === "string") services = JSON.parse(services);
            } catch (e) {
              services = [services];
            }

            if (serviceContainer) {
              if (!Array.isArray(services) || services.length === 0) {
                serviceContainer.innerHTML = `<span class="text-muted fst-italic">No services specified.</span>`;
              } else {
                serviceContainer.innerHTML = services
                  .map((service) => {
                    let displayService = service;
                    let note = "";
                    if (service.includes("[Note:")) {
                      const parts = service.split(" [Note:");
                      displayService = parts[0];
                      note = parts[1].replace("]", "");
                    }

                    return `
                    <div class="d-flex align-items-center bg-white border rounded px-3 py-2 shadow-sm">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        <div>
                            <div class="fw-bold text-dark">${displayService}</div>
                            ${
                              note
                                ? `<small class="text-muted"><i class="bi bi-pencil-fill" style="font-size:10px;"></i> ${note}</small>`
                                : ""
                            }
                        </div>
                    </div>`;
                  })
                  .join("");
              }
            }

            // ... inside openReviewModal(queueId) ...

            //  5. POPULATE FILES (SHOW IMAGES AS THUMBNAILS) 
            const files = data.requirements_paths || [];

            if (fileContainer) {
              if (files.length === 0) {
                fileContainer.innerHTML = `<div class="text-center text-muted py-3 small">No files attached to this request.</div>`;
              } else {
                fileContainer.innerHTML = files
                  .map((file) => {
                    // Prepare URL and Name
                    const fileUrl = file.file.startsWith("data:")
                      ? file.file
                      : "/uploads/" + file.file;
                    const fileName = file.name || "Document";

                    // Check if it is an image
                    const extension = file.file
                      .split(".")
                      .pop()
                      .toLowerCase()
                      .split("?")[0]; // Handle query params if any
                    const isImage =
                      ["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(
                        extension
                      ) || file.file.startsWith("data:image");

                    if (isImage) {
                      // === IT IS AN IMAGE: SHOW THUMBNAIL ===
                      return `
                <div class="d-inline-block me-2 mb-2 text-center align-top border rounded p-2 bg-light">
                    <div style="height: 120px; width: 120px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #e9ecef; cursor: pointer;"
                         onclick="document.getElementById('previewImageTarget').src='${fileUrl}'; new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();">
                        <img src="${fileUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="${fileName}">
                    </div>
                    <div class="mt-1 text-truncate small fw-bold" style="max-width: 120px;" title="${fileName}">${fileName}</div>
                    <div class="text-muted" style="font-size: 10px;">Click to expand</div>
                </div>`;
                    } else {
                      // === NOT AN IMAGE (PDF/DOC): SHOW LIST ROW ===
                      return `
                <div class="d-flex justify-content-between align-items-center bg-light p-2 mb-2 border rounded">
                    <div class="d-flex align-items-center overflow-hidden">
                        <i class="bi bi-file-earmark-text-fill fs-4 text-danger me-3"></i>
                        <div class="text-truncate" style="max-width: 280px;">
                            <strong class="d-block text-dark small">${fileName}</strong>
                            <span class="text-muted" style="font-size: 10px;">${extension.toUpperCase()} File</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary fw-bold" 
                        onclick="queueManager.showFilePreview('${fileUrl}', '${fileName}')">
                        <i class="bi bi-eye"></i> View
                    </button>
                </div>`;
                    }
                  })
                  .join("");
              }
            }
            //  INJECT VERIFICATION BADGE 
            // Check 'requirements_confirmed' (1 = true, 0 = false)
            // Note: Ensure your backend sends this property!
            const isVerified = data.requirements_confirmed === 1;

            const verificationHTML = isVerified
              ? `<div class="mt-3 p-2 bg-success bg-opacity-10 border border-success rounded d-flex align-items-center">
                     <i class="bi bi-check-circle-fill text-success me-3 fs-4"></i>
                     <div>
                       <div class="text-success fw-bold small">Verified by Student</div>
                       <div class="small text-secondary lh-sm">I certify that the attached requirements are correct and complete.</div>
                     </div>
                   </div>`
              : `<div class="mt-3 p-2 bg-light border rounded text-center text-muted small">
                     <i class="bi bi-exclamation-circle me-1"></i> Student verified requirements.
                   </div>`;

            // Append it to the file container
            if (fileContainer) {
              fileContainer.insertAdjacentHTML("beforeend", verificationHTML);
            }

            // 6. Reset UI States
            const reasonContainer = document.getElementById(
              "declineReasonContainer"
            );
            const actionBtns = document.getElementById("reviewActionButtons");
            const confirmBtns = document.getElementById(
              "declineConfirmButtons"
            );

            if (reasonContainer) reasonContainer.style.display = "none";
            if (actionBtns) actionBtns.style.display = "block";
            if (confirmBtns) confirmBtns.style.display = "none";
            document.getElementById("reviewDeclineReason").value = "";
          } catch (error) {
            console.error("Error opening modal:", error);
            if (fileContainer)
              fileContainer.innerHTML =
                '<p class="text-danger text-center">Connection Error.</p>';
          }
        }

        //  FIXED: Optimistic UI update (Removes card instantly) 
        async submitDecision(action) {
          const queueId = document.getElementById("reviewQueueId").value;
          const reason = document.getElementById("reviewDeclineReason").value;

          if (action === "decline" && !reason.trim()) {
            alert("Please provide a reason for rejection.");
            return;
          }

          if (
            confirm(
              action === "process"
                ? "Everything looks good? Proceed to serving?"
                : "Reject this request?"
            )
          ) {
            //  OPTIMISTIC UPDATE: Hide the card immediately to prevent confusion
            const card = document.getElementById(`req-${queueId}`);
            if (card) card.style.display = "none";

            // Close modal immediately
            toggleModal("reviewRequestModal");

            try {
              const response = await makeAuthenticatedRequest(
                "/api/admin/review-decision",
                {
                  method: "POST",
                  body: JSON.stringify({ queueId, action, reason }),
                }
              );
              const result = await response.json();

              if (result.success) {
                showNotification(
                  result.message,
                  action === "process" ? "success" : "warning"
                );
                this.loadQueues(); // Fetch fresh data to confirm
              } else {
                alert(result.message);
                // If error, show card again
                if (card) card.style.display = "block";
                this.loadQueues();
              }
            } catch (error) {
              console.error("Decision error:", error);
              // If error, show card again
              if (card) card.style.display = "block";
            }
          }
        }

        // Helper UI toggle
        toggleDeclineInput() {
          const reasonBox = document.getElementById("declineReasonContainer");
          const normalBtns = document.getElementById("reviewActionButtons");
          const confirmBtns = document.getElementById("declineConfirmButtons");

          if (reasonBox.style.display === "none") {
            reasonBox.style.display = "block";
            normalBtns.style.display = "none";
            confirmBtns.style.display = "block";
          } else {
            reasonBox.style.display = "none";
            normalBtns.style.display = "block";
            confirmBtns.style.display = "none";
          }
        }

        resumeReview(queueId) {
          this.openReviewModal(queueId);
        }
        //  NEW: PREVIEW FUNCTION (Handles Images & PDFs)
        showFilePreview(fileUrl, fileName) {
          const container = document.getElementById("previewContent");
          const title = document.getElementById("previewFileName");

          // Set Title
          title.textContent = fileName;
          container.innerHTML = ""; // Clear previous content

          // 1. Get File Extension
          const extension = fileName.split(".").pop().toLowerCase();

          // 2. Decide how to show it
          if (["jpg", "jpeg", "png", "gif", "webp"].includes(extension)) {
            // IMAGE: Show in an img tag
            container.innerHTML = `
            <img src="${fileUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Preview">
        `;
            toggleModal("filePreviewModal");
          } else if (extension === "pdf") {
            // PDF: Show in an iframe
            container.innerHTML = `
            <iframe src="${fileUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
        `;
            toggleModal("filePreviewModal");
          } else {
            // WORD/EXCEL: Cannot be previewed in browser easily without 3rd party tools
            // Fallback to downloading
            if (
              confirm(
                `Preview not available for .${extension} files. Download instead?`
              )
            ) {
              const link = document.createElement("a");
              link.href = fileUrl;
              link.download = fileName;
              link.click();
            }
          }
        }
      }

      // Manual Queue Entry Function
      async function addManualQueue() {
        const name = document.getElementById("manualName").value;
        const studentId = document.getElementById("manualStudentId").value;
        const service = document.getElementById("manualService").value;
        const isPriority =
          document.getElementById("manualPriority").value === "true";

        if (!name) {
          alert("Please enter a name");
          return;
        }

        // Show additional details modal
        document.getElementById("manualNameDisplay").textContent = name;
        document.getElementById("manualStudentIdDisplay").textContent =
          studentId || "N/A";
        document.getElementById("manualServiceDisplay").textContent = service;
        document.getElementById("manualPriorityDisplay").textContent =
          isPriority ? "Yes" : "No";

        toggleModal("manualTransactionModal");
      }

      async function confirmManualQueue() {
        const name = document.getElementById("manualName").value;
        const studentId = document.getElementById("manualStudentId").value;
        const service = document.getElementById("manualService").value;
        const isPriority =
          document.getElementById("manualPriority").value === "true";
        const transactionType =
          document.getElementById("transactionType").value;
        const notes = document.getElementById("transactionNotes").value;

        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/add-manual-queue",
            {
              method: "POST",
              body: JSON.stringify({
                name,
                studentId,
                service,
                isPriority,
                transactionType,
                notes,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            showNotification(`Manual queue entry added: ${result.queueNumber}`);
            toggleModal("manualTransactionModal");

            // Clear form
            document.getElementById("manualName").value = "";
            document.getElementById("manualStudentId").value = "";
            document.getElementById("transactionNotes").value = "";

            // Refresh queues
            queueManager.loadQueues();
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error("Error adding manual queue:", error);
          alert("Error adding to queue. Please try again.");
        }
      }

      // Enhanced auto-refresh with error handling
      function setupEnhancedAutoRefresh() {
        //  FIX: Change 5000 (5s) to 1500 (1.5s) 
        // This makes the request disappear from other windows almost instantly.
        setInterval(() => {
          if (!isQueuePaused) {
            queueManager.loadQueues();
          }
        }, 1500);

        // Refresh service requests every 15 seconds (was 30s)
        setInterval(() => {
          serviceRequestManager.loadServiceRequests();
        }, 15000);
      }
      /**
       * Populates the 'Queue Report History' list on the Reports page.
       * For now, it just checks for today's completed requests.
       */
      //  FIXED: Always shows clickable history button 
      function renderReportHistory(queues) {
        const container = document.getElementById(
          "queueReportHistoryContainer"
        );
        if (!container) return;

        // Get count for today (just for display)
        const completedRequests = queues.completed || [];
        const count = completedRequests.length;

        // Get today's date string
        const today = new Date();
        const dateStr = today.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        // Render clickable card ALWAYS
        container.innerHTML = `
      <h2 class="history-title">Queue Report History</h2>
      <div class="history-item" onclick="showReportDetail('history')" style="cursor: pointer; transition: background 0.2s;">
        <div class="d-flex justify-content-between align-items-center w-100">
            <div>
                <span class="history-day text-primary fw-bold"><i class="bi bi-archive-fill me-2"></i>View Full History</span>
                <span class="history-date text-muted">${dateStr}</span>
            </div>
            <div class="text-end">
                <span class="badge ${
                  count > 0 ? "bg-success" : "bg-secondary"
                } rounded-pill mb-1">${count} Today</span>
                <div class="small text-muted"><i class="bi bi-chevron-right"></i></div>
            </div>
        </div>
      </div>
  `;
      }

      /**
       * Populates the Report Detail page with data from 'today'
       * Includes both 'Completed' (Ready to Claim) and 'Claimed' (Picked Up) requests.
       */
      function populateTodayReportDetail() {
        //  FIX: Combine 'completed' and 'claimed' arrays to see FULL history
        const completedRequests = [
          ...(queueManager.queues.completed || []),
          ...(queueManager.queues.claimed || []),
        ];

        // --- 1. Set Date and Total ---
        const today = new Date();
        const day = today.toLocaleDateString("en-US", { weekday: "long" });
        const date = today.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const dateEl = document.getElementById("reportDetailDate");
        const totalEl = document.getElementById("reportDetailTotal");

        if (dateEl) dateEl.innerHTML = `Today: ${day} <br/> ${date}`;
        if (totalEl) totalEl.textContent = completedRequests.length;

        // --- 2. Group services and create summary ---
        const serviceSummary = new Map();
        const requestsByService = new Map();

        // Utility to prevent XSS (HTML injection)
        const escape = (str) => {
          if (str === null || str === undefined) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        };

        completedRequests.forEach((req) => {
          let services = [];
          try {
            if (
              typeof req.services === "string" &&
              req.services.startsWith("[")
            ) {
              services = JSON.parse(req.services);
            } else if (Array.isArray(req.services)) {
              services = req.services;
            } else if (req.services) {
              services = [String(req.services)]; // Handle as single string
            }
          } catch (e) {
            console.warn("Could not parse services:", req.services);
          }

          if (services.length === 0) {
            services = ["Other"]; // Fallback
          }

          services.forEach((serviceName) => {
            const cleanServiceName = escape(serviceName);

            // Add to summary count
            serviceSummary.set(
              cleanServiceName,
              (serviceSummary.get(cleanServiceName) || 0) + 1
            );

            // Add request to service group for the table
            if (!requestsByService.has(cleanServiceName)) {
              requestsByService.set(cleanServiceName, []);
            }
            requestsByService.get(cleanServiceName).push(req);
          });
        });

        // --- 3. Populate Service Grid (Top Section) ---
        const gridContainer = document.getElementById(
          "reportDetailServiceGrid"
        );
        let gridHtml = "<div>"; // Start first column
        let count = 0;

        serviceSummary.forEach((qty, serviceName) => {
          gridHtml += `
                <div class="service-item">
                  <span class="service-name">${serviceName}:</span>
                  <span class="service-count">${qty}</span>
                </div>
              `;
          count++;
          // Split into two columns for layout balance
          if (count % 5 === 0 && count < serviceSummary.size) {
            gridHtml += "</div><div>";
          }
        });
        gridHtml += "</div>";

        if (gridContainer) {
          gridContainer.innerHTML =
            serviceSummary.size > 0
              ? gridHtml
              : '<div style="color: #999; font-size: 14px;">No services recorded today.</div>';
        }

        // --- 4. Populate Data Table (Bottom Section) ---
        const tableContainer = document.getElementById("reportDetailDataTable");
        let tableHtml = "";

        requestsByService.forEach((requests, serviceName) => {
          tableHtml += `
                <div class="table-section">
                  <div class="table-header-title">${serviceName}</div>
                  <div class="table-row header-row">
                    <div class="table-cell header">Name</div>
                    <div class="table-cell header">Year/Course</div>
                    <div class="table-cell header">Student ID</div>
                    <div class="table-cell header">Status</div>
                  </div>
              `;

          requests.forEach((req) => {
            // Show if it was picked up or just ready
            const statusBadge =
              req.status === "claimed"
                ? '<span class="badge bg-secondary">Picked Up</span>'
                : '<span class="badge bg-success">Ready</span>';

            tableHtml += `
                  <div class="table-row">
                    <div class="table-cell">${escape(req.user_name)}</div>
                    <div class="table-cell">${escape(
                      req.course || "N/A"
                    )} - ${escape(req.year_level || "N/A")}</div>
                    <div class="table-cell">${escape(
                      req.student_id || "N/A"
                    )}</div>
                    <div class="table-cell">${statusBadge}</div>
                  </div>
                `;
          });

          tableHtml += "</div>"; // End table-section
        });

        if (tableContainer) {
          tableContainer.innerHTML =
            requestsByService.size > 0
              ? tableHtml
              : `
                <div style="text-align: center; color: #999; padding: 30px 0;">
                  No details found.
                </div>
              `;
        }
      }

      //  Theme toggle (only on Settings page) 
      document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const darkSwitch = document.getElementById("darkModeSwitch");

        // Load saved preference
        if (localStorage.getItem("theme") === "dark") {
          body.classList.add("dark-theme");
          if (darkSwitch) darkSwitch.checked = true;
        }

        // Toggle handler
        if (darkSwitch) {
          darkSwitch.addEventListener("change", () => {
            if (darkSwitch.checked) {
              body.classList.add("dark-theme");
              localStorage.setItem("theme", "dark");
            } else {
              body.classList.remove("dark-theme");
              localStorage.setItem("theme", "light");
            }
          });
        }
      });
      // Apply dark-theme only once  no inline !important overrides
      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark-theme");
          const sw = document.getElementById("darkModeSwitch");
          if (sw) sw.checked = true;
        }
      });
      // ==========================================
      // WINDOW ASSIGNMENT LOGIC (PERSISTENCE)
      // ==========================================
      let activeWindows = []; // Cache of windows currently in use

      async function checkWindowAssignment() {
        const currentWindowDisplay = document.getElementById(
          "currentWindowDisplay"
        );
        let savedWindow = localStorage.getItem("assignedWindow");

        //  1. SUPER ADMIN BYPASS 
        if (
          (currentStaff && currentStaff.role === "super_admin") ||
          savedWindow === "Supervisor"
        ) {
          console.log("Super Admin: Skipping window selection modal.");
          //  FIX: Use the correct variable name 'currentWindowDisplay'
          if (currentWindowDisplay)
            currentWindowDisplay.textContent = "Supervisor";
          return;
        }

        //  2. AUTO RE-LOCK (Handles Refresh Logic) 
        // If we have a saved window, we must tell the server "I'm still here!"
        // because the 'pagehide' event might have just unlocked it during the refresh.
        if (savedWindow && savedWindow !== "Supervisor") {
          currentWindow = savedWindow;

          // SILENTLY RE-ASSIGN ON SERVER
          makeAuthenticatedRequest("/api/admin/assign-window", {
            method: "POST",
            body: JSON.stringify({ windowNumber: savedWindow }),
          }).catch((err) => console.warn("Background re-lock failed", err));

          // Update UI
          updateUIWithWindow(currentWindow);
          if (queueManager) queueManager.loadQueues();
          return; // Stop here, don't show modal
        }

        if (currentWindowDisplay) currentWindowDisplay.textContent = "N/A";

        // 3. Fetch active windows and show modal (Normal Login Flow)
        try {
          const response = await makeAuthenticatedRequest(
            "/api/admin/active-windows"
          );
          const data = await response.json();
          if (data.success) {
            activeWindows = data.activeWindows;
          }
        } catch (error) {
          console.error("Failed to fetch active windows:", error);
        }

        // Show the modal
        const modalElement = document.getElementById("windowSelectionModal");
        if (modalElement) {
          renderWindowButtons(modalElement);
          windowSelectionModalObj = new bootstrap.Modal(modalElement, {
            backdrop: "static",
            keyboard: false,
          });
          windowSelectionModalObj.show();
        }
      }

      // The rest of your assignment functions (renderWindowButtons and selectWindow)
      // are still required and remain unchanged from the previous steps.

      function renderWindowButtons(modalElement) {
        const windows = ["Window 1", "Window 2", "Window 3", "Window 4"];
        const modalBody = modalElement.querySelector(".modal-body .d-grid");

        if (!modalBody) return;
        modalBody.innerHTML = "";

        windows.forEach((windowName) => {
          const isLocked = activeWindows.includes(windowName);
          const isDisabled = isLocked ? "disabled" : "";
          const lockIcon = isLocked
            ? '<i class="bi bi-lock-fill ms-auto text-danger"></i>'
            : "";

          //  FIX 2: Pass 'event' to the function call 
          modalBody.innerHTML += `
                      <button
                          type="button"
                          class="btn btn-outline-primary p-3 text-start fw-semibold position-relative"
                          onclick="${
                            isLocked
                              ? ""
                              : `selectWindow('${windowName}', event)`
                          }"
                          ${isDisabled}
                      >
                          <i class="bi bi-display me-3 fs-5"></i> ${windowName}
                          ${lockIcon}
                      </button>
                  `;
        });
      }

      window.selectWindow = async function (windowName, event) {
        // 1. Stop the default immediate form refresh (we need to save data first!)
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        try {
          // 2. Lock the window on the server
          const response = await makeAuthenticatedRequest(
            "/api/admin/assign-window",
            {
              method: "POST",
              body: JSON.stringify({ windowNumber: windowName }),
            }
          );
          const data = await response.json();

          if (!data.success) {
            alert(`Assignment failed: ${data.message}. Refreshing list.`);
            checkWindowAssignment();
            return;
          }

          // 3. Save state to Local Storage
          localStorage.setItem("assignedWindow", windowName);
          currentWindow = windowName;

          // 4.  SHOW LOADING SCREEN IN MODAL 
          const modalBody = document.querySelector(
            "#windowSelectionModal .modal-body"
          );
          if (modalBody) {
            modalBody.innerHTML = `
                      <div class="text-center py-5">
                          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                              <span class="visually-hidden">Loading...</span>
                          </div>
                          <h4 class="fw-bold text-dark">Setting up ${windowName}...</h4>
                          <p class="text-muted">The page will reload to apply settings.</p>
                      </div>
                    `;
          }

          // 5.  FORCE RELOAD AFTER 1 SECOND 
          // This guarantees the dashboard loads fresh with the buttons visible.
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch (error) {
          console.error("Error assigning window:", error);
          alert("Network error. Please try again.");
        }
      };

      function updateUIWithWindow(windowName) {
        const currentWindowDisplay = document.getElementById(
          "currentWindowDisplay"
        );
        if (currentWindowDisplay) currentWindowDisplay.textContent = windowName;

        const sidebarTitle = document.querySelector(".sidebar-title");
        if (sidebarTitle) {
          // Simple update for sidebar title
          sidebarTitle.innerHTML = `Registrar Staff <br><small style="font-size: 12px; color: #aab0bc;">${windowName}</small>`;
        }
      }

      // Hook into existing initialization
      document.addEventListener("DOMContentLoaded", function () {
        // checkWindowAssignment();
      });

      // Correct Logout Function
      window.handleLogout = function () {
        if (confirm("Are you sure you want to log out?")) {
          showNotification("Logging out...");

          // 1. Ensure we have the window value to send to server
          if (!currentWindow) {
            currentWindow = localStorage.getItem("assignedWindow");
          }

          // 2. Call server to UNLOCK the window in the database
          unassignWindowOnServer()
            .then(() => {
              // 3. Clear local storage and redirect
              localStorage.removeItem("assignedWindow");
              adminLogout();
            })
            .catch((err) => {
              // Even if server fails, log out anyway
              console.error("Unassign failed", err);
              localStorage.removeItem("assignedWindow");
              adminLogout();
            });
        }
      };

      // Function to toggle password visibility
      function toggleRegPassword(inputId, iconSpan) {
        const input = document.getElementById(inputId);
        const icon = iconSpan.querySelector("i");

        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      }
      //  ROBUST TAB CLOSE HANDLER 
      // Uses sendBeacon with a Blob to bypass header restrictions
      window.addEventListener("pagehide", function () {
        if (adminToken) {
          const payload = JSON.stringify({ token: adminToken });
          const blob = new Blob([payload], { type: "application/json" });

          // Send signal to the new specific endpoint
          navigator.sendBeacon("/api/admin/beacon-unlock", blob);
        }
      });
      //  NEW: History Manager Class (Hierarchical Reporting) 
      class HistoryManager {
        constructor() {
          this.rawData = [];
          this.currentView = "months"; // months, weeks, days, details
          this.selectedMonth = null;
          this.selectedWeek = null;
          this.selectedDay = null;
        }

        async loadHistory() {
          try {
            const response = await makeAuthenticatedRequest(
              "/api/admin/history"
            );
            const result = await response.json();
            if (result.success) {
              this.rawData = result.history;
              this.renderMonths();
            }
          } catch (error) {
            console.error("Failed to load history:", error);
            document.getElementById(
              "historyContentArea"
            ).innerHTML = `<p class="text-danger text-center">Failed to load history data.</p>`;
          }
        }

        // --- LEVEL 1: MONTHS ---
        renderMonths() {
          this.currentView = "months";
          this.updateBreadcrumbs();

          // Group by "Month Year" (e.g., "December 2025")
          const groups = {};
          this.rawData.forEach((item) => {
            const date = new Date(item.completed_at);
            const key = date.toLocaleString("default", {
              month: "long",
              year: "numeric",
            });
            if (!groups[key]) groups[key] = 0;
            groups[key]++;
          });

          let html = '<div class="row g-3">';
          if (Object.keys(groups).length === 0) {
            html +=
              '<div class="col-12 text-center text-muted">No history available yet.</div>';
          } else {
            Object.entries(groups).forEach(([month, count]) => {
              html += `
                <div class="col-md-4 col-lg-3">
                    <div class="card h-100 border-0 shadow-sm report-card" 
                         onclick="historyManager.selectMonth('${month}')"
                         style="cursor: pointer; transition: transform 0.2s;">
                        <div class="card-body text-center">
                            <i class="bi bi-calendar-month fs-1 text-primary mb-2"></i>
                            <h5 class="fw-bold mb-1">${month}</h5>
                            <span class="badge bg-light text-dark border">${count} Requests</span>
                        </div>
                    </div>
                </div>`;
            });
          }
          html += "</div>";
          document.getElementById("historyContentArea").innerHTML = html;
        }

        selectMonth(month) {
          this.selectedMonth = month;
          this.renderWeeks();
        }

        // --- LEVEL 2: WEEKS ---
        renderWeeks() {
          this.currentView = "weeks";
          this.updateBreadcrumbs();

          // Filter data for selected month
          const monthlyData = this.rawData.filter((item) => {
            const date = new Date(item.completed_at);
            return (
              date.toLocaleString("default", {
                month: "long",
                year: "numeric",
              }) === this.selectedMonth
            );
          });

          // Group by Week Number
          const groups = {};
          monthlyData.forEach((item) => {
            const date = new Date(item.completed_at);
            // Get week number of the month (approximate)
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const weekNum = Math.ceil(
              ((date - firstDay) / 86400000 + firstDay.getDay() + 1) / 7
            );
            const key = `Week ${weekNum}`;

            if (!groups[key])
              groups[key] = { count: 0, startDate: date, endDate: date };

            groups[key].count++;
            // Update range logic could go here for precision
          });

          let html = '<div class="row g-3">';
          Object.entries(groups)
            .sort()
            .forEach(([week, data]) => {
              html += `
            <div class="col-md-4 col-lg-3">
                <div class="card h-100 border-0 shadow-sm report-card" 
                     onclick="historyManager.selectWeek('${week}')"
                     style="cursor: pointer;">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar-week fs-1 text-success mb-2"></i>
                        <h5 class="fw-bold mb-1">${week}</h5>
                        <p class="text-muted small mb-2">of ${this.selectedMonth}</p>
                        <span class="badge bg-success">${data.count} Requests</span>
                    </div>
                </div>
            </div>`;
            });
          html += "</div>";
          document.getElementById("historyContentArea").innerHTML = html;
        }

        selectWeek(week) {
          this.selectedWeek = week;
          this.renderDays();
        }

        // --- LEVEL 3: DAYS ---
        renderDays() {
          this.currentView = "days";
          this.updateBreadcrumbs();

          // Filter: Match Month AND Week logic (re-calculate week to match)
          const dailyData = this.rawData.filter((item) => {
            const date = new Date(item.completed_at);
            const monthStr = date.toLocaleString("default", {
              month: "long",
              year: "numeric",
            });

            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const weekNum = Math.ceil(
              ((date - firstDay) / 86400000 + firstDay.getDay() + 1) / 7
            );
            const weekStr = `Week ${weekNum}`;

            return (
              monthStr === this.selectedMonth && weekStr === this.selectedWeek
            );
          });

          // Group by exact date (YYYY-MM-DD)
          const groups = {};
          dailyData.forEach((item) => {
            const date = new Date(item.completed_at).toLocaleDateString(
              "en-US",
              {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              }
            );
            if (!groups[date]) groups[date] = [];
            groups[date].push(item);
          });

          let html = '<div class="list-group shadow-sm">';
          Object.entries(groups)
            .sort((a, b) => new Date(b[0]) - new Date(a[0]))
            .forEach(([date, items]) => {
              html += `
            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3"
                    onclick="historyManager.selectDay('${date}', ${items.length})">
                <div class="d-flex align-items-center">
                    <div class="bg-light rounded p-2 me-3"><i class="bi bi-calendar-day fs-4 text-warning"></i></div>
                    <div>
                        <h6 class="fw-bold mb-0">${date}</h6>
                        <small class="text-muted">Click to view details</small>
                    </div>
                </div>
                <span class="badge bg-primary rounded-pill">${items.length} Items</span>
            </button>`;
            });
          html += "</div>";
          document.getElementById("historyContentArea").innerHTML = html;
        }

        selectDay(dateStr) {
          this.selectedDay = dateStr;
          this.renderDetails();
        }

        //  UPDATED: DETAILS TABLE (Shows Staff instead of Payment) 
        renderDetails() {
          this.currentView = "details";
          this.updateBreadcrumbs();

          // Filter for the selected day
          const details = this.rawData.filter((item) => {
            const date = new Date(item.completed_at).toLocaleDateString(
              "en-US",
              {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              }
            );
            return date === this.selectedDay;
          });

          let html = `
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-danger" onclick="historyManager.printReport()">
            <i class="bi bi-file-earmark-pdf me-2"></i> Print / Save as PDF
        </button>
    </div>
    <div class="table-responsive bg-white border rounded" id="printableArea">
        <div class="d-none d-print-block text-center mb-4 pt-4">
            <h3>Registrar Office - Daily Report</h3>
            <p>${this.selectedDay}</p>
            <hr>
        </div>

        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-3">Client Name</th>
                    <th>Student ID</th>
                    <th>Dept / Course</th>
                    <th>Service Requested</th>
                    <th>Staff In Charge</th> <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;

          if (details.length === 0) {
            html += `<tr><td colspan="6" class="text-center py-4 text-muted">No records found.</td></tr>`;
          } else {
            // Inside renderDetails() ...
            details.forEach((row) => {
              const statusBadge =
                row.status === "claimed"
                  ? '<span class="badge bg-secondary">Picked Up</span>'
                  : '<span class="badge bg-success">Ready</span>';

              const staffName =
                row.completed_by || row.processed_by || "Registrar Staff";

              //  NEW CODE: CLEAN THE NOTES 
              const cleanServices = row.services
                .map((s) => {
                  if (typeof s === "string" && s.includes(" [Note:")) {
                    return s.split(" [Note:")[0];
                  }
                  return s;
                })
                .join(", ");

              html += `
    <tr>
        <td class="ps-3 fw-bold">${row.client_name || "Unknown"}</td>
        <td>${row.student_id || "N/A"}</td>
        <td>
            <div class="small fw-bold">${row.department || "N/A"}</div>
            <div class="small text-muted">${row.course || ""} ${
                row.major ? `(${row.major})` : ""
              }</div>
        </td>
        
        <td>${cleanServices}</td>
        
        <td>
            <div class="d-flex align-items-center">
                <i class="bi bi-person-circle text-secondary me-2"></i>
                <span class="fw-medium">${staffName}</span>
            </div>
        </td>

        <td>${statusBadge}</td>
    </tr>`;
            });
          }

          html += `
        </tbody>
        </table>
        
        <div class="d-none d-print-block mt-5 pt-5 px-4">
            <div class="row">
                <div class="col-6">
                    <p class="mb-4">Prepared by:</p>
                    <div class="border-bottom border-dark w-75 mb-2"></div>
                    <p class="small text-muted">Registrar Staff</p>
                </div>
                <div class="col-6">
                    <p class="mb-4">Noted by:</p>
                    <div class="border-bottom border-dark w-75 mb-2"></div>
                    <p class="small text-muted">University Registrar</p>
                </div>
            </div>
        </div>
    </div>`;

          document.getElementById("historyContentArea").innerHTML = html;
        }

        updateBreadcrumbs() {
          const container = document.getElementById("historyBreadcrumbs");
          let html = `<span class="breadcrumb-item"><a href="#" onclick="historyManager.renderMonths()">History</a></span>`;

          if (
            this.currentView === "weeks" ||
            this.currentView === "days" ||
            this.currentView === "details"
          ) {
            html += ` <i class="bi bi-chevron-right mx-1"></i> <span class="breadcrumb-item"><a href="#" onclick="historyManager.renderWeeks()">${this.selectedMonth}</a></span>`;
          }
          if (this.currentView === "days" || this.currentView === "details") {
            html += ` <i class="bi bi-chevron-right mx-1"></i> <span class="breadcrumb-item"><a href="#" onclick="historyManager.renderDays()">${this.selectedWeek}</a></span>`;
          }
          if (this.currentView === "details") {
            html += ` <i class="bi bi-chevron-right mx-1"></i> <span class="fw-bold text-dark">Details</span>`;
          }
          container.innerHTML = html;
        }

        //  REPLACEMENT FUNCTION for HistoryManager class 

        printReport() {
          // 1. Get the content you want to print
          const printContent =
            document.getElementById("printableArea").innerHTML;

          // 2. Create a hidden iframe
          const iframe = document.createElement("iframe");
          iframe.style.position = "absolute";
          iframe.style.width = "0px";
          iframe.style.height = "0px";
          iframe.style.border = "none";
          document.body.appendChild(iframe);

          // 3. Write content into the iframe (Include Bootstrap & Fonts for styling)
          const doc = iframe.contentWindow.document;
          doc.write(`
        <html>
        <head>
            <title>Registrar Report</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
            <style>
                body { 
                    padding: 40px; 
                    font-family: 'Poppins', sans-serif; 
                    color: #333;
                }
                /* Ensure the hidden print header shows up here */
                .d-none.d-print-block { display: block !important; }
                
                /* Table Tweaks for PDF */
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #f8f9fa !important; border-bottom: 2px solid #dee2e6; padding: 10px; }
                td { border-bottom: 1px solid #dee2e6; padding: 10px; vertical-align: middle; }
                
                /* Badges in print */
                .badge { border: 1px solid #ccc; color: #000; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; }
            </style>
        </head>
        <body>
            ${printContent}
        </body>
        </html>
    `);
          doc.close();

          // 4. Wait for styles to load, then Print
          iframe.contentWindow.focus();
          // Small delay ensures Bootstrap CSS is fully loaded before the dialog opens
          setTimeout(() => {
            iframe.contentWindow.print();
            // 5. Cleanup (Remove iframe after printing/canceling)
            document.body.removeChild(iframe);
          }, 500);
        }
      }

      const historyManager = new HistoryManager();
    </script>
  </body>
</html>
